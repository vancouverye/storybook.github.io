<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ì—°í˜¸ì˜ ìŠ¤í† ë¦¬ë¶ â€” Premium (Series Edit)</title>
<style>
:root{
  --bg:#0b0f17; --bg2:#0e1421;
  --card:#0f1726cc; --card-solid:#101a2b;
  --ink:#eaf1fb; --mut:#9fb0c3;
  --line:#1c2a40;
  --pri:#6ea3ff; --pri-2:#4f7ef3; --pri-3:#325de0;
  --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
  --r:16px; --shadow:0 18px 40px rgba(0,0,0,.45)
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Noto Sans KR,sans-serif; letter-spacing:.1px;
  background:
    radial-gradient(70% 100% at 10% 0%, #14203a 0, transparent 55%),
    radial-gradient(80% 100% at 100% 0%, #132036 0, transparent 50%),
    linear-gradient(180deg, #0b0f17 0, #0c1320 30%, #0b0f17 100%);
}
a{color:inherit;text-decoration:none}
hr{border:none;border-top:1px solid var(--line);margin:16px 0}

.app{display:grid;grid-template-rows:64px 1fr;min-height:100vh}
.header{position:sticky;top:0;z-index:50;display:flex;align-items:center;gap:12px;padding:10px 16px;
  background:#0c141fbf; border-bottom:1px solid var(--line); backdrop-filter:blur(10px)}
.brand{font-weight:900;font-size:18px;letter-spacing:.2px}
.badge{border:1px solid var(--line);border-radius:999px;padding:3px 10px;color:var(--mut);font-size:12px;margin-left:8px}
.header-nav{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
.btn{background:#0f1a33;border:1px solid var(--line);color:var(--ink);padding:9px 14px;border-radius:12px;cursor:pointer;transition:all .15s}
.btn:hover{border-color:#2b3a52}
.btn.pri{background:var(--pri);border-color:var(--pri);color:#fff}
.btn.pri:hover{background:var(--pri-2)}

.main{padding:20px}
.container{max-width:1200px;margin:0 auto;display:grid;gap:16px}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:16px}
.card.solid{background:var(--card-solid)}
.grid{display:grid;gap:16px}
.grid.cols-2{grid-template-columns:repeat(2,1fr)}
.grid.cols-3{grid-template-columns:repeat(3,1fr)}
@media(max-width:980px){.grid.cols-2,.grid.cols-3{grid-template-columns:1fr}}

.section{display:none}.section.show{display:block}
.empty{color:var(--mut)}
.title{margin:.2em 0 .6em}

.tabs{display:flex;gap:10px;overflow:auto;padding:8px 2px;scroll-snap-type:x mandatory}
.tab{scroll-snap-align:start;border:1px solid var(--line);background:#0c1628;color:var(--ink);
  padding:9px 14px;border-radius:999px;cursor:pointer;white-space:nowrap;transition:all .12s}
.tab:hover{border-color:#2b3a52}
.tab.active{border-color:var(--pri);box-shadow:0 0 0 2px color-mix(in srgb,var(--pri),transparent 70%) inset}

.story{background:#0f1a2e;border:1px solid var(--line);border-radius:18px;padding:16px;display:grid;gap:10px;position:relative;overflow:hidden}
.story h4{margin:0}
.story p{margin:0;color:var(--mut)}
.meta{color:var(--mut);font-size:12px}
.story .actions{display:flex;gap:8px;flex-wrap:wrap}
.story::after{content:"";position:absolute;inset:auto -40px -40px auto;width:160px;height:160px;border-radius:50%;
background:radial-gradient(closest-side, #2a3f66 0, transparent 65%);opacity:.18;pointer-events:none}

.modal{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:100}
.modal.on{display:flex}
.modal .box{width:min(760px,92vw);background:var(--card-solid);border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow);padding:16px}
.modal .box h3{margin:.2em 0 .6em}
.modal .close{margin-left:auto}

.toast{position:fixed;right:16px;bottom:16px;background:#0b1322e6;border:1px solid var(--line);padding:10px 14px;border-radius:12px;display:none}
.spinner{width:42px;height:42px;border:3px solid #1a2840;border-top-color:var(--pri);border-radius:50%;animation:spin 1s linear infinite;margin:20px auto}
@keyframes spin{to{transform:rotate(360deg)}}

input,textarea,select{width:100%;background:#0b1422;border:1px solid var(--line);color:var(--ink);padding:11px;border-radius:12px}
textarea{resize:vertical}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.small{max-width:280px}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="brand">ğŸ“š ì—°í˜¸ì˜ ìŠ¤í† ë¦¬ë¶</div>
    <span class="badge" id="role">ì½ê¸° ì „ìš©</span>
    <div class="header-nav">
      <button class="btn" data-page="home">í™ˆ</button>
      <button class="btn" data-page="stories">ìŠ¤í† ë¦¬ë¶</button>
      <button class="btn" data-page="groups">ê·¸ë£¹</button>
      <button class="btn" data-page="next">ë‹¤ìŒ ì´ì•¼ê¸°</button>
      <button class="btn pri" data-page="admin">ê´€ë¦¬ì</button>
    </div>
  </div>

  <div class="main">
    <div class="container">

      <!-- HOME -->
      <section id="home" class="section show">
        <div class="card">
          <h2 class="title">í™˜ì˜í•©ë‹ˆë‹¤! ğŸ‘‹</h2>
          <p>ì‹œë¦¬ì¦ˆ íƒ­ìœ¼ë¡œ ì±…ì„ ê³ ë¥´ê³ , ê·¸ë£¹ì—ì„œ ì†Œí†µí•˜ê³ , â€œë‹¤ìŒ ì´ì•¼ê¸°â€ë¥¼ ì œì•ˆí•´ ë³´ì„¸ìš”.</p>
          <div class="row" style="margin:10px 0">
            <button class="btn pri" data-page="stories">ìŠ¤í† ë¦¬ë¶ ë³´ëŸ¬ê°€ê¸°</button>
            <button class="btn" data-page="groups">ê·¸ë£¹ìœ¼ë¡œ ê°€ê¸°</button>
            <button class="btn" data-page="next">ë‹¤ìŒ ì´ì•¼ê¸° ì œì•ˆ</button>
          </div>
        </div>
        <div class="card">
          <h3>ìµœê·¼ ì±…</h3>
          <div id="home-stories" class="grid cols-3"></div>
        </div>
      </section>

      <!-- STORIES -->
      <section id="stories" class="section">
        <div class="card solid">
          <h2 class="title">ìŠ¤í† ë¦¬ë¶</h2>
          <div id="series-tabs" class="tabs" style="margin-top:8px"></div>
          <div id="series-desc" class="empty" style="margin:8px 2px 12px"></div>
        </div>
        <div id="story-list" class="grid cols-2"></div>
        <div id="story-loading" class="spinner" style="display:none"></div>
      </section>

      <!-- GROUPS -->
      <section id="groups" class="section">
        <div class="card solid">
          <div class="row" style="justify-content:space-between">
            <h2 class="title">ê·¸ë£¹</h2><span class="empty">ê´€ë¦¬ìê°€ ë§Œë“  ê·¸ë£¹ì—ì„œ ëˆ„êµ¬ë‚˜ ê¸€ ì‘ì„±</span>
          </div>
        </div>
        <div id="group-list" class="grid cols-2"></div>
        <div id="group-box" class="card" style="display:none">
          <div class="row" style="justify-content:space-between">
            <h3 id="group-title">ê·¸ë£¹</h3>
            <span class="empty" id="group-desc"></span>
          </div>
          <form id="group-post-form" class="row">
            <input id="gp-name" class="small" placeholder="ë‹‰ë„¤ì„" required>
            <button class="btn pri" type="submit">ê¸€ ì˜¬ë¦¬ê¸°</button>
          </form>
          <textarea id="gp-text" rows="4" placeholder="ë‚´ìš© ì…ë ¥" required></textarea>
          <h4 style="margin-top:10px">ìµœê·¼ ê¸€</h4>
          <div id="group-posts" class="grid"></div>
        </div>
      </section>

      <!-- NEXT -->
      <section id="next" class="section">
        <div class="card solid">
          <h2 class="title">ë‹¤ìŒ ì´ì•¼ê¸°ëŠ” ë¬´ì—‡ì¼ê¹Œ? âœ¨</h2>
          <form id="suggest-form" class="row" style="margin-bottom:10px">
            <select id="sg-series" class="small" required></select>
            <input id="sg-name" class="small" placeholder="ë‹‰ë„¤ì„" required>
            <button class="btn pri" type="submit">ì œì•ˆ ì˜¬ë¦¬ê¸°</button>
          </form>
          <textarea id="sg-text" rows="5" placeholder="ë‹¤ìŒ ì´ì•¼ê¸°ë¥¼ ì œì•ˆí•´ì£¼ì„¸ìš”â€¦" required></textarea>
        </div>
        <div class="card">
          <h3>ìµœê·¼ ì œì•ˆ</h3>
          <div id="suggestions" class="grid"></div>
        </div>
      </section>

      <!-- ADMIN -->
      <section id="admin" class="section">
        <div id="admin-login" class="card">
          <h2 class="title">ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
          <form class="row" onsubmit="return false">
            <input id="admin-pass" type="password" class="small" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <button class="btn pri" id="btnAdminLogin">ë¡œê·¸ì¸</button>
          </form>
          <p class="empty">ë¡œê·¸ì¸ í›„ â€œê´€ë¦¬ ì½˜ì†”â€ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>
        </div>

        <div id="admin-panel" class="card" style="display:none">
          <div class="row" style="justify-content:space-between">
            <h3>ê´€ë¦¬ ì½˜ì†”</h3>
            <div class="row">
              <button class="btn pri" id="openSeries">+ ì‹œë¦¬ì¦ˆ</button>
              <button class="btn pri" id="openStory">+ ì±…</button>
              <button class="btn pri" id="openGroup">+ ê·¸ë£¹</button>
              <button class="btn" id="openApprove">ì œì•ˆ ìŠ¹ì¸</button>
            </div>
          </div>
          <div class="grid cols-2" style="margin-top:10px">
            <div>
              <h4>ì‹œë¦¬ì¦ˆ</h4>
              <div id="admin-series" class="grid"></div>
            </div>
            <div>
              <h4>ì±…</h4>
              <div id="admin-stories" class="grid"></div>
            </div>
          </div>
        </div>
      </section>

    </div>
  </div>
</div>

<!-- MODAL / TOAST -->
<div id="modal" class="modal"><div class="box"><div class="row" style="justify-content:space-between"><h3 id="modal-title">ëª¨ë‹¬</h3><button class="btn close" id="modal-close">ë‹«ê¸°</button></div><div id="modal-body"></div></div></div>
<div id="toast" class="toast"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
/* ============ Firebase ============ */
// ğŸ”‘ ì—¬ê¸°ì— ë„¤ firebaseConfig ì „ì²´ë¥¼
  const firebaseConfig = {
  apiKey: "AIzaSyBEBA0ZUVcMBG_G9CtauP02kh4Wneg-5gA",
  authDomain: "storybook-4a13b.firebaseapp.com",
  projectId: "storybook-4a13b",
  storageBucket: "storybook-4a13b.firebasestorage.app",
  messagingSenderId: "756981563455",
  appId: "1:756981563455:web:b0bef64ba3ca2fb39a788a",
  measurementId: "G-CPXLQYTYJY"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ============ State & Utils ============ */
const ADMIN_PASSWORD = "admin1234";
let isAdmin=false, currentSeries=null, currentGroup=null;

const $=id=>document.getElementById(id);
const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
function show(id){ $$(".section").forEach(el=>el.classList.remove("show")); $(id).classList.add("show"); }
function toast(msg){const t=$("toast");t.textContent=msg;t.style.display="block";setTimeout(()=>t.style.display="none",1800)}
function openModal(title,inner){$("modal-title").textContent=title;$("modal-body").innerHTML=inner;$("modal").classList.add("on")}
function closeModal(){ $("modal").classList.remove("on") }
$("modal-close").onclick=closeModal;
const esc = (s)=>String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/"/g,"&quot;");

/* NAV */
$$("[data-page]").forEach(b=>b.addEventListener("click",()=>{ show(b.dataset.page);
  if(b.dataset.page==="home") loadHome();
  if(b.dataset.page==="stories") loadSeriesTabs();
  if(b.dataset.page==="groups") loadGroups();
  if(b.dataset.page==="next") { loadSeriesSelects(); loadSuggestions(); }
  if(b.dataset.page==="admin" && isAdmin) renderAdmin();
}));

/* ============ HOME ============ */
async function loadHome(){
  const box=$("home-stories"); box.innerHTML="";
  const snap=await db.collection("stories").orderBy("created","desc").limit(6).get();
  if(snap.empty){ box.innerHTML='<div class="empty">ì•„ì§ ì±…ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  snap.forEach(d=>{
    const s=d.data();
    const c=document.createElement("div"); c.className="story";
    c.innerHTML=`<h4>${esc(s.title)}</h4>
      <p>${esc((s.text||"").slice(0,120))}${(s.text||"").length>120?"â€¦":""}</p>
      <div class="meta">${new Date(s.created?.toDate?.()||Date.now()).toLocaleString()}</div>
      <div class="actions"><button class="btn" data-read>ì½ê¸°</button></div>`;
    c.querySelector("[data-read]").onclick=()=>openBookModal(s.title,s.text);
    box.appendChild(c);
  });
}

/* ============ STORIES (Series Tabs) ============ */
async function loadSeriesTabs(){
  $("series-tabs").innerHTML=""; $("series-desc").textContent=""; $("story-list").innerHTML="";
  $("story-loading").style.display="block";

  const tabs=$("series-tabs");
  // ì „ì²´ íƒ­
  const all=document.createElement("button"); all.className="tab"; all.textContent="ì „ì²´";
  all.onclick=()=>{ currentSeries=null; highlightTabs(); $("series-desc").textContent="ì „ì²´ ì‹œë¦¬ì¦ˆì˜ ì±…"; loadStories(); };
  tabs.appendChild(all);

  const snap=await db.collection("series").orderBy("created","desc").get();
  if(snap.empty){
    $("series-desc").textContent="ì‹œë¦¬ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ì„œ ì‹œë¦¬ì¦ˆë¥¼ ì¶”ê°€í•˜ì„¸ìš”.";
    $("story-loading").style.display="none"; return;
  }

  snap.forEach(doc=>{
    const s=doc.data(); const b=document.createElement("button");
    b.className="tab"; b.textContent=s.name; b.dataset.sid=doc.id;
    b.onclick=()=>{ currentSeries=doc.id; highlightTabs(); $("series-desc").textContent=s.desc||""; loadStories(); };
    tabs.appendChild(b);
  });

  // ê¸°ë³¸: ì „ì²´ ë³´ê¸°
  currentSeries=null; highlightTabs(); $("series-desc").textContent="ì „ì²´ ì‹œë¦¬ì¦ˆì˜ ì±…"; await loadStories();
}
function highlightTabs(){ $$(".tab").forEach(t=>t.classList.toggle("active", (!currentSeries && t.textContent==="ì „ì²´") || t.dataset.sid===currentSeries)) }

async function loadStories(){
  const list=$("story-list"); list.innerHTML="";
  let q=db.collection("stories").orderBy("created","desc");
  if(currentSeries){ q=q.where("seriesId","==",currentSeries); }
  const snap=await q.get(); $("story-loading").style.display="none";
  if(snap.empty){ list.innerHTML='<div class="empty">í‘œì‹œí•  ì±…ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  snap.forEach(doc=>{
    const s=doc.data();
    const el=document.createElement("div"); el.className="story";
    el.innerHTML=`<h4>${esc(s.title)}</h4>
      <p>${esc((s.text||"").slice(0,220)).replace(/\n/g,"<br>")}${(s.text||"").length>220?"â€¦":""}</p>
      <div class="actions">
        <button class="btn" data-read>ì½ê¸°</button>
        ${isAdmin?'<button class="btn" data-edit>ìˆ˜ì •</button><button class="btn" data-del>ì‚­ì œ</button>':''}
      </div>`;
    el.querySelector("[data-read]").onclick=()=>openBookModal(s.title,s.text);
    if(isAdmin){
      el.querySelector("[data-edit]").onclick=()=>openEditStoryModal(doc.id,s);
      el.querySelector("[data-del]").onclick=async()=>{ if(!confirm("ì‚­ì œí• ê¹Œìš”?"))return;
        await db.collection("stories").doc(doc.id).delete(); toast("ì‚­ì œë¨"); loadStories(); renderAdmin(); };
    }
    list.appendChild(el);
  });
}
function openBookModal(title,text){ openModal(esc(title||"ì±…"), `<div style="white-space:pre-wrap;line-height:1.6">${esc(text||"").replace(/\n/g,"<br>")}</div>`) }

/* ============ GROUPS ============ */
async function loadGroups(){
  const list=$("group-list"); list.innerHTML="";
  const snap=await db.collection("groups").orderBy("created","desc").get();
  if(snap.empty){ list.innerHTML='<div class="empty">ì•„ì§ ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; $("group-box").style.display="none"; return; }
  snap.forEach(doc=>{
    const g=doc.data(); const c=document.createElement("div"); c.className="story";
    c.innerHTML=`<h4>${esc(g.name)}</h4><p>${esc(g.desc||"")}</p>
      <div class="actions">
        <button class="btn pri" data-open>ë“¤ì–´ê°€ê¸°</button>
        ${isAdmin?'<button class="btn" data-del>ì‚­ì œ</button>':""}
      </div>`;
    c.querySelector("[data-open]").onclick=()=>openGroup(doc.id,g);
    if(isAdmin) c.querySelector("[data-del]").onclick=async()=>{ if(!confirm("ê·¸ë£¹ ì‚­ì œ? (ê²Œì‹œê¸€ì€ ë‚¨ìŠµë‹ˆë‹¤)"))return;
      await db.collection("groups").doc(doc.id).delete(); toast("ì‚­ì œë¨"); loadGroups(); renderAdmin(); };
    list.appendChild(c);
  });
}
async function openGroup(id,g){
  currentGroup={id,...g};
  $("group-box").style.display="block"; $("group-title").textContent=g.name; $("group-desc").textContent=g.desc||"";
  loadGroupPosts();
}
$("group-post-form").addEventListener("submit", async e=>{
  e.preventDefault(); if(!currentGroup) return;
  const name=$("gp-name").value.trim(); const text=$("gp-text").value.trim(); if(!name||!text) return;
  await db.collection("groupPosts").add({groupId:currentGroup.id,name,text,created:new Date()});
  $("gp-text").value=""; toast("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!"); loadGroupPosts();
});
async function loadGroupPosts(){
  const box=$("group-posts"); box.innerHTML="";
  const snap=await db.collection("groupPosts").where("groupId","==",currentGroup.id).orderBy("created","desc").get();
  if(snap.empty){box.innerHTML='<div class="empty">ì•„ì§ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';return}
  snap.forEach(d=>{ const x=d.data(); const el=document.createElement("div"); el.className="story"; el.innerHTML=`<h4>${esc(x.name)}</h4><p>${esc(x.text).replace(/\n/g,"<br>")}</p>`; box.appendChild(el) });
}

/* ============ NEXT (SUGGESTIONS) ============ */
async function loadSeriesSelects(){
  const sel=$("sg-series"); const snap=await db.collection("series").orderBy("created","desc").get();
  const html=['<option value="">(ì‹œë¦¬ì¦ˆ ì„ íƒ)</option>']; snap.forEach(d=>html.push(`<option value="${d.id}">${esc(d.data().name)}</option>`));
  sel.innerHTML=html.join("");
}
$("suggest-form").addEventListener("submit", async e=>{
  e.preventDefault();
  const seriesId=$("sg-series").value; const name=$("sg-name").value.trim(); const text=$("sg-text").value.trim();
  if(!seriesId) return alert("ì‹œë¦¬ì¦ˆë¥¼ ì„ íƒí•˜ì„¸ìš”.");
  if(!name||!text) return;
  await db.collection("suggestions").add({seriesId,name,text,created:new Date()});
  $("sg-name").value=""; $("sg-text").value=""; toast("ì œì•ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!"); loadSuggestions();
});
async function loadSuggestions(){
  const box=$("suggestions"); box.innerHTML="";
  const map=await getSeriesMap();
  const snap=await db.collection("suggestions").orderBy("created","desc").get();
  if(snap.empty){box.innerHTML='<div class="empty">ì•„ì§ ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>';return}
  snap.forEach(doc=>{ const d=doc.data(); const el=document.createElement("div"); el.className="story";
    el.innerHTML=`<div class="meta">${esc(map[d.seriesId]||"ì‹œë¦¬ì¦ˆ")}</div><h4>${esc(d.name)}</h4><p>${esc(d.text).replace(/\n/g,"<br>")}</p>`; box.appendChild(el) });
}
async function getSeriesMap(){ const map={}; const snap=await db.collection("series").get(); snap.forEach(s=>map[s.id]=s.data().name); return map; }

/* ============ ADMIN ============ */
$("btnAdminLogin").onclick=()=>{
  const v=$("admin-pass").value;
  if(v===ADMIN_PASSWORD){ isAdmin=true; $("role").textContent="ê´€ë¦¬ì"; $("admin-login").style.display="none"; $("admin-panel").style.display="block"; toast("ê´€ë¦¬ì ëª¨ë“œ"); renderAdmin(); }
  else alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
};
function renderAdmin(){ loadAdminSeries(); loadAdminStories(); }

/* ì‹œë¦¬ì¦ˆ ì¶”ê°€ */
$("openSeries").onclick=()=>openModal("ì‹œë¦¬ì¦ˆ ì¶”ê°€", `
  <form id="formSeries" class="grid">
    <input id="se-name" placeholder="ì‹œë¦¬ì¦ˆ ì´ë¦„" required>
    <input id="se-desc" placeholder="ì„¤ëª… (ì„ íƒ)">
    <div class="row" style="justify-content:flex-end"><button class="btn pri" type="submit">ì¶”ê°€</button></div>
  </form>
`);
document.addEventListener("submit", async (e)=>{
  if(e.target.id==="formSeries"){ e.preventDefault();
    const name=document.getElementById("se-name").value.trim();
    const desc=document.getElementById("se-desc").value.trim();
    if(!name) return;
    await db.collection("series").add({name,desc,created:new Date()});
    toast("ì‹œë¦¬ì¦ˆ ì¶”ê°€ë¨"); closeModal(); loadAdminSeries(); loadSeriesTabs(); loadSeriesSelects();
  }
});

/* ì±… ì¶”ê°€ */
$("openStory").onclick=async()=>{
  const opts=await buildSeriesOptions();
  openModal("ì±… ì¶”ê°€", `
    <form id="formStory" class="grid">
      <select id="st-series" required>${opts}</select>
      <input id="st-title" placeholder="ì±… ì œëª©" required>
      <textarea id="st-text" rows="6" placeholder="ë³¸ë¬¸ (ì„ íƒ)"></textarea>
      <div class="row" style="justify-content:flex-end"><button class="btn pri" type="submit">ì¶”ê°€</button></div>
    </form>
  `);
};
document.addEventListener("submit", async (e)=>{
  if(e.target.id==="formStory"){ e.preventDefault();
    const seriesId=document.getElementById("st-series").value;
    const title=document.getElementById("st-title").value.trim();
    const text=document.getElementById("st-text").value;
    if(!seriesId||!title) return;
    await db.collection("stories").add({seriesId,title,text,created:new Date()});
    toast("ì±… ì¶”ê°€ë¨"); closeModal(); loadAdminStories(); loadStories();
  }
});

/* ì œì•ˆ ìŠ¹ì¸ ëª¨ë‹¬ */
$("openApprove").onclick=async()=>{
  const map=await getSeriesMap();
  const snap=await db.collection("suggestions").orderBy("created","desc").get();
  let html="";
  if(snap.empty) html='<div class="empty">ìŠ¹ì¸ ëŒ€ê¸° ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>';
  snap.forEach(doc=>{
    const d=doc.data();
    html+=`<div class="story"><div class="meta">${esc(map[d.seriesId]||"ì‹œë¦¬ì¦ˆ")}</div><h4>${esc(d.name)}</h4><p>${esc(d.text).replace(/\n/g,"<br>")}</p>
      <div class="actions"><button class="btn pri" data-approve="${doc.id}">ì±…ìœ¼ë¡œ ë“±ë¡</button><button class="btn" data-del="${doc.id}">ì‚­ì œ</button></div></div>`;
  });
  openModal("ì œì•ˆ ìŠ¹ì¸", html || '<div class="empty">ì—†ìŒ</div>');
  $$("[data-approve]").forEach(btn=>btn.onclick=()=>approveSuggestion(btn.getAttribute("data-approve")));
  $$("[data-del]").forEach(btn=>btn.onclick=()=>removeSuggestion(btn.getAttribute("data-del")));
};

/* ê·¸ë£¹ ì¶”ê°€ */
$("openGroup").onclick=()=>openModal("ê·¸ë£¹ ì¶”ê°€", `
  <form id="formGroup" class="grid">
    <input id="gr-name" placeholder="ê·¸ë£¹ ì´ë¦„" required>
    <input id="gr-desc" placeholder="ì„¤ëª… (ì„ íƒ)">
    <div class="row" style="justify-content:flex-end"><button class="btn pri" type="submit">ì¶”ê°€</button></div>
  </form>
`);
document.addEventListener("submit", async (e)=>{
  if(e.target.id==="formGroup"){ e.preventDefault();
    const name=document.getElementById("gr-name").value.trim();
    const desc=document.getElementById("gr-desc").value.trim();
    if(!name) return;
    await db.collection("groups").add({name,desc,created:new Date()});
    toast("ê·¸ë£¹ ìƒì„±ë¨"); closeModal(); loadGroups();
  }
});

/* Admin lists - ì‹œë¦¬ì¦ˆ(ìˆ˜ì • ì¶”ê°€) */
async function loadAdminSeries(){
  const box=$("admin-series"); box.innerHTML="";
  const snap=await db.collection("series").orderBy("created","desc").get();
  if(snap.empty){ box.innerHTML='<div class="empty">ì‹œë¦¬ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  snap.forEach(doc=>{
    const s=doc.data(); const el=document.createElement("div"); el.className="story";
    el.innerHTML=`<h4>${esc(s.name)}</h4><p>${esc(s.desc||"")}</p>
      <div class="actions">
        <button class="btn" data-edit>ìˆ˜ì •</button>
        <button class="btn" data-del>ì‚­ì œ</button>
      </div>`;
    // ìˆ˜ì • ë²„íŠ¼ â†’ ì‹œë¦¬ì¦ˆ ìˆ˜ì • ëª¨ë‹¬
    el.querySelector("[data-edit]").onclick=()=>{
      openModal("ì‹œë¦¬ì¦ˆ ìˆ˜ì •", `
        <form id="formSeriesEdit" class="grid">
          <input id="edit-name" value="${esc(s.name)}" required>
          <input id="edit-desc" value="${esc(s.desc||"")}">
          <div class="row" style="justify-content:flex-end"><button class="btn pri" type="submit">ì €ì¥</button></div>
        </form>
      `);
      document.getElementById("formSeriesEdit").addEventListener("submit", async e=>{
        e.preventDefault();
        const name=document.getElementById("edit-name").value.trim();
        const desc=document.getElementById("edit-desc").value.trim();
        if(!name) return;
        await db.collection("series").doc(doc.id).update({name,desc});
        toast("ì‹œë¦¬ì¦ˆ ìˆ˜ì • ì™„ë£Œ"); closeModal(); loadAdminSeries(); loadSeriesTabs(); loadSeriesSelects();
      }, {once:true});
    };
    // ì‚­ì œ ë²„íŠ¼
    el.querySelector("[data-del]").onclick=async()=>{
      if(!confirm("ì‹œë¦¬ì¦ˆë¥¼ ì‚­ì œí• ê¹Œìš”? (ì´ë¯¸ ë“±ë¡ëœ ì±…ì€ ë‚¨ìŠµë‹ˆë‹¤)")) return;
      await db.collection("series").doc(doc.id).delete();
      toast("ì‹œë¦¬ì¦ˆ ì‚­ì œë¨"); loadAdminSeries(); loadSeriesTabs(); loadSeriesSelects();
    };
    box.appendChild(el);
  });
}

/* Admin lists - ì±… */
async function loadAdminStories(){
  const box=$("admin-stories"); box.innerHTML="";
  const map=await getSeriesMap();
  const snap=await db.collection("stories").orderBy("created","desc").get();
  if(snap.empty){ box.innerHTML='<div class="empty">ì±…ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  snap.forEach(doc=>{
    const s=doc.data(); const el=document.createElement("div"); el.className="story";
    el.innerHTML=`<div class="meta">${esc(map[s.seriesId]||"ì‹œë¦¬ì¦ˆ ë¯¸ì§€ì •")}</div><h4>${esc(s.title)}</h4>
      <div class="actions"><button class="btn" data-edit>ìˆ˜ì •</button><button class="btn" data-del>ì‚­ì œ</button></div>`;
    el.querySelector("[data-edit]").onclick=()=>openEditStoryModal(doc.id,s);
    el.querySelector("[data-del]").onclick=async()=>{ if(!confirm("ì‚­ì œí• ê¹Œìš”?"))return; await db.collection("stories").doc(doc.id).delete(); toast("ì‚­ì œë¨"); loadAdminStories(); loadStories(); };
    box.appendChild(el);
  });
}

function openEditStoryModal(id,s){
  openModal("ì±… ìˆ˜ì •", `
    <form id="formStoryEdit" class="grid">
      <input id="ed-title" value="${esc(s.title||'')}" required>
      <textarea id="ed-text" rows="6">${esc(s.text||'')}</textarea>
      <div class="row" style="justify-content:flex-end"><button class="btn pri" type="submit">ì €ì¥</button></div>
    </form>
  `);
  document.getElementById("formStoryEdit").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const title=document.getElementById("ed-title").value.trim();
    const text=document.getElementById("ed-text").value;
    if(!title) return;
    await db.collection("stories").doc(id).update({title,text});
    toast("ìˆ˜ì •ë¨"); closeModal(); loadAdminStories(); loadStories();
  }, {once:true});
}

/* Approve / Remove suggestion */
async function approveSuggestion(id){
  const doc=await db.collection("suggestions").doc(id).get(); if(!doc.exists) return;
  const d=doc.data();
  openModal("ì±… ë“±ë¡", `
    <form id="formApprove" class="grid">
      <div class="meta">ì‹œë¦¬ì¦ˆ: ${esc((await getSeriesMap())[d.seriesId] || "ì•Œ ìˆ˜ ì—†ìŒ")}</div>
      <input id="ap-title" placeholder="ì±… ì œëª©" required>
      <div class="row" style="justify-content:flex-end"><button class="btn pri" type="submit">ë“±ë¡</button></div>
    </form>
  `);
  document.getElementById("formApprove").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const title=document.getElementById("ap-title").value.trim(); if(!title) return;
    await db.collection("stories").add({seriesId:d.seriesId,title,text:d.text,created:new Date()});
    await db.collection("suggestions").doc(id).delete();
    toast("ìŠ¹ì¸ë˜ì–´ ì±…ìœ¼ë¡œ ë“±ë¡ë¨"); closeModal(); loadSuggestions(); loadStories(); renderAdmin();
  }, {once:true});
}
async function removeSuggestion(id){
  if(!confirm("ì œì•ˆì„ ì‚­ì œí• ê¹Œìš”?"))return;
  await db.collection("suggestions").doc(id).delete(); toast("ì‚­ì œë¨"); renderAdmin();
}

/* Helpers */
async function buildSeriesOptions(){
  const snap=await db.collection("series").orderBy("created","desc").get();
  const arr=[]; snap.forEach(s=>arr.push(`<option value="${s.id}">${esc(s.data().name)}</option>`));
  return arr.join("");
}

/* INIT */
show("home"); loadHome();
</script>
</body>
</html>
