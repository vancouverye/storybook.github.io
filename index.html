<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>ì—°ìŠ¤- No.1 ìŠ¤í† ë¦¬ë¶ í”Œë«í¼</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0a0f18;--bg2:#0d1424;--glass:#0f1726cc;--solid:#0f1726;
      --line:#1c2a40;--ink:#eaf1fb;--mut:#9fb0c3;--mute:#7d91a7;
      --pri:#6ea3ff;--pri2:#4f7ef3;--r:16px;--sh:0 22px 55px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;color:var(--ink);
      background:
        radial-gradient(70% 90% at 10% 0,#14213d 0,transparent 55%),
        radial-gradient(70% 80% at 100% 0,#12203a 0,transparent 50%),
        linear-gradient(180deg,#0a0f18 0,#0c1424 45%,#0a0f18 100%);
    }
    .app{display:grid;grid-template-rows:68px 1fr;min-height:100vh}
    .header{
      position:sticky;top:0;z-index:50;display:flex;align-items:center;gap:12px;padding:10px 16px;
      background:#0b1322cc;border-bottom:1px solid var(--line);backdrop-filter:blur(12px)
    }
    .brand{font-weight:800}
    .header-nav{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      background:linear-gradient(180deg,#111b33,#0d1629);border:1px solid var(--line);color:var(--ink);
      padding:10px 14px;border-radius:12px;cursor:pointer;transition:.15s;box-shadow:inset 0 -1px 0 rgba(255,255,255,.04)
    }
    .btn:hover{border-color:#2a3b5e;transform:translateY(-1px)}
    .btn.pri{background:linear-gradient(180deg,var(--pri),var(--pri2));border-color:transparent;color:#fff}
    .main{padding:22px}
    .container{max-width:1200px;margin:0 auto;display:grid;gap:18px}
    .section{display:none}.section.show{display:block}
    .card{background:var(--glass);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--sh);padding:16px}
    .grid{display:grid;gap:16px}
    .cols-2{grid-template-columns:repeat(2,1fr)}
    @media(max-width:940px){.cols-2{grid-template-columns:1fr}}
    .tabs{display:flex;gap:10px;overflow:auto;padding:8px 2px}
    .tab{border:1px solid var(--line);background:#0e1627;color:var(--ink);padding:8px 14px;border-radius:999px;white-space:nowrap;cursor:pointer}
    .tab.active{border-color:transparent;background:linear-gradient(90deg,var(--pri),var(--pri2));color:#fff}

    .story{
      background:linear-gradient(180deg,#0f1a2e,#0f1729);border:1px solid var(--line);
      border-radius:18px;padding:16px;cursor:pointer;transition:transform .15s
    }
    .story:hover{transform:translateY(-2px);background:#14203a}
    .story h4{margin:0}.story p{margin:6px 0;color:var(--mute)}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    input,textarea,select{width:100%;background:#0b1422;border:1px solid var(--line);color:var(--ink);padding:11px;border-radius:12px}
    textarea{resize:vertical}
    .spinner{width:44px;height:44px;border:3px solid #1a2840;border-top-color:var(--pri);border-radius:50%;animation:spin 1s linear infinite;margin:20px auto}
    @keyframes spin{to{transform:rotate(360deg)}}
    .toast{position:fixed;right:16px;bottom:16px;background:#0b1322e6;border:1px solid var(--line);padding:10px 14px;border-radius:12px;display:none;z-index:400}
    .modal{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:350}
    .modal.on{display:flex}
    .modal .box{
      width:min(860px,92vw);max-height:92vh;overflow:auto;background:var(--solid);border:1px solid var(--line);
      border-radius:18px;box-shadow:var(--sh);padding:16px
    }
    .modal .body-scroll{max-height:70vh;overflow:auto}
    hr{border:none;border-top:1px solid var(--line);margin:12px 0}
    .mut{color:var(--mut)}
    .kbd{border:1px solid var(--line);border-radius:8px;padding:3px 8px;color:var(--mut);font-size:12px}
    .badge{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:#b9c8dc}
    .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .grow{flex:1}

    /* ëª¨ë°”ì¼ í„°ì¹˜ ê°œì„  */
    @media(max-width:540px){
      .btn{padding:12px 14px;border-radius:14px}
      .tab{padding:10px 16px}
      .story{padding:14px}
      .header{gap:8px}
      .brand{font-size:16px}
      .main{padding:14px}
      .container{gap:14px}
      input,textarea,select{padding:13px;border-radius:14px}
    }
  </style>
</head>
<body>
<div class="app">
  <!-- Header -->
  <div class="header">
    <div class="brand">ğŸ“š ì—°ìŠ¤- No.1 ìŠ¤í† ë¦¬ë¶ í”Œë«í¼</div>
    <div class="header-nav">
      <button class="btn" data-page="home">í™ˆ</button>
      <button class="btn" data-page="stories">ìŠ¤í† ë¦¬ë¶</button>
      <button class="btn" data-page="next">ì±… ë§Œë“¤ê¸°</button>
      <button class="btn" data-page="groups">ê·¸ë£¹</button>
      <button class="btn" data-page="leaderboard">ë¦¬ë”ë³´ë“œ</button>
      <button class="btn" data-page="profile">í”„ë¡œí•„</button>
      <button class="btn pri" data-page="admin">ê´€ë¦¬ì</button>
    </div>
  </div>

  <!-- Main -->
  <div class="main">
    <div class="container">

      <!-- HOME -->
      <section id="home" class="section show">
        <div class="card">
          <h2>í™˜ì˜í•©ë‹ˆë‹¤ ğŸ‘‹</h2>
          <p>ê·¸ë£¹ì—ì„œ í† ë¡ í•˜ê³ , ì±…ì„ ì½ê³ , í€´ì¦ˆë¡œ í¬ì¸íŠ¸ë¥¼ ëª¨ì•„ ë¦¬ë”ë³´ë“œ 1ìœ„ë¥¼ ë…¸ë ¤ë³´ì„¸ìš”!</p>
        </div>
      </section>

      <!-- STORIES -->
      <section id="stories" class="section">
        <div class="card">
          <h2>ìŠ¤í† ë¦¬ë¶</h2>
          <div id="series-tabs" class="tabs" style="margin-top:6px"></div>
          <div id="series-desc" class="mut" style="margin:6px 2px 10px"></div>
          <div id="story-list" class="grid cols-2"></div>
          <div id="story-loading" class="spinner" style="display:none"></div>
        </div>
      </section>

      <!-- NEXT (Proposals) -->
      <section id="next" class="section">
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <h2>ì±… ë§Œë“¤ê¸°</h2>
            <span class="mut">ëˆ„êµ¬ë‚˜ ì œì•ˆ â†’ ê´€ë¦¬ìê°€ ìŠ¹ì¸í•˜ë©´ ì±…ìœ¼ë¡œ ì˜¬ë¼ê°‘ë‹ˆë‹¤.</span>
          </div>
        </div>
        <div class="card">
          <form id="next-form" class="grid">
            <div class="row">
              <input id="nx-author" placeholder="ì‘ì„±ì (ë‹‰ë„¤ì„)" required style="max-width:260px">
              <input id="nx-title" placeholder="ì œëª©" required class="grow">
              <button class="btn pri" type="submit">ì œì•ˆ ì˜¬ë¦¬ê¸°</button>
            </div>
            <textarea id="nx-text" rows="5" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”â€¦" required></textarea>
          </form>
        </div>
        <div class="card">
          <h3>ì œì•ˆ ëª©ë¡</h3>
          <div id="next-list" class="grid"></div>
          <div id="next-loading" class="spinner" style="display:none"></div>
        </div>
      </section>

      <!-- GROUPS -->
      <section id="groups" class="section">
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <h2>ê·¸ë£¹</h2>
            <span class="mut">ê·¸ë£¹ ì•ˆì—ì„œ ëˆ„êµ¬ë‚˜ ê¸€ì„ ì“¸ ìˆ˜ ìˆì–´ìš”.</span>
          </div>
        </div>
        <div id="group-list" class="grid cols-2"></div>

        <!-- ê·¸ë£¹ ìƒì„¸/ê²Œì‹œíŒ -->
        <div id="group-box" class="card" style="display:none">
          <div class="row" style="justify-content:space-between">
            <div>
              <h3 id="group-title">ê·¸ë£¹</h3>
              <div id="group-desc" class="mut"></div>
            </div>
            <div id="group-admin-actions" style="display:none;gap:8px" class="actions">
              <button class="btn" id="btnEditGroup">ê·¸ë£¹ ìˆ˜ì •</button>
              <button class="btn" id="btnDeleteGroup">ê·¸ë£¹ ì‚­ì œ</button>
            </div>
          </div>
          <hr/>
          <!-- ê¸€ì“°ê¸° -->
          <form id="group-post-form" class="grid" style="margin-bottom:8px">
            <div class="row">
              <input id="gp-author" class="small" placeholder="ì‘ì„±ì (ë‹‰ë„¤ì„)" required style="max-width:260px">
              <input id="gp-title" class="small" placeholder="ì œëª©" required class="grow">
              <button class="btn pri" type="submit">ê¸€ ì˜¬ë¦¬ê¸°</button>
            </div>
            <textarea id="gp-text" rows="4" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”â€¦" required></textarea>
            <div class="mut"><span class="kbd">Tip</span> ì—”í„°=ì¤„ë°”ê¿ˆ</div>
          </form>

          <h4 style="margin-top:10px">ê²Œì‹œê¸€</h4>
          <div id="group-posts" class="grid"></div>
          <div id="group-posts-loading" class="spinner" style="display:none"></div>
        </div>
      </section>

      <!-- LEADERBOARD -->
      <section id="leaderboard" class="section">
        <div class="card">
          <h2>ğŸ† ë¦¬ë”ë³´ë“œ TOP 10</h2>
          <div id="leaderboard-list" class="grid"></div>
        </div>
      </section>

      <!-- PROFILE -->
      <section id="profile" class="section">
        <div class="card">
          <h2>ğŸ‘¤ ë‚´ í”„ë¡œí•„</h2>
          <div class="row">
            <input id="prof-name" placeholder="ë‹‰ë„¤ì„" style="max-width:260px">
            <button class="btn" id="btnSaveName">ë‹‰ë„¤ì„ ì €ì¥</button>
          </div>
          <div id="profile-box" class="mut" style="margin-top:10px"></div>
        </div>
      </section>

      <!-- ADMIN -->
      <section id="admin" class="section">
        <div id="admin-login" class="card">
          <h2>ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
          <div class="row" style="margin-top:8px">
            <input id="admin-pass" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="small" style="max-width:260px">
            <button class="btn pri" id="btnAdminLogin">ë¡œê·¸ì¸</button>
          </div>
        </div>

        <div id="admin-panel" class="card" style="display:none">
          <div class="row" style="justify-content:space-between">
            <h3>ê´€ë¦¬ ì½˜ì†”</h3>
            <div class="row">
              <button class="btn pri" id="openSeries">+ ì‹œë¦¬ì¦ˆ</button>
              <button class="btn pri" id="openStory">+ ì±…</button>
              <button class="btn pri" id="openGroup">+ ê·¸ë£¹</button>
              <button class="btn pri" id="openQuizAdmin">+ í€´ì¦ˆ</button>
            </div>
          </div>

          <div class="grid cols-2" style="margin-top:12px">
            <div>
              <h4>ì‹œë¦¬ì¦ˆ</h4>
              <div id="admin-series"></div>
            </div>
            <div>
              <h4>ì±…</h4>
              <div id="admin-stories"></div>
            </div>
          </div>

          <div style="margin-top:14px">
            <h4>ê·¸ë£¹</h4>
            <div id="admin-groups"></div>
          </div>

          <div style="margin-top:14px">
            <h4>â€˜ë‹¤ìŒ ì´ì•¼ê¸°â€™ ì œì•ˆ ê´€ë¦¬</h4>
            <div id="admin-next"></div>
          </div>

          <div style="margin-top:14px">
            <h4>í€´ì¦ˆ ê´€ë¦¬</h4>
            <div id="admin-quizzes"></div>
          </div>
        </div>
      </section>

    </div>
  </div>
</div>

<!-- Modal / Toast -->
<div id="modal" class="modal" aria-modal="true" role="dialog">
  <div class="box">
    <div class="row" style="justify-content:space-between">
      <h3 id="modal-title">Modal</h3>
      <div class="row">
        <button class="btn" id="modal-quiz" style="display:none">í€´ì¦ˆ í’€ê¸°</button>
        <button class="btn" id="modal-close">ë‹«ê¸°</button>
      </div>
    </div>
    <div id="modal-body" class="body-scroll"></div>
  </div>
</div>
<div id="toast" class="toast"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
/* ================== Firebase (í•„ìˆ˜: ë„¤ ì„¤ì • ê·¸ëŒ€ë¡œ) ================== */
const firebaseConfig = {
  apiKey: "AIzaSyBEBA0ZUVcMBG_G9CtauP02kh4Wneg-5gA",
  authDomain: "storybook-4a13b.firebaseapp.com",
  projectId: "storybook-4a13b",
  storageBucket: "storybook-4a13b.firebasestorage.app",
  messagingSenderId: "756981563455",
  appId: "1:756981563455:web:b0bef64ba3ca2fb39a788a",
  measurementId: "G-CPXLQYTYJY"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================== ê³µí†µ/ìƒíƒœ ================== */
const ADMIN_PASSWORD = "admin5848";
let isAdmin=false, currentSeries="ALL", currentGroup=null, currentModalStoryId=null;
const deviceId = (()=>{ const k='device_id'; let v=localStorage.getItem(k); if(!v){ v='dev_'+cryptoRandom(); localStorage.setItem(k,v);} return v; })();

const $ = id => document.getElementById(id);
const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
const esc = s => String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
function show(id){ $$(".section").forEach(el=>el.classList.remove("show")); $(id).classList.add("show"); }
function toast(msg){ const t=$("toast"); t.textContent=msg; t.style.display="block"; setTimeout(()=>t.style.display="none",1600); }
function openModal(title,body,{quizFor=null}={}){
  $("modal-title").textContent=title;
  $("modal-body").innerHTML=body;
  currentModalStoryId = quizFor || null;
  const quizBtn = $("modal-quiz");
  if(quizFor){ quizBtn.style.display="inline-block"; quizBtn.onclick=()=>openQuiz(quizFor,title); }
  else { quizBtn.style.display="none"; quizBtn.onclick=null; }
  $("modal").classList.add("on");
}
$("modal-close").onclick = () => $("modal").classList.remove("on");
function cryptoRandom(){ try{const a=crypto.getRandomValues(new Uint32Array(4));return Array.from(a).map(x=>x.toString(16)).join('');}catch(e){return (Math.random()+"").slice(2)+Date.now();}}
function getMs(ts){ try{ if(typeof ts?.toDate==="function") return ts.toDate().getTime(); const d=new Date(ts); if(!isNaN(d)) return d.getTime(); }catch(e){} return 0; }
function formatDate(ts){ const ms=getMs(ts); return ms?new Date(ms).toLocaleString():""; }

/* ================== ë„¤ë¹„ ================== */
$$("[data-page]").forEach(b => b.addEventListener("click", () => {
  show(b.dataset.page);
  if (b.dataset.page==="home") loadHome();
  if (b.dataset.page==="stories") loadSeriesTabs();
  if (b.dataset.page==="next") loadNext();
  if (b.dataset.page==="groups") loadGroups();
  if (b.dataset.page==="leaderboard") loadLeaderboard();
  if (b.dataset.page==="profile") loadProfile();
  if (b.dataset.page==="admin" && isAdmin) renderAdmin();
}));

/* ================== HOME ================== */
async function loadHome(){
  const box=$("home-stories"); box.innerHTML="";
  const snap=await db.collection("stories").orderBy("created","desc").limit(6).get();
  if(snap.empty){ box.innerHTML='<div class="mut">ì•„ì§ ì±…ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  snap.forEach(d=>{
    const s=d.data(); const sid=d.id; const views=s.views||0;
    const el=document.createElement("div"); el.className="story";
    el.innerHTML = `<h4>${esc(s.title)}</h4>
      <p>${esc((s.text||"").slice(0,160))}${(s.text||"").length>160?"â€¦":""}</p>
      <div class="mut">ğŸ‘ï¸ ${views}íšŒ ì¡°íšŒ</div>
      <div class="actions"><button class="btn" data-read>ì½ê¸°</button></div>`;
    el.addEventListener("click", (e)=>{ if(!(e.target.closest("button"))) openStoryModal(sid,s); });
    el.querySelector("[data-read]").onclick=(e)=>{ e.stopPropagation(); openStoryModal(sid,s); };
    box.appendChild(el);
  });
}

/* ================== STORIES ================== */
async function loadSeriesTabs(){
  $("series-tabs").innerHTML=""; $("series-desc").textContent="";
  const tabs=$("series-tabs");

  const all=document.createElement("button");
  all.className="tab"; all.textContent="ì „ì²´";
  all.onclick=()=>{ currentSeries="ALL"; highlightTabs(); $("series-desc").textContent="ëª¨ë“  ì‹œë¦¬ì¦ˆì˜ ì±…"; loadStories(); };
  tabs.appendChild(all);

  const snap=await db.collection("series").orderBy("created","desc").get();
  if(snap.empty){ $("series-desc").textContent="ì‹œë¦¬ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤."; }
  else{
    snap.forEach(doc=>{
      const s=doc.data();
      const b=document.createElement("button");
      b.className="tab"; b.textContent=s.name; b.dataset.sid=doc.id;
      b.onclick=()=>{ currentSeries=doc.id; highlightTabs(); $("series-desc").textContent=s.desc||""; loadStories(); };
      tabs.appendChild(b);
    });
  }
  currentSeries="ALL"; highlightTabs(); $("series-desc").textContent="ëª¨ë“  ì‹œë¦¬ì¦ˆì˜ ì±…"; loadStories();
}
function highlightTabs(){
  $$(".tab").forEach(t=>{
    const active = (currentSeries==="ALL" && t.textContent==="ì „ì²´") || (t.dataset.sid===currentSeries);
    t.classList.toggle("active", active);
  });
}
async function loadStories(){
  const list=$("story-list"); list.innerHTML="";
  $("story-loading").style.display="block";

  let q = db.collection("stories").orderBy("created","desc");
  if(currentSeries && currentSeries!=="ALL") q = q.where("seriesId","==",currentSeries);

  const snap = await q.get();
  $("story-loading").style.display="none";

  if(snap.empty){ list.innerHTML='<div class="mut">ì´ ì‹œë¦¬ì¦ˆì—ëŠ” ì±…ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }

  snap.forEach(doc=>{
    const s=doc.data(); const sid=doc.id; const views=s.views||0;
    const el=document.createElement("div"); el.className="story";
    el.innerHTML = `
      <h4>${esc(s.title)}</h4>
      <p>${esc((s.text||"").slice(0,220)).replace(/\n/g,"<br>")}${(s.text||"").length>220?"â€¦":""}</p>
      <div class="mut">ğŸ‘ï¸ ${views}íšŒ ì¡°íšŒ</div>
      <div class="actions">
        <button class="btn" data-read>ì½ê¸°</button>
        ${isAdmin?'<button class="btn" data-edit>ìˆ˜ì •</button><button class="btn" data-del>ì‚­ì œ</button>':""}
      </div>`;
    // ì¹´ë“œ í´ë¦­ìœ¼ë¡œ ì—´ê¸°
    el.addEventListener("click",(e)=>{ if(!(e.target.closest("button"))) openStoryModal(sid,s); });
    el.querySelector("[data-read]").onclick=(e)=>{ e.stopPropagation(); openStoryModal(sid,s); };
    if(isAdmin){
      el.querySelector("[data-edit]").onclick=(e)=>{ e.stopPropagation(); openEditStory(sid,s); };
      el.querySelector("[data-del]").onclick=async(e)=>{
        e.stopPropagation();
        if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
        await db.collection("stories").doc(sid).delete();
        toast("ì‚­ì œë¨"); loadStories(); renderAdmin();
      };
    }
    list.appendChild(el);
  });
}

/* ì±… ëª¨ë‹¬ + ì¡°íšŒìˆ˜ ì¦ê°€(í•˜ë£¨ 1íšŒ) + í€´ì¦ˆ ë²„íŠ¼ ë…¸ì¶œ */
async function openStoryModal(sid, s){
  const readKey = `read_${sid}`;
  const today = new Date().toDateString();
  const last = localStorage.getItem(readKey);
  if(last !== today){
    localStorage.setItem(readKey, today);
    await db.collection("stories").doc(sid).set({views: firebase.firestore.FieldValue.increment(1)}, {merge:true});
  }
  // í€´ì¦ˆ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
  const qsnap = await db.collection("quizzes").where("storyId","==",sid).limit(1).get();
  const hasQuiz = !qsnap.empty;

  openModal(
    s.title,
    `<div style="white-space:pre-wrap;line-height:1.7;font-size:15px">${esc(s.text||"").replace(/\n/g,"<br>")}</div>`,
    {quizFor: hasQuiz? sid : null}
  );
}

/* ================== NEXT (Proposals) ================== */
async function loadNext(){
  $("next-form").onsubmit = async (e)=>{
    e.preventDefault();
    const author=$("nx-author").value.trim();
    const title=$("nx-title").value.trim();
    const text=$("nx-text").value.trim();
    if(!author||!title||!text) return;
    await db.collection("nextProposals").add({author,title,text,status:"pending",created:new Date()});
    $("nx-title").value=""; $("nx-text").value="";
    toast("ì œì•ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!"); renderNextList(); if(isAdmin) renderAdminNext();
  };
  renderNextList();
}
async function renderNextList(){
  $("next-list").innerHTML=""; $("next-loading").style.display="block";
  const snap=await db.collection("nextProposals").orderBy("created","desc").limit(50).get();
  $("next-loading").style.display="none";
  if(snap.empty){ $("next-list").innerHTML='<div class="mut">ì•„ì§ ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  snap.forEach(doc=>{
    const p=doc.data();
    const el=document.createElement("div"); el.className="story";
    el.innerHTML=`
      <div class="badge">${p.status==="pending"?"ëŒ€ê¸°ì¤‘":p.status==="approved"?"ìŠ¹ì¸ë¨":"ê±°ì ˆë¨"}</div>
      <h4>${esc(p.title)}</h4>
      <p>${esc(p.text).replace(/\n/g,"<br>")}</p>
      <div class="mut">${esc(p.author||"ìµëª…")} â€¢ ${formatDate(p.created)}</div>
      ${isAdmin?`<div class="actions">
        <button class="btn" data-approve>ìŠ¹ì¸</button>
        <button class="btn" data-reject>ê±°ì ˆ</button>
        <button class="btn" data-del>ì‚­ì œ</button>
      </div>`:""}
    `;
    if(isAdmin){
      el.querySelector("[data-approve]").onclick=()=>approveProposal(doc.id,p);
      el.querySelector("[data-reject]").onclick=async()=>{ await db.collection("nextProposals").doc(doc.id).update({status:"rejected"}); toast("ê±°ì ˆ ì²˜ë¦¬"); renderNextList(); renderAdminNext(); };
      el.querySelector("[data-del]").onclick=async()=>{ if(!confirm("ì œì•ˆì„ ì‚­ì œí• ê¹Œìš”?")) return; await db.collection("nextProposals").doc(doc.id).delete(); toast("ì‚­ì œë¨"); renderNextList(); renderAdminNext(); };
    }
    $("next-list").appendChild(el);
  });
}
async function approveProposal(id,p){
  const sSnap=await db.collection("series").orderBy("created","desc").get();
  if(sSnap.empty) return alert("ë¨¼ì € ì‹œë¦¬ì¦ˆë¥¼ í•˜ë‚˜ ë§Œë“¤ì–´ì£¼ì„¸ìš”.");
  const opts=['<option value="">ì‹œë¦¬ì¦ˆ ì„ íƒ</option>']; sSnap.forEach(d=>opts.push(`<option value="${d.id}">${esc(d.data().name)}</option>`));
  openModal("ì œì•ˆ ìŠ¹ì¸ â†’ ì±…ìœ¼ë¡œ ë“±ë¡", `
    <form id="apprForm" class="grid">
      <select id="ap-series" required>${opts.join("")}</select>
      <input id="ap-title" value="${esc(p.title)}" required>
      <textarea id="ap-text" rows="6">${esc(p.text||"")}</textarea>
      <div class="row" style="justify-content:flex-end">
        <button class="btn" type="button" id="ap-cancel">ì·¨ì†Œ</button>
        <button class="btn pri" type="submit">ì±…ìœ¼ë¡œ ë“±ë¡</button>
      </div>
    </form>
  `);
  $("ap-cancel").onclick=()=>$("modal").classList.remove("on");
  $("apprForm").onsubmit=async e=>{
    e.preventDefault();
    const seriesId=$("ap-series").value; const title=$("ap-title").value.trim(); const text=$("ap-text").value;
    if(!seriesId||!title) return;
    await db.collection("stories").add({seriesId,title,text,created:new Date(),views:0});
    await db.collection("nextProposals").doc(id).update({status:"approved"});
    toast("ìŠ¹ì¸ & ì±…ìœ¼ë¡œ ë“±ë¡ë¨");
    $("modal").classList.remove("on");
    loadStories(); renderNextList(); if(isAdmin) renderAdmin(); if(isAdmin) renderAdminNext();
  };
}

/* ================== GROUPS ================== */
async function loadGroups(){
  const list=$("group-list"); list.innerHTML="";
  $("group-box").style.display="none";
  const snap=await db.collection("groups").orderBy("created","desc").get();
  if(snap.empty){ list.innerHTML='<div class="mut">ì•„ì§ ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  snap.forEach(doc=>{
    const g=doc.data();
    const el=document.createElement("div"); el.className="story";
    el.innerHTML = `
      <h4>${esc(g.name)}</h4>
      <p>${esc(g.desc||"")}</p>
      <div class="actions">
        <button class="btn pri" data-open>ë“¤ì–´ê°€ê¸°</button>
        ${isAdmin?'<button class="btn" data-edit>ìˆ˜ì •</button><button class="btn" data-del>ì‚­ì œ</button>':""}
      </div>`;
    el.querySelector("[data-open]").onclick=()=>openGroup(doc.id,g);
    if(isAdmin){
      el.querySelector("[data-edit]").onclick=()=>openEditGroup(doc.id,g);
      el.querySelector("[data-del]").onclick=async()=>{ if(!confirm("ê·¸ë£¹ì„ ì‚­ì œí• ê¹Œìš”?")) return; await db.collection("groups").doc(doc.id).delete(); toast("ì‚­ì œë¨"); loadGroups(); renderAdmin(); };
    }
    list.appendChild(el);
  });
}
async function openGroup(id,g){
  currentGroup={id,...g};
  $("group-box").style.display="block";
  $("group-title").textContent = g.name;
  $("group-desc").textContent = g.desc || "";
  $("group-admin-actions").style.display = isAdmin ? "flex" : "none";
  $("btnEditGroup").onclick = ()=>openEditGroup(id,g);
  $("btnDeleteGroup").onclick = async ()=>{ if(!confirm("ê·¸ë£¹ì„ ì‚­ì œí• ê¹Œìš”?")) return; await db.collection("groups").doc(id).delete(); toast("ì‚­ì œë¨"); $("group-box").style.display="none"; loadGroups(); renderAdmin(); };

  const form=$("group-post-form");
  form.onsubmit = async (e)=>{
    e.preventDefault();
    const author=$("gp-author").value.trim();
    const title=$("gp-title").value.trim();
    const text=$("gp-text").value.trim();
    if(!author||!title||!text) return;
    await db.collection("groupPosts").add({groupId:id, author, title, text, pinned:false, created:new Date()});
    $("gp-text").value=""; $("gp-title").value="";
    toast("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!"); loadGroupPosts(id);
  };
  loadGroupPosts(id);
}
async function loadGroupPosts(groupId){
  $("group-posts").innerHTML=""; $("group-posts-loading").style.display="block";
  const snap=await db.collection("groupPosts").where("groupId","==",groupId).orderBy("created","desc").limit(50).get();
  $("group-posts-loading").style.display="none";
  if(snap.empty){ $("group-posts").innerHTML='<div class="mut">ì•„ì§ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  const posts=[]; snap.forEach(d=>posts.push({id:d.id,...d.data()}));
  posts.sort((a,b)=>((b.pinned?1:0)-(a.pinned?1:0)) || (getMs(b.created)-getMs(a.created)));
  posts.forEach(p=>{
    const el=document.createElement("div"); el.className="story";
    el.innerHTML=`
      <div class="badge">${p.pinned?'ğŸ“Œ ê³ ì •':''}</div>
      <h4>${esc(p.title)}</h4>
      <p>${esc(p.text).replace(/\n/g,"<br>")}</p>
      <div class="mut">${esc(p.author||"ìµëª…")} â€¢ ${formatDate(p.created)}</div>
      <div class="actions">
        ${isAdmin?`
          <button class="btn" data-pin>${p.pinned?'ê³ ì • í•´ì œ':'ê³ ì •'}</button>
          <button class="btn" data-edit>ìˆ˜ì •</button>
          <button class="btn" data-del>ì‚­ì œ</button>
        `:''}
      </div>
    `;
    if(isAdmin){
      el.querySelector("[data-pin]").onclick=async()=>{ await db.collection("groupPosts").doc(p.id).update({pinned:!p.pinned}); loadGroupPosts(groupId); };
      el.querySelector("[data-edit]").onclick=()=>openEditPost(p.id,p);
      el.querySelector("[data-del]").onclick=async()=>{ if(!confirm("ê²Œì‹œê¸€ì„ ì‚­ì œí• ê¹Œìš”?")) return; await db.collection("groupPosts").doc(p.id).delete(); toast("ì‚­ì œë¨"); loadGroupPosts(groupId); };
    }
    $("group-posts").appendChild(el);
  });
}
function openEditGroup(id,g){
  openModal("ê·¸ë£¹ ìˆ˜ì •", `
    <form id="formGroupEdit" class="grid">
      <input id="gp-name-e" value="${esc(g.name||"")}" required>
      <input id="gp-desc-e" value="${esc(g.desc||"")}">
      <div class="row" style="justify-content:flex-end"><button class="btn pri" type="submit">ì €ì¥</button></div>
    </form>
  `);
  $("formGroupEdit").onsubmit=async e=>{
    e.preventDefault();
    const name=$("gp-name-e").value.trim(); const desc=$("gp-desc-e").value.trim();
    if(!name) return;
    await db.collection("groups").doc(id).update({name,desc});
    toast("ìˆ˜ì •ë¨"); $("modal").classList.remove("on"); loadGroups(); renderAdmin();
  };
}
function openEditPost(id,p){
  openModal("ê²Œì‹œê¸€ ìˆ˜ì •", `
    <form id="formPostEdit" class="grid">
      <input id="pe-title" value="${esc(p.title||"")}" required>
      <textarea id="pe-text" rows="6">${esc(p.text||"")}</textarea>
      <label class="row"><input id="pe-pin" type="checkbox" ${p.pinned?'checked':''} style="width:auto"><span>ìƒë‹¨ ê³ ì •</span></label>
      <div class="row" style="justify-content:flex-end"><button class="btn pri" type="submit">ì €ì¥</button></div>
    </form>
  `);
  $("formPostEdit").onsubmit=async e=>{
    e.preventDefault();
    const title=$("pe-title").value.trim(); const text=$("pe-text").value; const pinned=$("pe-pin").checked;
    if(!title) return;
    await db.collection("groupPosts").doc(id).update({title,text,pinned});
    toast("ìˆ˜ì •ë¨"); $("modal").classList.remove("on"); loadGroupPosts(currentGroup.id);
  };
}

/* ================== ë¦¬ë”ë³´ë“œ/í”„ë¡œí•„/í¬ì¸íŠ¸ ================== */
async function ensureProfile(){
  const ref = db.collection("userProfiles").doc(deviceId);
  const doc = await ref.get();
  if(!doc.exists){ await ref.set({deviceId, name:"ìµëª…", points:0, created:new Date()}); }
  return (await ref.get()).data();
}
async function loadLeaderboard(){
  const box=$("leaderboard-list"); box.innerHTML="";
  const snap=await db.collection("userProfiles").orderBy("points","desc").limit(10).get();
  if(snap.empty){ box.innerHTML='<div class="mut">ì•„ì§ ë¦¬ë”ë³´ë“œê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</div>'; return; }
  let rank=1;
  snap.forEach(d=>{
    const u=d.data();
    const card=document.createElement("div"); card.className="story";
    card.innerHTML=`<h4>${rank}. ${esc(u.name||"ìµëª…")}</h4><p class="mut">í¬ì¸íŠ¸: ${u.points||0}</p>`;
    box.appendChild(card); rank++;
  });
}
async function loadProfile(){
  const u = await ensureProfile();
  $("prof-name").value = u.name || "";
  $("profile-box").innerHTML = `ë‚˜ì˜ í¬ì¸íŠ¸: <b>${u.points||0}</b>`;
}
$("btnSaveName").onclick = async ()=>{
  const name = $("prof-name").value.trim() || "ìµëª…";
  await db.collection("userProfiles").doc(deviceId).set({name},{merge:true});
  toast("ë‹‰ë„¤ì„ ì €ì¥"); loadProfile(); loadLeaderboard();
};

/* ================== í€´ì¦ˆ ================== */
/* í€´ì¦ˆ í’€ê¸° UI ì—´ê¸° */
async function openQuiz(storyId, storyTitle){
  // í€´ì¦ˆ ë¶ˆëŸ¬ì˜¤ê¸°
  const qsnap = await db.collection("quizzes").where("storyId","==",storyId).limit(1).get();
  if(qsnap.empty){ alert("ë“±ë¡ëœ í€´ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
  const qdoc = qsnap.docs[0]; const quiz = qdoc.data();

  // ë¬¸í•­ ë Œë”
  const html = `
    <div class="grid">
      <div class="mut">ìŠ¤í† ë¦¬: ${esc(storyTitle)}</div>
      <h3>í€´ì¦ˆ: ${esc(quiz.title||"")}</h3>
      <form id="quizForm" class="grid">
        ${quiz.questions.map((qq,idx)=>`
          <div class="card" style="background:#0e172a;border:1px dashed var(--line)">
            <div><b>Q${idx+1}.</b> ${esc(qq.q)}</div>
            <div class="grid" style="margin-top:8px">
              ${qq.options.map((op,i)=>`
                <label class="row" style="gap:10px">
                  <input type="radio" name="q${idx}" value="${i}" required style="width:auto">
                  <span>${esc(op)}</span>
                </label>
              `).join("")}
            </div>
            <div class="mut" style="margin-top:6px">ë°°ì : ${qq.points||1}ì </div>
          </div>
        `).join("")}
        <div class="row" style="justify-content:flex-end">
          <button class="btn pri" type="submit">ì œì¶œ</button>
        </div>
      </form>
    </div>
  `;
  openModal("í€´ì¦ˆ", html);

  $("quizForm").onsubmit = async (e)=>{
    e.preventDefault();
    // ì±„ì 
    let score=0, total=0;
    quiz.questions.forEach((qq,idx)=>{
      const v = (new FormData(e.target)).get("q"+idx);
      const ans = Number(v);
      total += (qq.points||1);
      if(ans===qq.answerIndex) score += (qq.points||1);
    });
    // í¬ì¸íŠ¸ ì ë¦½
    await ensureProfile();
    await db.collection("userProfiles").doc(deviceId).set({
      points: firebase.firestore.FieldValue.increment(score)
    }, {merge:true});
    await db.collection("quizAttempts").add({deviceId, storyId, score, created:new Date()});

    // ê²°ê³¼ í‘œì‹œ
    $("modal-body").innerHTML = `
      <div class="card" style="text-align:center">
        <h3>ê²°ê³¼</h3>
        <p>íšë“ ì ìˆ˜: <b>${score}</b> / ${total}</p>
        <div class="row" style="justify-content:center;margin-top:10px">
          <button class="btn" onclick="document.getElementById('modal').classList.remove('on');">ë‹«ê¸°</button>
          <button class="btn pri" onclick="(function(){ document.getElementById('modal').classList.remove('on'); show('leaderboard'); loadLeaderboard(); })()">ë¦¬ë”ë³´ë“œ ë³´ê¸°</button>
        </div>
      </div>
    `;
    loadProfile(); loadLeaderboard();
  };
}

/* ================== ADMIN ================== */
$("btnAdminLogin").onclick=()=>{
  if($("admin-pass").value===ADMIN_PASSWORD){
    isAdmin=true; $("admin-login").style.display="none"; $("admin-panel").style.display="block"; toast("ê´€ë¦¬ì ë¡œê·¸ì¸ ì™„ë£Œ"); renderAdmin();
  }else alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
};
function renderAdmin(){ loadAdminSeries(); loadAdminStories(); loadAdminGroups(); renderAdminNext(); renderAdminQuizList(); }

/* ---- ì‹œë¦¬ì¦ˆ CRUD ---- */
$("openSeries").onclick=()=>{
  openModal("ì‹œë¦¬ì¦ˆ ì¶”ê°€", `
    <form id="formSeries" class="grid">
      <input id="se-name" placeholder="ì‹œë¦¬ì¦ˆ ì´ë¦„" required>
      <input id="se-desc" placeholder="ì„¤ëª… (ì„ íƒ)">
      <div class="row" style="justify-content:flex-end"><button class="btn pri" type="submit">ì¶”ê°€</button></div>
    </form>
  `);
  $("formSeries").onsubmit=async e=>{
    e.preventDefault();
    const name=$("se-name").value.trim(), desc=$("se-desc").value.trim();
    if(!name) return;
    await db.collection("series").add({name,desc,created:new Date()});
    toast("ì‹œë¦¬ì¦ˆ ì¶”ê°€ë¨"); $("modal").classList.remove("on"); loadSeriesTabs(); renderAdmin();
  };
};
async function loadAdminSeries(){
  const box=$("admin-series"); box.innerHTML="";
  const snap=await db.collection("series").orderBy("created","desc").get();
  if(snap.empty){ box.innerHTML='<div class="mut">ì‹œë¦¬ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  snap.forEach(doc=>{
    const s=doc.data();
    const el=document.createElement("div"); el.className="story";
    el.innerHTML = `<h4>${esc(s.name)}</h4><p>${esc(s.desc||"")}</p>
      <div class="actions"><button class="btn" data-edit>ìˆ˜ì •</button><button class="btn" data-del>ì‚­ì œ</button></div>`;
    el.querySelector("[data-edit]").onclick=()=>openEditSeries(doc.id,s);
    el.querySelector("[data-del]").onclick=async()=>{ if(!confirm("ì‹œë¦¬ì¦ˆ ì‚­ì œ? (ì±…ì€ ë‚¨ìŠµë‹ˆë‹¤)")) return; await db.collection("series").doc(doc.id).delete(); toast("ì‚­ì œë¨"); loadSeriesTabs(); renderAdmin(); };
    box.appendChild(el);
  });
}
function openEditSeries(id,s){
  openModal("ì‹œë¦¬ì¦ˆ ìˆ˜ì •", `
    <form id="formSeriesEdit" class="grid">
      <input id="se-name-e" value="${esc(s.name)}" required>
      <input id="se-desc-e" value="${esc(s.desc||"")}">
      <div class="row" style="justify-content:flex-end"><button class="btn pri" type="submit">ì €ì¥</button></div>
    </form>
  `);
  $("formSeriesEdit").onsubmit=async e=>{
    e.preventDefault();
    const name=$("se-name-e").value.trim(); const desc=$("se-desc-e").value.trim();
    if(!name) return;
    await db.collection("series").doc(id).update({name,desc});
    toast("ìˆ˜ì •ë¨"); $("modal").classList.remove("on"); loadSeriesTabs(); renderAdmin();
  };
}

/* ---- ì±… CRUD ---- */
$("openStory").onclick=async()=>{
  const snap=await db.collection("series").orderBy("created","desc").get();
  if(snap.empty) return alert("ì‹œë¦¬ì¦ˆë¥¼ ë¨¼ì € ë§Œë“¤ì–´ì£¼ì„¸ìš”.");
  const opts = ['<option value="">(ì‹œë¦¬ì¦ˆ ì„ íƒ)</option>']; snap.forEach(d=>opts.push(`<option value="${d.id}">${esc(d.data().name)}</option>`));
  openModal("ì±… ì¶”ê°€", `
    <form id="formStory" class="grid">
      <select id="st-series" required>${opts.join("")}</select>
      <input id="st-title" placeholder="ì±… ì œëª©" required>
      <textarea id="st-text" rows="6" placeholder="ë³¸ë¬¸ (ì„ íƒ)"></textarea>
      <div class="row" style="justify-content:flex-end"><button class="btn pri" type="submit">ì¶”ê°€</button></div>
    </form>
  `);
  $("formStory").onsubmit=async e=>{
    e.preventDefault();
    const seriesId=$("st-series").value; const title=$("st-title").value.trim(); const text=$("st-text").value;
    if(!seriesId || !title) return;
    await db.collection("stories").add({seriesId,title,text,created:new Date(),views:0});
    toast("ì±… ì¶”ê°€ë¨"); $("modal").classList.remove("on"); loadStories(); renderAdmin();
  };
};
async function loadAdminStories(){
  const box=$("admin-stories"); box.innerHTML="";
  const map=await getSeriesMap();
  const snap=await db.collection("stories").orderBy("created","desc").get();
  if(snap.empty){ box.innerHTML='<div class="mut">ì±…ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  snap.forEach(doc=>{
    const s=doc.data(); const sid=doc.id; const views=s.views||0;
    const el=document.createElement("div"); el.className="story";
    el.innerHTML = `<div class="mut">${esc(map[s.seriesId]||"ì‹œë¦¬ì¦ˆ ë¯¸ì§€ì •")} â€¢ ğŸ‘ï¸ ${views}íšŒ</div>
      <h4>${esc(s.title)}</h4>
      <div class="actions">
        <button class="btn" data-edit>ìˆ˜ì •</button>
        <button class="btn" data-del>ì‚­ì œ</button>
      </div>`;
    el.querySelector("[data-edit]").onclick=()=>openEditStory(sid,s);
    el.querySelector("[data-del]").onclick=async()=>{ if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return; await db.collection("stories").doc(sid).delete(); toast("ì‚­ì œë¨"); loadStories(); renderAdmin(); };
    box.appendChild(el);
  });
}
function openEditStory(id,s){
  openModal("ì±… ìˆ˜ì •", `
    <form id="formStoryEdit" class="grid">
      <input id="ed-title" value="${esc(s.title||"")}" required>
      <textarea id="ed-text" rows="6">${esc(s.text||"")}</textarea>
      <div class="row" style="justify-content:flex-end"><button class="btn pri" type="submit">ì €ì¥</button></div>
    </form>
  `);
  $("formStoryEdit").onsubmit=async e=>{
    e.preventDefault();
    const title=$("ed-title").value.trim(); const text=$("ed-text").value;
    if(!title) return;
    await db.collection("stories").doc(id).update({title,text});
    toast("ìˆ˜ì •ë¨"); $("modal").classList.remove("on"); loadStories(); renderAdmin();
  };
}

/* ---- Admin: â€˜ë‹¤ìŒ ì´ì•¼ê¸°â€™ ì œì•ˆ ê´€ë¦¬ ---- */
async function renderAdminNext(){
  const box=$("admin-next"); if(!box) return; box.innerHTML="";
  const snap=await db.collection("nextProposals").orderBy("created","desc").limit(50).get();
  if(snap.empty){ box.innerHTML='<div class="mut">ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  const seriesSnap=await db.collection("series").get();
  const sOpts=['<option value="">ì‹œë¦¬ì¦ˆ ì„ íƒ</option>']; seriesSnap.forEach(d=>sOpts.push(`<option value="${d.id}">${esc(d.data().name)}</option>`));
  snap.forEach(doc=>{
    const p=doc.data();
    const row=document.createElement("div"); row.className="story";
    row.innerHTML=`
      <div class="badge">${esc(p.status)}</div>
      <h4>${esc(p.title)}</h4>
      <p>${esc((p.text||"").slice(0,200))}${(p.text||"").length>200?'â€¦':''}</p>
      <div class="mut">${esc(p.author||"ìµëª…")} â€¢ ${formatDate(p.created)}</div>
      <div class="actions">
        <select class="ad-series">${sOpts.join("")}</select>
        <button class="btn" data-approve>ìŠ¹ì¸â†’ì±… ë“±ë¡</button>
        <button class="btn" data-reject>ê±°ì ˆ</button>
        <button class="btn" data-del>ì‚­ì œ</button>
      </div>
    `;
    const sel=row.querySelector(".ad-series");
    row.querySelector("[data-approve]").onclick=async()=>{
      const sid=sel.value; if(!sid) return alert("ì‹œë¦¬ì¦ˆë¥¼ ì„ íƒí•˜ì„¸ìš”.");
      await db.collection("stories").add({seriesId:sid,title:p.title,text:p.text,created:new Date(),views:0});
      await db.collection("nextProposals").doc(doc.id).update({status:"approved"});
      toast("ìŠ¹ì¸ë¨"); renderAdminNext(); loadStories();
    };
    row.querySelector("[data-reject]").onclick=async()=>{ await db.collection("nextProposals").doc(doc.id).update({status:"rejected"}); toast("ê±°ì ˆë¨"); renderAdminNext(); renderNextList(); };
    row.querySelector("[data-del]").onclick=async()=>{ if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return; await db.collection("nextProposals").doc(doc.id).delete(); toast("ì‚­ì œë¨"); renderAdminNext(); renderNextList(); };
    box.appendChild(row);
  });
}

/* ---- Admin: í€´ì¦ˆ ê´€ë¦¬ ---- */
$("openQuizAdmin").onclick = async ()=>{
  // ìŠ¤í† ë¦¬ ëª©ë¡
  const snap=await db.collection("stories").orderBy("created","desc").limit(200).get();
  if(snap.empty){ alert("ë¨¼ì € ì±…ì„ ì¶”ê°€í•˜ì„¸ìš”."); return; }
  const opts = ['<option value="">(ì±… ì„ íƒ)</option>'];
  snap.forEach(d=>opts.push(`<option value="${d.id}">${esc(d.data().title)}</option>`));

  openModal("í€´ì¦ˆ ì¶”ê°€", `
    <form id="quizNewForm" class="grid">
      <select id="q-story" required>${opts.join("")}</select>
      <input id="q-title" placeholder="í€´ì¦ˆ ì œëª©" required>
      <div id="q-questions" class="grid"></div>
      <div class="row" style="justify-content:space-between">
        <button class="btn" type="button" id="q-add">+ ë¬¸í•­ ì¶”ê°€</button>
        <button class="btn pri" type="submit">ì €ì¥</button>
      </div>
    </form>
  `);

  const qWrap = $("q-questions");
  function addQuestion(){
    const idx = qWrap.children.length+1;
    const box = document.createElement("div");
    box.className="card";
    box.style.background="#0e172a"; box.style.border="1px dashed var(--line)";
    box.innerHTML = `
      <div class="grid">
        <input placeholder="ë¬¸í•­ ${idx}: ì§ˆë¬¸" class="q-q">
        <input placeholder="ì„ ì§€ 1" class="q-o">
        <input placeholder="ì„ ì§€ 2" class="q-o">
        <input placeholder="ì„ ì§€ 3" class="q-o">
        <input placeholder="ì„ ì§€ 4" class="q-o">
        <div class="row">
          <select class="q-ans">
            <option value="0">ì •ë‹µ: 1</option>
            <option value="1">ì •ë‹µ: 2</option>
            <option value="2">ì •ë‹µ: 3</option>
            <option value="3">ì •ë‹µ: 4</option>
          </select>
          <input type="number" min="1" value="1" class="q-point" style="max-width:120px" placeholder="ë°°ì ">
          <button class="btn" type="button" onclick="this.closest('.card').remove()">ì‚­ì œ</button>
        </div>
      </div>
    `;
    qWrap.appendChild(box);
  }
  $("q-add").onclick = addQuestion; addQuestion();

  $("quizNewForm").onsubmit = async (e)=>{
    e.preventDefault();
    const storyId = $("q-story").value; const title=$("q-title").value.trim();
    if(!storyId || !title) return;

    const questions=[];
    qWrap.querySelectorAll(".card").forEach(card=>{
      const q = card.querySelector(".q-q").value.trim();
      const ops = Array.from(card.querySelectorAll(".q-o")).map(i=>i.value.trim()).filter(Boolean);
      const ans = Number(card.querySelector(".q-ans").value);
      const pt = Number(card.querySelector(".q-point").value)||1;
      if(q && ops.length===4) questions.push({q,options:ops,answerIndex:ans,points:pt});
    });
    if(!questions.length) return alert("ìµœì†Œ 1ë¬¸í•­ ì´ìƒ ì…ë ¥í•˜ì„¸ìš”.");

    // ê¸°ì¡´ í€´ì¦ˆ ë®ì–´ì“°ê¸° ì „ëµ: storyIdë¡œ ì¡´ì¬í•˜ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
    const ex=await db.collection("quizzes").where("storyId","==",storyId).limit(1).get();
    if(!ex.empty) await db.collection("quizzes").doc(ex.docs[0].id).set({storyId,title,questions,updated:new Date()},{merge:true});
    else await db.collection("quizzes").add({storyId,title,questions,created:new Date()});

    toast("í€´ì¦ˆ ì €ì¥ ì™„ë£Œ"); $("modal").classList.remove("on"); renderAdminQuizList();
  };
};
/* í€´ì¦ˆ ëª©ë¡(ê´€ë¦¬ì) */
async function renderAdminQuizList(){
  const box=$("admin-quizzes"); box.innerHTML="";
  const snap=await db.collection("quizzes").orderBy("created","desc").limit(100).get().catch(()=>({empty:true}));
  if(!snap || snap.empty){ box.innerHTML='<div class="mut">ë“±ë¡ëœ í€´ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  const storyMap = {};
  const stories = await db.collection("stories").get();
  stories.forEach(d=>storyMap[d.id]=d.data().title);

  snap.forEach(d=>{
    const q=d.data();
    const el=document.createElement("div"); el.className="story";
    el.innerHTML=`<h4>${esc(q.title||"(ì œëª© ì—†ìŒ)")}</h4>
      <p class="mut">ëŒ€ìƒ ì±…: ${esc(storyMap[q.storyId]||q.storyId)} â€¢ ë¬¸í•­ìˆ˜: ${q.questions?.length||0}</p>
      <div class="actions">
        <button class="btn" data-del>ì‚­ì œ</button>
      </div>`;
    el.querySelector("[data-del]").onclick=async()=>{ if(!confirm("í€´ì¦ˆë¥¼ ì‚­ì œí• ê¹Œìš”?")) return; await db.collection("quizzes").doc(d.id).delete(); toast("ì‚­ì œë¨"); renderAdminQuizList(); };
    box.appendChild(el);
  });
}

/* ================== Helpers ================== */
async function getSeriesMap(){ const map={}; const s=await db.collection("series").get(); s.forEach(d=>map[d.id]=d.data().name); return map; }

/* ================== Init ================== */
window.addEventListener("load",async()=>{
  show("home");
  await ensureProfile();
  loadHome();
  loadSeriesTabs();
  loadNext();
  loadGroups();
  loadLeaderboard();
  loadProfile();
});
</script>
</body>
</html>
