<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ì—°í˜¸ì˜ ìŠ¤í† ë¦¬ë¶ ì»¤ë®¤ë‹ˆí‹°</title>
<style>
:root{
  --bg:#0b0e12;--surface:#0f141a;--panel:#11161c;--line:#1f2937;
  --text:#e7ecf2;--muted:#9aa4b2;--primary:#2563eb;--primary-2:#1d4ed8;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Noto Sans KR,sans-serif}
header{background:var(--panel);border-bottom:1px solid var(--line);padding:12px}
.container{max-width:1000px;margin:0 auto;padding:0 16px}
.top{display:flex;gap:10px;align-items:center;justify-content:space-between}
.brand{font-weight:900}
nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.btn{background:var(--surface);border:1px solid var(--line);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
.btn:hover{border-color:var(--primary)}
.btn.primary{background:var(--primary);border-color:var(--primary);color:white}
.btn.primary:hover{background:var(--primary-2)}
main{padding:20px 0}
.section{display:none}
.section.show{display:block}
.card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px;margin:12px 0}
h2,h3{margin:.2em 0 .6em}
input,textarea,select{width:100%;background:var(--surface);border:1px solid var(--line);color:var(--text);padding:10px;border-radius:10px}
label{font-size:12px;color:var(--muted)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.kbd{border:1px solid var(--line);border-radius:6px;padding:2px 6px;color:var(--muted);font-size:12px}
.badge{border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted);font-size:12px}
.list{display:grid;gap:12px}
hr{border:none;border-top:1px solid var(--line);margin:14px 0}
.toast{position:fixed;right:16px;bottom:16px;background:#111c;backdrop-filter:blur(6px);color:#fff;padding:10px 14px;border-radius:10px}
.empty{color:var(--muted)}
.action{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
</style>
</head>
<body>
<header>
  <div class="container">
    <div class="top">
      <div class="brand">ğŸ“š ì—°í˜¸ì˜ ìŠ¤í† ë¦¬ë¶</div>
      <div class="badge" id="role">ì½ê¸° ì „ìš©</div>
    </div>
    <nav>
      <button class="btn" onclick="show('home')">ğŸ  í™ˆ</button>
      <button class="btn" onclick="show('stories')">ğŸ“– ìŠ¤í† ë¦¬ë¶</button>
      <button class="btn" onclick="show('groups')">ğŸ‘¥ ê·¸ë£¹</button>
      <button class="btn" onclick="show('next')">âœ¨ ë‹¤ìŒ ì´ì•¼ê¸°</button>
      <button class="btn" onclick="show('admin')">âš™ï¸ ê´€ë¦¬ì</button>
    </nav>
  </div>
</header>

<main class="container">

  <!-- í™ˆ -->
  <section id="home" class="section show">
    <div class="card">
      <h2>í™˜ì˜í•©ë‹ˆë‹¤!</h2>
      <p>ì´ê³³ì€ ê´€ë¦¬ì ìš´ì˜ì˜ <b>ìŠ¤í† ë¦¬ë¶</b>ê³¼ ì°¸ì—¬í˜• <b>ì»¤ë®¤ë‹ˆí‹°</b>ê°€ í•¨ê»˜ ìˆëŠ” ê³µê°„ì…ë‹ˆë‹¤.</p>
      <div class="row">
        <button class="btn primary" onclick="show('stories')">ìŠ¤í† ë¦¬ë¶ ë³´ëŸ¬ê°€ê¸°</button>
        <button class="btn" onclick="show('groups')">ê·¸ë£¹ìœ¼ë¡œ ê°€ê¸°</button>
        <button class="btn" onclick="show('next')">ë‹¤ìŒ ì´ì•¼ê¸° ì œì•ˆ</button>
      </div>
    </div>
    <div class="card">
      <h3>ì¸ê¸° ìŠ¤í† ë¦¬</h3>
      <div id="home-stories" class="list"></div>
    </div>
  </section>

  <!-- ìŠ¤í† ë¦¬ë¶ -->
  <section id="stories" class="section">
    <div class="row" style="justify-content:space-between">
      <h2>ìŠ¤í† ë¦¬ë¶</h2>
      <span class="kbd">ê´€ë¦¬ì: ìŠ¤í† ë¦¬ ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥</span>
    </div>
    <div id="story-list" class="list"></div>
  </section>

  <!-- ê·¸ë£¹ -->
  <section id="groups" class="section">
    <div class="row" style="justify-content:space-between">
      <h2>ê·¸ë£¹</h2>
      <span class="kbd">ëˆ„êµ¬ë‚˜ ê¸€ ì‘ì„± ê°€ëŠ¥ (ê´€ë¦¬ì ìƒì„± ê·¸ë£¹)</span>
    </div>

    <div id="group-list" class="list"></div>

    <div class="card" id="group-post-box" style="display:none">
      <h3 id="group-title">ê·¸ë£¹</h3>
      <form id="group-post-form">
        <div class="row">
          <input id="gp-name" placeholder="ë‹‰ë„¤ì„" required style="max-width:240px">
          <button class="btn" type="submit">ê¸€ ì˜¬ë¦¬ê¸°</button>
        </div>
        <textarea id="gp-text" rows="4" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" required></textarea>
      </form>
      <h4>ìµœê·¼ ê¸€</h4>
      <div id="group-posts" class="list"></div>
    </div>
  </section>

  <!-- ë‹¤ìŒ ì´ì•¼ê¸° -->
  <section id="next" class="section">
    <h2>ë‹¤ìŒ ì´ì•¼ê¸°ëŠ” ë¬´ì—‡ì¼ê¹Œ?</h2>
    <form id="suggest-form" class="card">
      <div class="row">
        <input id="sg-name" placeholder="ë‹‰ë„¤ì„" required style="max-width:240px">
        <button class="btn" type="submit">ì œì•ˆ ì˜¬ë¦¬ê¸°</button>
      </div>
      <textarea id="sg-text" rows="5" placeholder="ë‹¤ìŒ ì´ì•¼ê¸°ë¥¼ ì œì•ˆí•´ì£¼ì„¸ìš”â€¦" required></textarea>
    </form>
    <div class="card">
      <h3>ìµœê·¼ ì œì•ˆ</h3>
      <div id="suggestions" class="list"></div>
    </div>
  </section>

  <!-- ê´€ë¦¬ì -->
  <section id="admin" class="section">
    <div id="admin-login" class="card">
      <h2>ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
      <div class="row">
        <input id="admin-pass" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" style="max-width:240px">
        <button class="btn primary" onclick="adminLogin()">ë¡œê·¸ì¸</button>
      </div>
      <p class="empty">ë¡œê·¸ì¸ í›„ ì•„ë˜ ê´€ë¦¬ íŒ¨ë„ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>
    </div>

    <div id="admin-panel" class="section">
      <!-- ìŠ¤í† ë¦¬ ê´€ë¦¬ -->
      <div class="card">
        <h3>ìŠ¤í† ë¦¬ ê´€ë¦¬</h3>
        <form id="story-add" class="action">
          <input id="st-title" placeholder="ì œëª©" required style="flex:1;min-width:220px">
          <button class="btn" type="submit">ìŠ¤í† ë¦¬ ì¶”ê°€</button>
        </form>
        <textarea id="st-text" rows="5" placeholder="ë³¸ë¬¸(ì„ íƒ). ì œì•ˆ ìŠ¹ì¸ ì‹œ ìë™ ì±„ì›€ ê°€ëŠ¥"></textarea>
        <div id="admin-stories" class="list"></div>
      </div>

      <!-- ì œì•ˆ ìŠ¹ì¸ -->
      <div class="card">
        <h3>ì œì•ˆ ìŠ¹ì¸</h3>
        <div id="admin-suggestions" class="list"></div>
      </div>

      <!-- ê·¸ë£¹ ê´€ë¦¬ -->
      <div class="card">
        <h3>ê·¸ë£¹ ê´€ë¦¬</h3>
        <form id="group-add" class="action">
          <input id="gr-name" placeholder="ê·¸ë£¹ ì´ë¦„" required style="flex:1;min-width:200px">
          <input id="gr-desc" placeholder="ì„¤ëª…" style="flex:2;min-width:260px">
          <button class="btn" type="submit">ê·¸ë£¹ ì¶”ê°€</button>
        </form>
        <div id="admin-groups" class="list"></div>
      </div>
    </div>
  </section>

</main>

<div id="toast" class="toast" style="display:none"></div>

<!-- Firebase SDK (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
/* ============ Firebase ============ */
// ğŸ”‘ ì—¬ê¸° firebaseConfig ì „ì²´ë¥¼ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ê¸°
const firebaseConfig = {
  /* example:
  apiKey: "...",
  authDomain: "storybook-xxxx.firebaseapp.com",
  projectId: "storybook-xxxx",
  storageBucket: "storybook-xxxx.appspot.com",
  messagingSenderId: "....",
  appId: "...."
  */
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ============ App State ============ */
const ADMIN_PASSWORD = "admin1234"; // í•„ìš” ì‹œ ë³€ê²½
let isAdmin = false;
let currentGroup = null;

/* ============ Helpers ============ */
const $ = (id)=>document.getElementById(id);
const toast = (msg)=>{ const t=$("toast"); t.textContent=msg; t.style.display="block"; setTimeout(()=>t.style.display="none",1600) }
function show(id){
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("show"));
  $(id).classList.add("show");
  if(id==="stories"){ loadStories(); }
  if(id==="home"){ loadHomeStories(); }
  if(id==="next"){ loadSuggestions(); }
  if(id==="groups"){ loadGroups(); }
  if(id==="admin"){ if(isAdmin){ $("admin-panel").classList.add("show"); } }
}

/* ============ Home / Stories ============ */
async function loadHomeStories(){
  const box=$("home-stories"); box.innerHTML="";
  const snap=await db.collection("stories").orderBy("created","desc").limit(3).get();
  if(snap.empty){ box.innerHTML='<div class="empty">ì•„ì§ ìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  snap.forEach(doc=>{
    const s=doc.data();
    const el=document.createElement("div");
    el.className="card";
    el.innerHTML=`<h4>${s.title}</h4><p class="empty">${new Date(s.created?.toDate?.()||Date.now()).toLocaleString()}</p>`;
    box.appendChild(el);
  });
}

async function loadStories(){
  const list=$("story-list"); list.innerHTML="";
  const snap=await db.collection("stories").orderBy("created","desc").get();
  if(snap.empty){ list.innerHTML='<div class="empty">ë“±ë¡ëœ ìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  snap.forEach(doc=>{
    const s=doc.data();
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <h3>${s.title}</h3>
      <p>${(s.text||"").replace(/\n/g,"<br>")}</p>
      ${isAdmin?'<div class="action"><button class="btn" data-edit>ìˆ˜ì •</button><button class="btn" data-del>ì‚­ì œ</button></div>':''}
    `;
    if(isAdmin){
      card.querySelector("[data-edit]").onclick=async()=>{
        const nt=prompt("ìƒˆ ì œëª©:", s.title); if(!nt) return;
        const nx=prompt("ë³¸ë¬¸(ë¹ˆì¹¸=ìœ ì§€):", s.text||"");
        await db.collection("stories").doc(doc.id).update({ title:nt, ...(nx!==""?{text:nx}:{}) });
        toast("ìˆ˜ì •ë¨"); loadStories();
      };
      card.querySelector("[data-del]").onclick=async()=>{
        if(!confirm("ì´ ìŠ¤í† ë¦¬ë¥¼ ì‚­ì œí• ê¹Œìš”?"))return;
        await db.collection("stories").doc(doc.id).delete();
        toast("ì‚­ì œë¨"); loadStories();
      };
    }
    list.appendChild(card);
  });
}

/* ============ Suggestions (â€œë‹¤ìŒ ì´ì•¼ê¸°â€) ============ */
$("suggest-form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const name=$("sg-name").value.trim(); const text=$("sg-text").value.trim();
  if(!name||!text) return;
  await db.collection("suggestions").add({name,text,created:new Date()});
  $("sg-name").value=""; $("sg-text").value="";
  toast("ì œì•ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!"); loadSuggestions();
});
async function loadSuggestions(){
  const box=$("suggestions"); box.innerHTML="";
  const snap=await db.collection("suggestions").orderBy("created","desc").get();
  if(snap.empty){ box.innerHTML='<div class="empty">ì•„ì§ ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  snap.forEach(doc=>{
    const d=doc.data();
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`<strong>${d.name}</strong><p>${d.text.replace(/\n/g,"<br>")}</p>`;
    box.appendChild(card);
  });
}

/* ============ Groups ============ */
async function loadGroups(){
  const list=$("group-list"); list.innerHTML="";
  const snap=await db.collection("groups").orderBy("created","desc").get();
  if(snap.empty){ list.innerHTML='<div class="empty">ì•„ì§ ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; $("group-post-box").style.display="none"; return; }
  snap.forEach(doc=>{
    const g=doc.data();
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <div class="row" style="justify-content:space-between">
        <div><h3>${g.name}</h3><div class="empty">${g.desc||""}</div></div>
        <div class="action">
          <button class="btn" data-open>ë“¤ì–´ê°€ê¸°</button>
          ${isAdmin?'<button class="btn" data-del>ì‚­ì œ</button>':""}
        </div>
      </div>
    `;
    card.querySelector("[data-open]").onclick=()=>openGroup(doc.id,g);
    if(isAdmin){
      card.querySelector("[data-del]").onclick=async()=>{
        if(!confirm("ì´ ê·¸ë£¹ì„ ì‚­ì œí• ê¹Œìš”? (ê²Œì‹œê¸€ì€ ìœ ì§€ë©ë‹ˆë‹¤)"))return;
        await db.collection("groups").doc(doc.id).delete();
        toast("ê·¸ë£¹ ì‚­ì œë¨"); loadGroups();
      };
    }
    list.appendChild(card);
  });
}

async function openGroup(id,g){
  currentGroup={id, ...g};
  $("group-title").textContent=`${g.name}`;
  $("group-post-box").style.display="block";
  await loadGroupPosts();
}

$("group-post-form").addEventListener("submit", async (e)=>{
  e.preventDefault(); if(!currentGroup){toast("ë¨¼ì € ê·¸ë£¹ì„ ì„ íƒí•˜ì„¸ìš”"); return;}
  const name=$("gp-name").value.trim(); const text=$("gp-text").value.trim();
  if(!name||!text) return;
  await db.collection("groupPosts").add({groupId:currentGroup.id,name,text,created:new Date()});
  $("gp-text").value=""; toast("ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!"); loadGroupPosts();
});
async function loadGroupPosts(){
  const box=$("group-posts"); box.innerHTML="";
  const snap=await db.collection("groupPosts").where("groupId","==",currentGroup.id).orderBy("created","desc").get();
  if(snap.empty){ box.innerHTML='<div class="empty">ì•„ì§ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  snap.forEach(doc=>{
    const d=doc.data();
    const el=document.createElement("div"); el.className="card";
    el.innerHTML=`<strong>${d.name}</strong><p>${d.text.replace(/\n/g,"<br>")}</p>`;
    box.appendChild(el);
  });
}

/* ============ Admin ============ */
function adminLogin(){
  const pass=$("admin-pass").value;
  if(pass===ADMIN_PASSWORD){
    isAdmin=true; $("role").textContent="ê´€ë¦¬ì"; $("admin-login").style.display="none"; $("admin-panel").classList.add("show"); toast("ê´€ë¦¬ì ëª¨ë“œ");
    // ì´ˆê¸° ë¡œë“œ
    renderAdminLists();
  }else{ alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."); }
}
async function renderAdminLists(){ loadAdminStories(); loadAdminSuggestions(); loadAdminGroups(); }

// ìŠ¤í† ë¦¬ ì¶”ê°€
$("story-add").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const title=$("st-title").value.trim(); const text=$("st-text").value;
  if(!title) return;
  await db.collection("stories").add({title,text,created:new Date()});
  $("st-title").value=""; $("st-text").value="";
  toast("ìŠ¤í† ë¦¬ ì¶”ê°€ë¨"); loadStories(); loadAdminStories();
});

async function loadAdminStories(){
  const box=$("admin-stories"); box.innerHTML="";
  const snap=await db.collection("stories").orderBy("created","desc").get();
  if(snap.empty){ box.innerHTML='<div class="empty">ìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  snap.forEach(doc=>{
    const s=doc.data();
    const card=document.createElement("div"); card.className="card";
    card.innerHTML=`
      <b>${s.title}</b>
      <div class="action"><button class="btn" data-edit>ìˆ˜ì •</button><button class="btn" data-del>ì‚­ì œ</button></div>
    `;
    card.querySelector("[data-edit]").onclick=async()=>{
      const nt=prompt("ìƒˆ ì œëª©:", s.title); if(!nt) return;
      const nx=prompt("ë³¸ë¬¸(ë¹ˆì¹¸=ìœ ì§€):", s.text||"");
      await db.collection("stories").doc(doc.id).update({ title:nt, ...(nx!==""?{text:nx}:{}) });
      toast("ìˆ˜ì •ë¨"); loadAdminStories(); loadStories();
    };
    card.querySelector("[data-del]").onclick=async()=>{
      if(!confirm("ì‚­ì œí• ê¹Œìš”?"))return;
      await db.collection("stories").doc(doc.id).delete();
      toast("ì‚­ì œë¨"); loadAdminStories(); loadStories();
    };
    box.appendChild(card);
  });
}

// ì œì•ˆ ìŠ¹ì¸
async function loadAdminSuggestions(){
  const box=$("admin-suggestions"); box.innerHTML="";
  const snap=await db.collection("suggestions").orderBy("created","desc").get();
  if(snap.empty){ box.innerHTML='<div class="empty">ìŠ¹ì¸ ëŒ€ê¸° ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  snap.forEach(doc=>{
    const d=doc.data(); const card=document.createElement("div"); card.className="card";
    card.innerHTML=`<p style="margin:0 0 6px"><b>${d.name}</b></p><p>${d.text.replace(/\n/g,"<br>")}</p>
    <div class="action"><button class="btn" data-approve>ìŠ¤í† ë¦¬ë¡œ ë“±ë¡</button><button class="btn" data-remove>ì œì•ˆ ì‚­ì œ</button></div>`;
    card.querySelector("[data-approve]").onclick=async()=>{
      const title=prompt("ìƒˆ ìŠ¤í† ë¦¬ ì œëª©:"); if(!title) return;
      await db.collection("stories").add({title,text:d.text,created:new Date()});
      await db.collection("suggestions").doc(doc.id).delete();
      toast("ìŠ¹ì¸ë˜ì–´ ìŠ¤í† ë¦¬ë¡œ ë“±ë¡ë¨"); loadAdminSuggestions(); loadStories();
    };
    card.querySelector("[data-remove]").onclick=async()=>{
      if(!confirm("ì´ ì œì•ˆì„ ì‚­ì œí• ê¹Œìš”?"))return;
      await db.collection("suggestions").doc(doc.id).delete(); toast("ì‚­ì œë¨"); loadAdminSuggestions();
    };
    box.appendChild(card);
  });
}

// ê·¸ë£¹ ê´€ë¦¬
$("group-add").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const name=$("gr-name").value.trim(); const desc=$("gr-desc").value.trim();
  if(!name) return;
  await db.collection("groups").add({name,desc,created:new Date()});
  $("gr-name").value=""; $("gr-desc").value="";
  toast("ê·¸ë£¹ ìƒì„±ë¨"); loadGroups(); loadAdminGroups();
});
async function loadAdminGroups(){
  const box=$("admin-groups"); box.innerHTML="";
  const snap=await db.collection("groups").orderBy("created","desc").get();
  if(snap.empty){ box.innerHTML='<div class="empty">ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  snap.forEach(doc=>{
    const g=doc.data(); const el=document.createElement("div"); el.className="card";
    el.innerHTML=`<b>${g.name}</b> <span class="empty">${g.desc||""}</span>
    <div class="action"><button class="btn" data-del>ì‚­ì œ</button></div>`;
    el.querySelector("[data-del]").onclick=async()=>{
      if(!confirm("ì´ ê·¸ë£¹ì„ ì‚­ì œí• ê¹Œìš”? (ê²Œì‹œê¸€ì€ ìœ ì§€)"))return;
      await db.collection("groups").doc(doc.id).delete(); toast("ì‚­ì œë¨"); loadAdminGroups(); loadGroups();
    };
    box.appendChild(el);
  });
}
</script>
</body>
</html>
