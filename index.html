<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ì—°í˜¸ì˜ ìŠ¤í† ë¦¬ë¶ â€” ì‹œë¦¬ì¦ˆ & ì •ë ¬</title>
<style>
:root{--bg:#0b0e12;--surface:#0f141a;--panel:#11161c;--line:#1f2937;
--text:#e7ecf2;--muted:#9aa4b2;--primary:#2563eb;--primary-2:#1d4ed8;}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);
font-family:system-ui,Segoe UI,Roboto,Noto Sans KR,sans-serif}
header{background:var(--panel);border-bottom:1px solid var(--line)}
.container{max-width:1100px;margin:0 auto;padding:14px 16px}
.top{display:flex;gap:12px;align-items:center;justify-content:space-between}
.brand{font-weight:900}
nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.btn{background:var(--surface);border:1px solid var(--line);color:var(--text);
padding:8px 12px;border-radius:10px;cursor:pointer}
.btn:hover{border-color:var(--primary)}
.btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
.btn.primary:hover{background:var(--primary-2)}
main{padding:20px 0}.section{display:none}.section.show{display:block}
.card{background:var(--panel);border:1px solid var(--line);border-radius:12px;
padding:14px;margin:12px 0}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
input,textarea,select{width:100%;background:var(--surface);
border:1px solid var(--line);color:var(--text);padding:10px;border-radius:10px}
.small{max-width:280px}.empty{color:var(--muted)}
.toast{position:fixed;right:16px;bottom:16px;background:#111c;
backdrop-filter:blur(6px);color:#fff;padding:10px 14px;border-radius:10px;
display:none}
.tabs{display:flex;gap:8px;flex-wrap:wrap;position:sticky;top:0;
background:linear-gradient(180deg,var(--bg) 70%,transparent);padding:8px 0;z-index:5}
.tab{border:1px solid var(--line);background:var(--surface);color:var(--text);
padding:7px 12px;border-radius:999px;cursor:pointer}
.tab.active{border-color:var(--primary);
box-shadow:0 0 0 2px color-mix(in srgb,var(--primary),transparent 70%) inset}
.list{display:grid;gap:12px}
h2,h3{margin:.2em 0 .6em}
footer{background:var(--panel);border-top:1px solid var(--line);
text-align:center;padding:10px}
.badge{border:1px solid var(--line);border-radius:999px;
padding:2px 8px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<header>
  <div class="container">
    <div class="top">
      <div class="brand">ğŸ“š ì—°í˜¸ì˜ ìŠ¤í† ë¦¬ë¶</div>
      <div class="badge" id="role">ì½ê¸° ì „ìš©</div>
    </div>
    <nav>
      <button class="btn" onclick="show('home')">ğŸ  í™ˆ</button>
      <button class="btn" onclick="show('stories')">ğŸ“– ìŠ¤í† ë¦¬ë¶</button>
      <button class="btn" onclick="show('next')">âœ¨ ë‹¤ìŒ ì´ì•¼ê¸°</button>
      <button class="btn" onclick="show('admin')">âš™ï¸ ê´€ë¦¬ì</button>
    </nav>
  </div>
</header>

<main class="container">
  <section id="home" class="section show">
    <div class="card"><h2>í™˜ì˜í•©ë‹ˆë‹¤!</h2><p>ì‹œë¦¬ì¦ˆë³„ë¡œ ì±…ì„ ë³´ê³ , ë‹¤ìŒ ì´ì•¼ê¸°ë¥¼ ì œì•ˆí•´ë³´ì„¸ìš”.</p>
    <button class="btn primary" onclick="show('stories')">ìŠ¤í† ë¦¬ë¶ ë³´ê¸°</button></div>
    <div class="card"><h3>ìµœê·¼ ì±…</h3><div id="home-stories" class="list"></div></div>
  </section>

  <section id="stories" class="section">
    <h2>ìŠ¤í† ë¦¬ë¶</h2>
    <div class="tabs" id="series-tabs"></div>
    <div id="series-current" class="empty" style="margin-bottom:10px"></div>
    <div id="story-list" class="list"></div>
  </section>

  <section id="next" class="section">
    <h2>ë‹¤ìŒ ì´ì•¼ê¸°ëŠ” ë¬´ì—‡ì¼ê¹Œ?</h2>
    <form id="suggest-form" class="card">
      <div class="row">
        <select id="sg-series" class="small"></select>
        <input id="sg-name" placeholder="ë‹‰ë„¤ì„" required class="small">
        <button class="btn" type="submit">ì œì•ˆ</button>
      </div>
      <textarea id="sg-text" rows="5" placeholder="ë‹¤ìŒ ì´ì•¼ê¸°ë¥¼ ì œì•ˆí•´ì£¼ì„¸ìš”" required></textarea>
    </form>
    <div class="card"><h3>ìµœê·¼ ì œì•ˆ</h3><div id="suggestions" class="list"></div></div>
  </section>

  <section id="admin" class="section">
    <div id="admin-login" class="card">
      <h2>ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
      <div class="row">
        <input id="admin-pass" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="small">
        <button class="btn primary" onclick="adminLogin()">ë¡œê·¸ì¸</button>
      </div>
    </div>
    <div id="admin-panel" class="section">
      <div class="card">
        <h3>ì‹œë¦¬ì¦ˆ ê´€ë¦¬</h3>
        <form id="series-add" class="row">
          <input id="se-name" placeholder="ì‹œë¦¬ì¦ˆ ì´ë¦„" required class="small">
          <input id="se-desc" placeholder="ì„¤ëª…" style="flex:1">
          <button class="btn" type="submit">ì¶”ê°€</button>
        </form>
        <div id="admin-series" class="list"></div>
      </div>

      <div class="card">
        <h3>ì±…(ìŠ¤í† ë¦¬) ê´€ë¦¬</h3>
        <form id="story-add" class="row">
          <select id="st-series" class="small" required></select>
          <input id="st-title" placeholder="ì±… ì œëª©" required style="flex:1">
          <button class="btn" type="submit">ì¶”ê°€</button>
        </form>
        <textarea id="st-text" rows="5" placeholder="ë³¸ë¬¸ (ì„ íƒ)"></textarea>
        <div id="admin-stories" class="list" style="margin-top:10px"></div>
      </div>
    </div>
  </section>
</main>

<footer><small>Â© 2025 ì—°í˜¸ì˜ ìŠ¤í† ë¦¬ë¶</small></footer>
<div id="toast" class="toast"></div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script>
/* ============ Firebase ============ */
const firebaseConfig = {
  apiKey: "AIzaSyBEBA0ZUVcMBG_G9CtauP02kh4Wneg-5gA",
  authDomain: "storybook-4a13b.firebaseapp.com",
  projectId: "storybook-4a13b",
  storageBucket: "storybook-4a13b.firebasestorage.app",
  messagingSenderId: "756981563455",
  appId: "1:756981563455:web:b0bef64ba3ca2fb39a788a",
  measurementId: "G-CPXLQYTYJY"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ============ App State ============ */
const ADMIN_PASSWORD = "admin1234";
let isAdmin = false;
let currentSeriesId = null;

/* ============ Helpers ============ */
const $ = id=>document.getElementById(id);
const toast = msg=>{const t=$("toast");t.textContent=msg;t.style.display="block";
setTimeout(()=>t.style.display="none",1500)};
function show(id){
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("show"));
  $(id).classList.add("show");
  if(id==="home") loadHomeStories();
  if(id==="stories") loadSeriesTabs();
  if(id==="next") { loadSeriesSelects(); loadSuggestions(); }
  if(id==="admin" && isAdmin) { $("admin-panel").classList.add("show"); renderAdmin(); }
}

/* ============ HOME ============ */
async function loadHomeStories(){
  const box=$("home-stories"); box.innerHTML="";
  const snap=await db.collection("stories").orderBy("created","desc").limit(3).get();
  if(snap.empty){ box.innerHTML='<div class="empty">ì±…ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  snap.forEach(doc=>{const d=doc.data(); const el=document.createElement("div");
  el.className="card"; el.innerHTML=`<b>${d.title}</b><div class="empty">${new Date(d.created?.toDate?.()||Date.now()).toLocaleString()}</div>`; box.appendChild(el);});
}

/* ============ STORIES ============ */
async function loadSeriesTabs(){
  const tabs=$("series-tabs"); tabs.innerHTML="";
  const cur=$("series-current"); cur.textContent="";
  // ìµœì‹  ì‹œë¦¬ì¦ˆê°€ ì™¼ìª½(ìµœì‹ ìˆœ)
  const snap=await db.collection("series").orderBy("created","desc").get();

  // "ì „ì²´" íƒ­
  const all=document.createElement("button");
  all.className="tab"+(currentSeriesId?"":" active");
  all.textContent="ì „ì²´";
  all.onclick=()=>{currentSeriesId=null;highlightTabs();loadStoriesList();cur.textContent="";}
  tabs.appendChild(all);

  if(snap.empty){ $("story-list").innerHTML='<div class="empty">ì‹œë¦¬ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }

  snap.forEach(doc=>{
    const d=doc.data(); const b=document.createElement("button");
    b.className="tab"+(doc.id===currentSeriesId?" active":"");
    b.textContent=d.name; b.dataset.sid=doc.id;
    b.onclick=()=>{currentSeriesId=doc.id;highlightTabs();cur.textContent=d.desc||"";loadStoriesList();};
    tabs.appendChild(b);
  });
  highlightTabs(); loadStoriesList();
}
function highlightTabs(){
  document.querySelectorAll(".tab").forEach(t=>{
    if(!currentSeriesId&&t.textContent==="ì „ì²´") t.classList.add("active");
    else if(t.dataset.sid) t.classList.toggle("active", t.dataset.sid===currentSeriesId);
    else t.classList.remove("active");
  });
}
async function loadStoriesList(){
  const list=$("story-list"); list.innerHTML="";
  let q=db.collection("stories").orderBy("order","asc");
  if(currentSeriesId) q=db.collection("stories").where("seriesId","==",currentSeriesId).orderBy("order","asc");
  const snap=await q.get();
  if(snap.empty){list.innerHTML='<div class="empty">ì±…ì´ ì—†ìŠµë‹ˆë‹¤.</div>';return;}
  snap.forEach(doc=>{
    const s=doc.data(); const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`<h3>${s.title}</h3><p>${(s.text||"").slice(0,200).replace(/\n/g,"<br>")}${(s.text||"").length>200?"â€¦":""}</p>`;
    list.appendChild(card);
  });
}

/* ============ NEXT (Suggestions) ============ */
document.getElementById("suggest-form").addEventListener("submit",async e=>{
  e.preventDefault();
  const sid=$("sg-series").value; const name=$("sg-name").value.trim(); const text=$("sg-text").value.trim();
  if(!sid){alert("ì‹œë¦¬ì¦ˆë¥¼ ì„ íƒí•˜ì„¸ìš”.");return;}
  if(!name||!text)return;
  await db.collection("suggestions").add({seriesId:sid,name,text,created:new Date()});
  $("sg-name").value=""; $("sg-text").value="";
  toast("ì œì•ˆ ë“±ë¡ë¨"); loadSuggestions();
});
async function loadSeriesSelects(){
  const snap=await db.collection("series").orderBy("created","desc").get();
  const options=['<option value="">ì‹œë¦¬ì¦ˆ ì„ íƒ</option>'];
  snap.forEach(d=>options.push(`<option value="${d.id}">${d.data().name}</option>`));
  if($("sg-series")) $("sg-series").innerHTML=options.join("");
  if($("st-series")) $("st-series").innerHTML=options.join("");
}
async function loadSuggestions(){
  const box=$("suggestions"); box.innerHTML="";
  const snap=await db.collection("suggestions").orderBy("created","desc").get();
  if(snap.empty){box.innerHTML='<div class="empty">ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>';return;}
  const map=await getSeriesMap();
  snap.forEach(doc=>{const d=doc.data();
    const el=document.createElement("div"); el.className="card";
    el.innerHTML=`<div class="empty">${map[d.seriesId]||"ì‹œë¦¬ì¦ˆ"}</div><b>${d.name}</b><p>${d.text.replace(/\n/g,"<br>")}</p>`;
    box.appendChild(el);
  });
}
async function getSeriesMap(){const m={};const s=await db.collection("series").get();s.forEach(x=>m[x.id]=x.data().name);return m;}

/* ============ ADMIN ============ */
function adminLogin(){
  const pass=$("admin-pass").value;
  if(pass===ADMIN_PASSWORD){
    isAdmin=true; $("role").textContent="ê´€ë¦¬ì";
    $("admin-login").style.display="none"; $("admin-panel").classList.add("show");
    renderAdmin(); toast("ê´€ë¦¬ì ëª¨ë“œ");
  } else alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
}
async function renderAdmin(){ await Promise.all([loadSeriesAdmin(), loadSeriesSelects(), loadAdminStories()]); }

/* ì‹œë¦¬ì¦ˆ ì¶”ê°€/ì‚­ì œ */
document.getElementById("series-add").addEventListener("submit",async e=>{
  e.preventDefault();
  const name=$("se-name").value.trim(); const desc=$("se-desc").value.trim();
  if(!name) return;
  await db.collection("series").add({name,desc,created:new Date()});
  $("se-name").value=""; $("se-desc").value="";
  toast("ì‹œë¦¬ì¦ˆ ì¶”ê°€ë¨");
  await Promise.all([loadSeriesAdmin(), loadSeriesTabs(), loadSeriesSelects()]);
});
async function loadSeriesAdmin(){
  const box=$("admin-series"); box.innerHTML="";
  const snap=await db.collection("series").orderBy("created","desc").get();
  if(snap.empty){box.innerHTML='<div class="empty">ì‹œë¦¬ì¦ˆ ì—†ìŒ</div>';return;}
  snap.forEach(doc=>{
    const d=doc.data(); const el=document.createElement("div"); el.className="card";
    el.innerHTML=`<b>${d.name}</b> <span class="empty">${d.desc||""}</span>
    <div class="row"><button class="btn" data-del>ì‚­ì œ</button></div>`;
    el.querySelector("[data-del]").onclick=async()=>{
      if(!confirm("ì‹œë¦¬ì¦ˆë¥¼ ì‚­ì œí• ê¹Œìš”? (ì±…ì€ ë‚¨ìŠµë‹ˆë‹¤)")) return;
      await db.collection("series").doc(doc.id).delete();
      toast("ì‹œë¦¬ì¦ˆ ì‚­ì œë¨");
      await Promise.all([loadSeriesAdmin(), loadSeriesTabs(), loadSeriesSelects(), loadAdminStories()]);
    };
    box.appendChild(el);
  });
}

/* ì±… ì¶”ê°€(ê¸°ë³¸ order ì„¸íŒ…) */
document.getElementById("story-add").addEventListener("submit",async e=>{
  e.preventDefault();
  const sid=$("st-series").value; const title=$("st-title").value.trim(); const text=$("st-text").value;
  if(!sid || !title) return;
  await db.collection("stories").add({seriesId:sid,title,text,created:new Date(),order:Date.now()});
  $("st-title").value=""; $("st-text").value="";
  toast("ì±… ì¶”ê°€ë¨");
  await Promise.all([loadAdminStories(), loadStoriesList()]);
});

/* ê´€ë¦¬ì: ì±… ëª©ë¡ + ì •ë ¬ ë²„íŠ¼ */
async function loadAdminStories(){
  const box=$("admin-stories"); box.innerHTML="";
  const map=await getSeriesMap();
  const snap=await db.collection("stories").orderBy("seriesId").orderBy("order","asc").get();
  if(snap.empty){ box.innerHTML='<div class="empty">ì±… ì—†ìŒ</div>'; return; }
  snap.forEach(doc=>{
    const d=doc.data();
    const el=document.createElement("div"); el.className="card";
    el.innerHTML=`
      <div class="empty">${map[d.seriesId]||"ì‹œë¦¬ì¦ˆ"}</div>
      <b>${d.title}</b>
      <div class="row" style="margin-top:8px">
        <button class="btn" data-up>â–² ìœ„ë¡œ</button>
        <button class="btn" data-down>â–¼ ì•„ë˜ë¡œ</button>
        <button class="btn" data-edit>ìˆ˜ì •</button>
        <button class="btn" data-del>ì‚­ì œ</button>
      </div>
    `;
    el.querySelector("[data-up]").onclick=()=>moveStory(doc.id,"up");
    el.querySelector("[data-down]").onclick=()=>moveStory(doc.id,"down");
    el.querySelector("[data-edit]").onclick=async()=>{
      const nt=prompt("ìƒˆ ì œëª©:", d.title); if(!nt) return;
      const nx=prompt("ë³¸ë¬¸(ë¹ˆì¹¸=ìœ ì§€):", d.text||"");
      await db.collection("stories").doc(doc.id).update({title:nt, ...(nx!==""?{text:nx}:{})});
      toast("ìˆ˜ì •ë¨"); await Promise.all([loadAdminStories(), loadStoriesList()]);
    };
    el.querySelector("[data-del]").onclick=async()=>{
      if(!confirm("ì´ ì±…ì„ ì‚­ì œí• ê¹Œìš”?")) return;
      await db.collection("stories").doc(doc.id).delete();
      toast("ì‚­ì œë¨"); await Promise.all([loadAdminStories(), loadStoriesList()]);
    };
    box.appendChild(el);
  });
}

/* ê´€ë¦¬ì: ìˆœì„œ ì´ë™ (íŠ¸ëœì­ì…˜ìœ¼ë¡œ swap) */
async function moveStory(docId, direction){
  const currentRef = db.collection("stories").doc(docId);
  const currentSnap = await currentRef.get();
  if(!currentSnap.exists) return;
  const cur = currentSnap.data();

  // ê°™ì€ ì‹œë¦¬ì¦ˆ ë‚´ì—ì„œ ì •ë ¬ ëŒ€ìƒ ì°¾ê¸°
  const q = await db.collection("stories")
    .where("seriesId","==",cur.seriesId)
    .orderBy("order","asc")
    .get();

  const docs = q.docs;
  const idx = docs.findIndex(d=>d.id===docId);
  const targetIdx = direction==="up" ? idx-1 : idx+1;
  if(targetIdx < 0 || targetIdx >= docs.length) return;

  const otherRef = docs[targetIdx].ref;
  const otherData = docs[targetIdx].data();

  await db.runTransaction(async t=>{
    t.update(currentRef, { order: otherData.order });
    t.update(otherRef,   { order: cur.order });
  });

  toast("ì±… ìˆœì„œ ë³€ê²½ë¨");
  await Promise.all([loadAdminStories(), loadStoriesList()]);
}
</script>
</body>
</html>
