<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ì—°í˜¸ì˜ ìŠ¤í† ë¦¬ë¶</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0a0f18; --card:#0f1726cc; --line:#1c2a40;
  --ink:#eaf1fb; --mut:#9fb0c3; --pri:#6ea3ff; --pri2:#4f7ef3;
  --r:16px;
}
body {
  margin:0;
  font-family:Inter,system-ui,sans-serif;
  background:linear-gradient(180deg,#0a0f18,#0c1424 50%,#0a0f18);
  color:var(--ink);
}
.header {position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;
  background:#0c141fbf;padding:10px 16px;border-bottom:1px solid var(--line);backdrop-filter:blur(10px);}
.btn {background:#101a2b;border:1px solid var(--line);color:var(--ink);
  padding:8px 12px;border-radius:10px;cursor:pointer;transition:all .15s;}
.btn:hover {border-color:#2a3b5e;}
.btn.pri {background:linear-gradient(180deg,var(--pri),var(--pri2));color:#fff;border:none;}
.app {max-width:1200px;margin:0 auto;padding:20px;}
.section {display:none;}
.section.show {display:block;}
.tabs {display:flex;gap:10px;overflow:auto;padding:6px 0;}
.tab {border:1px solid var(--line);background:#0e1627;color:var(--ink);padding:8px 14px;border-radius:999px;cursor:pointer;}
.tab.active {border-color:var(--pri);background:var(--pri2);}
.story {background:var(--card);border:1px solid var(--line);border-radius:var(--r);padding:14px;margin:8px 0;}
.story h4 {margin:0;}
.story p {margin:6px 0;color:var(--mut);}
.story .actions {display:flex;gap:8px;margin-top:8px;}
.empty {color:var(--mut);}
.spinner {width:40px;height:40px;border:3px solid #1a2840;border-top-color:var(--pri);border-radius:50%;animation:spin 1s linear infinite;margin:20px auto;}
@keyframes spin{to{transform:rotate(360deg)}}
.toast {position:fixed;bottom:16px;right:16px;background:#0b1322e6;padding:10px 14px;border-radius:8px;display:none;}
.modal{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:100;}
.modal.on{display:flex}
.modal .box{background:#0f1726;border:1px solid var(--line);border-radius:12px;padding:16px;width:min(700px,90vw);}
#version-box{position:fixed;right:14px;bottom:14px;background:rgba(15,23,38,0.8);border:1px solid #1c2a40;border-radius:10px;font-size:13px;color:#9fb0c3;padding:6px 12px;backdrop-filter:blur(10px);z-index:200;}
#version-banner{position:fixed;top:-80px;left:0;right:0;background:rgba(20,33,60,0.95);border-bottom:1px solid #2a3b5e;color:#eaf1fb;font-size:15px;text-align:center;padding:12px 20px;backdrop-filter:blur(12px);z-index:300;transition:top .5s ease;}
</style>
</head>
<body>
<div class="header">
  <div><b>ğŸ“˜ ì—°í˜¸ì˜ ìŠ¤í† ë¦¬ë¶</b></div>
  <div>
    <button class="btn" data-page="home">í™ˆ</button>
    <button class="btn" data-page="stories">ìŠ¤í† ë¦¬ë¶</button>
    <button class="btn" data-page="next">ë‹¤ìŒ ì´ì•¼ê¸°</button>
    <button class="btn pri" data-page="admin">ê´€ë¦¬ì</button>
  </div>
</div>

<div class="app">
  <section id="home" class="section show">
    <h2>í™˜ì˜í•©ë‹ˆë‹¤ ğŸ‘‹</h2>
    <p>ìŠ¤í† ë¦¬ë¶, ì‹œë¦¬ì¦ˆ, ë‹¤ìŒ ì´ì•¼ê¸° ì œì•ˆì„ ììœ ë¡­ê²Œ íƒìƒ‰í•´ë³´ì„¸ìš”.</p>
  </section>

  <section id="stories" class="section">
    <h2>ì‹œë¦¬ì¦ˆë³„ ìŠ¤í† ë¦¬ë¶</h2>
    <div id="series-tabs" class="tabs"></div>
    <div id="series-desc" class="empty"></div>
    <div id="story-list"></div>
    <div id="story-loading" class="spinner" style="display:none;"></div>
  </section>

  <section id="next" class="section">
    <h2>ë‹¤ìŒ ì´ì•¼ê¸°ëŠ” ë¬´ì—‡ì¼ê¹Œ âœ¨</h2>
    <form id="suggest-form">
      <select id="sg-series" required></select>
      <input id="sg-name" placeholder="ë‹‰ë„¤ì„" required style="padding:8px;border-radius:8px;">
      <textarea id="sg-text" placeholder="ë‹¤ìŒ ì´ì•¼ê¸°ë¥¼ ì¨ì£¼ì„¸ìš”â€¦" rows="4" style="width:100%;margin-top:8px;padding:8px;border-radius:8px;"></textarea><br>
      <button class="btn pri" type="submit">ë“±ë¡</button>
    </form>
    <div id="suggestions"></div>
  </section>

  <section id="admin" class="section">
    <h2>ê´€ë¦¬ì</h2>
    <input id="admin-pass" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" style="padding:8px;border-radius:8px;">
    <button class="btn pri" id="btnAdminLogin">ë¡œê·¸ì¸</button>
    <div id="admin-panel" style="display:none;margin-top:20px;">
      <button class="btn pri" id="openSeries">+ ì‹œë¦¬ì¦ˆ ì¶”ê°€</button>
      <button class="btn pri" id="openStory">+ ì±… ì¶”ê°€</button>
    </div>
  </section>
</div>

<div id="version-box">v0.0.0</div>
<div id="version-banner"><span id="version-banner-text"></span><button id="banner-close" style="margin-left:12px;background:none;border:none;color:#9fb0c3;cursor:pointer;font-size:14px;">Ã—</button></div>
<div class="toast" id="toast"></div>
<div class="modal" id="modal"><div class="box"><div class="row" style="justify-content:space-between"><h3 id="modal-title"></h3><button class="btn" id="modal-close">ë‹«ê¸°</button></div><div id="modal-body"></div></div></div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBEBA0ZUVcMBG_G9CtauP02kh4Wneg-5gA",
  authDomain: "storybook-4a13b.firebaseapp.com",
  projectId: "storybook-4a13b",
  storageBucket: "storybook-4a13b.firebasestorage.app",
  messagingSenderId: "756981563455",
  appId: "1:756981563455:web:b0bef64ba3ca2fb39a788a",
  measurementId: "G-CPXLQYTYJY"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const $=id=>document.getElementById(id);
const $$=s=>Array.from(document.querySelectorAll(s));
function show(id){$$(".section").forEach(s=>s.classList.remove("show"));$(id).classList.add("show");}
function toast(m){const t=$("toast");t.textContent=m;t.style.display="block";setTimeout(()=>t.style.display="none",1800);}
function openModal(t,h){$("modal-title").textContent=t;$("modal-body").innerHTML=h;$("modal").classList.add("on");}
function closeModal(){$("modal").classList.remove("on");}
$("modal-close").onclick=closeModal;
$$("[data-page]").forEach(b=>b.onclick=()=>show(b.dataset.page));

let isAdmin=false,currentSeries="ALL";

/* ì‹œë¦¬ì¦ˆ */
async function loadSeriesTabs(){
  $("series-tabs").innerHTML="";$("series-desc").textContent="";$("story-list").innerHTML="";
  const all=document.createElement("button");all.className="tab";all.textContent="ì „ì²´";all.onclick=()=>{currentSeries="ALL";highlightTabs();loadStories();};$("series-tabs").appendChild(all);
  const snap=await db.collection("series").orderBy("created","desc").get();
  snap.forEach(doc=>{const s=doc.data();const b=document.createElement("button");b.className="tab";b.textContent=s.name;b.dataset.sid=doc.id;b.onclick=()=>{currentSeries=doc.id;highlightTabs();$("series-desc").textContent=s.desc||"";loadStories();};$("series-tabs").appendChild(b);});
  highlightTabs();loadStories();
}
function highlightTabs(){$$(".tab").forEach(t=>t.classList.toggle("active",(t.dataset.sid===currentSeries)||(currentSeries==="ALL"&&t.textContent==="ì „ì²´")));}

async function loadStories(){
  const list=$("story-list");list.innerHTML="";
  let q=db.collection("stories").orderBy("created","desc");if(currentSeries!=="ALL")q=q.where("seriesId","==",currentSeries);
  const snap=await q.get();if(snap.empty){list.innerHTML='<div class="empty">ì±…ì´ ì—†ìŠµë‹ˆë‹¤.</div>';return;}
  snap.forEach(d=>{const s=d.data();const e=document.createElement("div");e.className="story";e.innerHTML=`<h4>${s.title}</h4><p>${(s.text||"").slice(0,200)}...</p>`;list.appendChild(e);});
}

/* ê´€ë¦¬ì */
$("btnAdminLogin").onclick=()=>{if($("admin-pass").value==="admin1234"){isAdmin=true;$("admin-panel").style.display="block";toast("ê´€ë¦¬ì ëª¨ë“œ");}else alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");};
$("openSeries").onclick=()=>{openModal("ì‹œë¦¬ì¦ˆ ì¶”ê°€",`<form id="formSeries"><input id="se-name" placeholder="ì´ë¦„" required><input id="se-desc" placeholder="ì„¤ëª…"><button class="btn pri">ì¶”ê°€</button></form>`);document.getElementById("formSeries").onsubmit=async e=>{e.preventDefault();await db.collection("series").add({name:$("se-name").value,desc:$("se-desc").value,created:new Date()});toast("ì‹œë¦¬ì¦ˆ ì¶”ê°€ë¨");closeModal();loadSeriesTabs();};};
$("openStory").onclick=async()=>{const s=await db.collection("series").get();let opt="";s.forEach(d=>opt+=`<option value="${d.id}">${d.data().name}</option>`);openModal("ì±… ì¶”ê°€",`<form id="formStory"><select id="st-series">${opt}</select><input id="st-title" placeholder="ì œëª©" required><textarea id="st-text" rows="4" placeholder="ë‚´ìš©"></textarea><button class="btn pri">ì¶”ê°€</button></form>`);document.getElementById("formStory").onsubmit=async e=>{e.preventDefault();await db.collection("stories").add({seriesId:$("st-series").value,title:$("st-title").value,text:$("st-text").value,created:new Date()});toast("ì±… ì¶”ê°€ë¨");closeModal();loadStories();};};

/* ë‹¤ìŒ ì´ì•¼ê¸° */
$("suggest-form").onsubmit=async e=>{e.preventDefault();await db.collection("suggestions").add({seriesId:$("sg-series").value,name:$("sg-name").value,text:$("sg-text").value,created:new Date()});toast("ì œì•ˆë¨");$("sg-text").value="";};

/* ========== ë²„ì „ ì‹œìŠ¤í…œ + ê³µì§€ ë°°ë„ˆ ========== */
async function loadVersion(){
  const doc=await db.collection("meta").doc("version").get();
  if(doc.exists){const v=doc.data();$("version-box").textContent=v.number||"v0.0.0";$("version-box").title="ì—…ë°ì´íŠ¸: "+new Date(v.updated?.toDate?.()||Date.now()).toLocaleString();}
}
loadVersion();

/* ê³µì§€ ë°°ë„ˆ */
async function loadVersionNotice(){
  const doc=await db.collection("meta").doc("version").get();if(!doc.exists)return;
  const v=doc.data();const cur=v.number||"v0.0.0";const seen=localStorage.getItem("lastVersion");
  if(seen!==cur){$("version-banner-text").textContent=`${cur} â€” ${v.message||"ìƒˆ ì—…ë°ì´íŠ¸ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!"}`;$("version-banner").style.top="0";$("banner-close").onclick=()=>{$("version-banner").style.top="-80px";localStorage.setItem("lastVersion",cur);};}
}
loadVersionNotice();

/* ë²„ì „ ìˆ˜ì •/ì´ë ¥ */
function incrementVersion(v){const p=v.replace(/[^\d.]/g,"").split(".").map(n=>parseInt(n)||0);while(p.length<3)p.push(0);p[2]++;if(p[2]>=10){p[2]=0;p[1]++;}if(p[1]>=10){p[1]=0;p[0]++;}return`v${p.join(".")}`;}
function openVersionEditor(){
  openModal("ë²„ì „ ìˆ˜ì •",`
  <form id="formVersion" class="grid">
    <input id="v-num" placeholder="v1.0.0" required>
    <input id="v-user" placeholder="ì‘ì„±ì(ì„ íƒ)">
    <textarea id="v-msg" rows="3" placeholder="ê³µì§€ ë©”ì‹œì§€"></textarea>
    <div class="row" style="justify-content:flex-end;gap:8px">
      <button class="btn" type="button" id="autoIncBtn">ìë™ ì¦ê°€</button>
      <button class="btn pri" type="submit">ì €ì¥</button>
    </div>
  </form>`);
  db.collection("meta").doc("version").get().then(doc=>{if(doc.exists){$("v-num").value=doc.data().number||"";$("v-msg").value=doc.data().message||"";}});
  $("autoIncBtn").onclick=()=>{$("v-num").value=incrementVersion($("v-num").value||"v0.0.0");};
  document.getElementById("formVersion").onsubmit=async e=>{
    e.preventDefault();
    const num=$("v-num").value.trim(),user=$("v-user").value.trim()||"ê´€ë¦¬ì",msg=$("v-msg").value.trim()||"ìƒˆ ì—…ë°ì´íŠ¸ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!";
    await db.collection("meta").doc("version").set({number:num,updated:new Date(),message:msg});
    await db.collection("versionHistory").add({version:num,changedBy:user,message:msg,date:new Date()});
    toast("ë²„ì „ ì—…ë°ì´íŠ¸ ì™„ë£Œ");closeModal();loadVersion();loadVersionNotice();
  };
}
</script>
</body>
</html>
