<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ì—°í˜¸ì˜ ìŠ¤í† ë¦¬ë¶ â€” ì‹œë¦¬ì¦ˆ</title>
<style>
:root{
  --bg:#0b0e12;--surface:#0f141a;--panel:#11161c;--line:#1f2937;
  --text:#e7ecf2;--muted:#9aa4b2;--primary:#2563eb;--primary-2:#1d4ed8;
}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Noto Sans KR,sans-serif}
header{background:var(--panel);border-bottom:1px solid var(--line)}
.container{max-width:1100px;margin:0 auto;padding:14px 16px}
.top{display:flex;gap:12px;align-items:center;justify-content:space-between}
.brand{font-weight:900}
nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.btn{background:var(--surface);border:1px solid var(--line);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
.btn:hover{border-color:var(--primary)}
.btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
.btn.primary:hover{background:var(--primary-2)}
main{padding:20px 0}.section{display:none}.section.show{display:block}
.card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px;margin:12px 0}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
input,textarea,select{width:100%;background:var(--surface);border:1px solid var(--line);color:var(--text);padding:10px;border-radius:10px}
.small{max-width:280px}
.empty{color:var(--muted)}hr{border:none;border-top:1px solid var(--line);margin:14px 0}
.toast{position:fixed;right:16px;bottom:16px;background:#111c;backdrop-filter:blur(6px);color:#fff;padding:10px 14px;border-radius:10px;display:none}
.tabs{display:flex;gap:8px;flex-wrap:wrap;position:sticky;top:0;background:linear-gradient(180deg,var(--bg) 70%,transparent);padding:8px 0 6px;z-index:5}
.tab{border:1px solid var(--line);background:var(--surface);color:var(--text);padding:7px 12px;border-radius:999px;cursor:pointer}
.tab.active{border-color:var(--primary);box-shadow:0 0 0 2px color-mix(in srgb,var(--primary),transparent 70%) inset}
.list{display:grid;gap:12px}
h2,h3{margin:.2em 0 .6em}
footer{background:var(--panel);border-top:1px solid var(--line);text-align:center;padding:10px}
.badge{border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<header>
  <div class="container">
    <div class="top">
      <div class="brand">ğŸ“š ì—°í˜¸ì˜ ìŠ¤í† ë¦¬ë¶ â€” ì‹œë¦¬ì¦ˆ</div>
      <div class="badge" id="role">ì½ê¸° ì „ìš©</div>
    </div>
    <nav>
      <button class="btn" onclick="show('home')">ğŸ  í™ˆ</button>
      <button class="btn" onclick="show('stories')">ğŸ“– ìŠ¤í† ë¦¬ë¶</button>
      <button class="btn" onclick="show('groups')">ğŸ‘¥ ê·¸ë£¹</button>
      <button class="btn" onclick="show('next')">âœ¨ ë‹¤ìŒ ì´ì•¼ê¸°</button>
      <button class="btn" onclick="show('admin')">âš™ï¸ ê´€ë¦¬ì</button>
    </nav>
  </div>
</header>

<main class="container">

  <!-- í™ˆ -->
  <section id="home" class="section show">
    <div class="card">
      <h2>í™˜ì˜í•©ë‹ˆë‹¤!</h2>
      <p>ì‹œë¦¬ì¦ˆ íƒ­ìœ¼ë¡œ ì±…ì„ ê³¨ë¼ ì½ê³ , ì»¤ë®¤ë‹ˆí‹°ì— ì°¸ì—¬í•˜ê±°ë‚˜ ë‹¤ìŒ ì´ì•¼ê¸°ë¥¼ ì œì•ˆí•´ ë³´ì„¸ìš”.</p>
      <div class="row">
        <button class="btn primary" onclick="show('stories')">ìŠ¤í† ë¦¬ë¶ ë³´ëŸ¬ê°€ê¸°</button>
        <button class="btn" onclick="show('groups')">ê·¸ë£¹ìœ¼ë¡œ ê°€ê¸°</button>
        <button class="btn" onclick="show('next')">ë‹¤ìŒ ì´ì•¼ê¸° ì œì•ˆ</button>
      </div>
    </div>
    <div class="card">
      <h3>ìƒˆë¡œ ì˜¬ë¼ì˜¨ ì±…</h3>
      <div id="home-stories" class="list"></div>
    </div>
  </section>

  <!-- ìŠ¤í† ë¦¬ë¶: ì‹œë¦¬ì¦ˆ íƒ­ + ì‹œë¦¬ì¦ˆë³„ ì±… -->
  <section id="stories" class="section">
    <h2>ìŠ¤í† ë¦¬ë¶</h2>
    <div class="tabs" id="series-tabs"></div>
    <div id="series-current" class="empty" style="margin:6px 2px 10px"></div>
    <div id="story-list" class="list"></div>
  </section>

  <!-- ê·¸ë£¹ (ê°„ë‹¨ ìœ ì§€) -->
  <section id="groups" class="section">
    <div class="row" style="justify-content:space-between">
      <h2>ê·¸ë£¹</h2><span class="empty">ê´€ë¦¬ìê°€ ë§Œë“  ê·¸ë£¹ì—ì„œ ëˆ„êµ¬ë‚˜ ê¸€ ì‘ì„±</span>
    </div>
    <div id="group-list" class="list"></div>
    <div id="group-post-box" class="card" style="display:none">
      <h3 id="group-title">ê·¸ë£¹</h3>
      <form id="group-post-form" class="row">
        <input id="gp-name" placeholder="ë‹‰ë„¤ì„" required class="small">
        <button class="btn" type="submit">ê¸€ ì˜¬ë¦¬ê¸°</button>
      </form>
      <textarea id="gp-text" rows="4" placeholder="ë‚´ìš© ì…ë ¥" required></textarea>
      <h4>ìµœê·¼ ê¸€</h4>
      <div id="group-posts" class="list"></div>
    </div>
  </section>

  <!-- ë‹¤ìŒ ì´ì•¼ê¸° -->
  <section id="next" class="section">
    <h2>ë‹¤ìŒ ì´ì•¼ê¸°ëŠ” ë¬´ì—‡ì¼ê¹Œ?</h2>
    <form id="suggest-form" class="card">
      <div class="row">
        <select id="sg-series" class="small"></select>
        <input id="sg-name" placeholder="ë‹‰ë„¤ì„" required class="small">
        <button class="btn" type="submit">ì œì•ˆ ì˜¬ë¦¬ê¸°</button>
      </div>
      <textarea id="sg-text" rows="5" placeholder="ë‹¤ìŒ ì´ì•¼ê¸°ë¥¼ ì œì•ˆí•´ì£¼ì„¸ìš”â€¦" required></textarea>
    </form>
    <div class="card">
      <h3>ìµœê·¼ ì œì•ˆ</h3>
      <div id="suggestions" class="list"></div>
    </div>
  </section>

  <!-- ê´€ë¦¬ì -->
  <section id="admin" class="section">
    <div id="admin-login" class="card">
      <h2>ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
      <div class="row">
        <input id="admin-pass" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="small">
        <button class="btn primary" onclick="adminLogin()">ë¡œê·¸ì¸</button>
      </div>
      <p class="empty">ë¡œê·¸ì¸ í›„ ì•„ë˜ íŒ¨ë„ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>
    </div>

    <div id="admin-panel" class="section">
      <!-- ì‹œë¦¬ì¦ˆ ê´€ë¦¬ -->
      <div class="card">
        <h3>ì‹œë¦¬ì¦ˆ ê´€ë¦¬</h3>
        <form id="series-add" class="row">
          <input id="se-name" placeholder="ì‹œë¦¬ì¦ˆ ì´ë¦„" required class="small" style="min-width:220px">
          <input id="se-desc" placeholder="ì„¤ëª…" style="flex:1;min-width:260px">
          <button class="btn" type="submit">ì‹œë¦¬ì¦ˆ ì¶”ê°€</button>
        </form>
        <div id="admin-series" class="list" style="margin-top:10px"></div>
      </div>

      <!-- ì±…(ìŠ¤í† ë¦¬) ê´€ë¦¬ -->
      <div class="card">
        <h3>ì±…(ìŠ¤í† ë¦¬) ê´€ë¦¬</h3>
        <form id="story-add" class="row">
          <select id="st-series" class="small" required></select>
          <input id="st-title" placeholder="ì±… ì œëª©" required style="flex:1;min-width:220px">
          <button class="btn" type="submit">ì±… ì¶”ê°€</button>
        </form>
        <textarea id="st-text" rows="5" placeholder="ë³¸ë¬¸ (ì„ íƒ)"></textarea>
        <div id="admin-stories" class="list" style="margin-top:10px"></div>
      </div>

      <!-- ì œì•ˆ ìŠ¹ì¸ -->
      <div class="card">
        <h3>ì œì•ˆ ìŠ¹ì¸</h3>
        <div id="admin-suggestions" class="list"></div>
      </div>

      <!-- ê·¸ë£¹ ê´€ë¦¬(ê°„ë‹¨ ìœ ì§€) -->
      <div class="card">
        <h3>ê·¸ë£¹ ê´€ë¦¬</h3>
        <form id="group-add" class="row">
          <input id="gr-name" placeholder="ê·¸ë£¹ ì´ë¦„" required class="small" style="min-width:200px">
          <input id="gr-desc" placeholder="ì„¤ëª…" style="flex:1;min-width:260px">
          <button class="btn" type="submit">ê·¸ë£¹ ì¶”ê°€</button>
        </form>
        <div id="admin-groups" class="list" style="margin-top:10px"></div>
      </div>
    </div>
  </section>

</main>

<footer><small>Â© 2025 ì—°í˜¸ì˜ ìŠ¤í† ë¦¬ë¶</small></footer>
<div id="toast" class="toast"></div>

<!-- Firebase SDK (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
/* ============ Firebase ============ */
// ğŸ”‘ ì—¬ê¸°ì— ë„¤ firebaseConfig ì „ì²´ë¥¼ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ê¸°
const firebaseConfig = {
  apiKey: "AIzaSyBEBA0ZUVcMBG_G9CtauP02kh4Wneg-5gA",
  authDomain: "storybook-4a13b.firebaseapp.com",
  projectId: "storybook-4a13b",
  storageBucket: "storybook-4a13b.firebasestorage.app",
  messagingSenderId: "756981563455",
  appId: "1:756981563455:web:b0bef64ba3ca2fb39a788a",
  measurementId: "G-CPXLQYTYJY"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ============ App State ============ */
const ADMIN_PASSWORD = "admin1234"; // í•„ìš”ì‹œ ë³€ê²½
let isAdmin = false;
let currentSeriesId = null; // ìŠ¤í† ë¦¬ë¶ íƒ­ ì„ íƒ
let currentGroup = null;

/* ============ Helpers ============ */
const $ = (id)=>document.getElementById(id);
const toast = (msg)=>{ const t=$("toast"); t.textContent=msg; t.style.display="block"; setTimeout(()=>t.style.display="none",1600) }
function show(id){
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("show"));
  $(id).classList.add("show");
  if(id==="home"){ loadHomeStories(); }
  if(id==="stories"){ loadSeriesTabs(); }
  if(id==="groups"){ loadGroups(); }
  if(id==="next"){ loadSeriesSelects(); loadSuggestions(); }
  if(id==="admin"){ if(isAdmin){ $("admin-panel").classList.add("show"); renderAdminAll(); } }
}

/* ============ HOME ============ */
async function loadHomeStories(){
  const box=$("home-stories"); box.innerHTML="";
  const snap=await db.collection("stories").orderBy("created","desc").limit(3).get();
  if(snap.empty){ box.innerHTML='<div class="empty">ì•„ì§ ì±…ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  snap.forEach(doc=>{
    const s=doc.data(); const el=document.createElement("div");
    el.className="card"; el.innerHTML=`<b>${s.title}</b><div class="empty">${new Date(s.created?.toDate?.()||Date.now()).toLocaleString()}</div>`;
    box.appendChild(el);
  });
}

/* ============ STORIES (Series Tabs) ============ */
async function loadSeriesTabs(){
  const tabs=$("series-tabs"); tabs.innerHTML="";
  const cur=$("series-current"); cur.textContent="";
  // ìµœì‹  ìƒì„±ìˆœ(ì™¼ìª½ë¶€í„° ìµœì‹ )
  const snap=await db.collection("series").orderBy("created","desc").get();
  // "ì „ì²´" íƒ­
  const allBtn=document.createElement("button");
  allBtn.className="tab"+(currentSeriesId?"" :" active");
  allBtn.textContent="ì „ì²´"; allBtn.onclick=()=>{ currentSeriesId=null; highlightTabs(); loadStoriesList(); };
  tabs.appendChild(allBtn);

  if(snap.empty){ cur.textContent="ì‹œë¦¬ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤. (ê´€ë¦¬ìì—ì„œ ì‹œë¦¬ì¦ˆë¥¼ ì¶”ê°€í•˜ì„¸ìš”)"; $("story-list").innerHTML=""; return; }
  snap.forEach(doc=>{
    const s=doc.data();
    const b=document.createElement("button");
    b.className="tab"+(doc.id===currentSeriesId?" active":"");
    b.textContent=s.name;
    b.onclick=()=>{ currentSeriesId=doc.id; highlightTabs(); cur.textContent=s.desc||""; loadStoriesList(); };
    b.dataset.sid=doc.id;
    tabs.appendChild(b);
    // ê¸°ë³¸ ì„ íƒ: ì—†ìœ¼ë©´ ì²« í•­ëª©
    if(currentSeriesId===null){ currentSeriesId=null; }
  });
  highlightTabs(); loadStoriesList();
}
function highlightTabs(){
  document.querySelectorAll(".tab").forEach(el=>{
    if(!currentSeriesId && el.textContent==="ì „ì²´"){ el.classList.add("active"); }
    else if (el.dataset.sid){ el.classList.toggle("active", el.dataset.sid===currentSeriesId); }
    else { el.classList.remove("active"); }
  });
}

async function loadStoriesList(){
  const list=$("story-list"); list.innerHTML="";
  let q=db.collection("stories").orderBy("created","desc");
  if(currentSeriesId){ q=q.where("seriesId","==",currentSeriesId); }
  const snap=await q.get();
  if(snap.empty){ list.innerHTML='<div class="empty">í‘œì‹œí•  ì±…ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  snap.forEach(doc=>{
    const s=doc.data();
    const card=document.createElement("div"); card.className="card";
    card.innerHTML=`<h3>${s.title}</h3><p>${(s.text||"").slice(0,200).replace(/\n/g,"<br>")}${(s.text||"").length>200?"â€¦":""}</p>`;
    list.appendChild(card);
  });
}

/* ============ NEXT (Suggestions) ============ */
async function loadSeriesSelects(){
  // ë‹¤ìŒ ì´ì•¼ê¸°, ê´€ë¦¬ì ì±…ì¶”ê°€ ë“œë¡­ë‹¤ìš´ ê³µìš©
  const sel1=$("sg-series"), sel2=$("st-series");
  const snap=await db.collection("series").orderBy("created","desc").get();
  const opts=['<option value="">(ì‹œë¦¬ì¦ˆ ì„ íƒ)</option>'];
  snap.forEach(d=>opts.push(`<option value="${d.id}">${d.data().name}</option>`));
  sel1.innerHTML=opts.join(""); if(sel2) sel2.innerHTML=opts.join("");
}
$("suggest-form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const seriesId=$("sg-series").value; const name=$("sg-name").value.trim(); const text=$("sg-text").value.trim();
  if(!seriesId){ alert("ì‹œë¦¬ì¦ˆë¥¼ ì„ íƒí•˜ì„¸ìš”."); return; }
  if(!name||!text) return;
  await db.collection("suggestions").add({seriesId,name,text,created:new Date()});
  $("sg-name").value=""; $("sg-text").value="";
  toast("ì œì•ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!"); loadSuggestions();
});
async function loadSuggestions(){
  const box=$("suggestions"); box.innerHTML="";
  const snap=await db.collection("suggestions").orderBy("created","desc").get();
  if(snap.empty){ box.innerHTML='<div class="empty">ì•„ì§ ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  // ì‹œë¦¬ì¦ˆ ì´ë¦„ ë§¤í•‘
  const seriesMap = await getSeriesMap();
  snap.forEach(doc=>{
    const d=doc.data();
    const el=document.createElement("div"); el.className="card";
    el.innerHTML=`<div class="empty">${seriesMap[d.seriesId]||"ì‹œë¦¬ì¦ˆ"}</div><strong>${d.name}</strong><p>${d.text.replace(/\n/g,"<br>")}</p>`;
    box.appendChild(el);
  });
}
async function getSeriesMap(){
  const map={}; const snap=await db.collection("series").get();
  snap.forEach(s=>map[s.id]=s.data().name); return map;
}

/* ============ GROUPS (ê°„ë‹¨ ìœ ì§€) ============ */
async function loadGroups(){
  const list=$("group-list"); list.innerHTML="";
  const snap=await db.collection("groups").orderBy("created","desc").get();
  if(snap.empty){ list.innerHTML='<div class="empty">ì•„ì§ ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; $("group-post-box").style.display="none"; return; }
  snap.forEach(doc=>{
    const g=doc.data();
    const card=document.createElement("div"); card.className="card";
    card.innerHTML=`<div class="row" style="justify-content:space-between"><div><h3>${g.name}</h3><div class="empty">${g.desc||""}</div></div><button class="btn" data-open>ë“¤ì–´ê°€ê¸°</button></div>`;
    card.querySelector("[data-open]").onclick=()=>openGroup(doc.id,g);
    list.appendChild(card);
  });
}
async function openGroup(id,g){
  currentGroup={id,...g}; $("group-title").textContent=g.name; $("group-post-box").style.display="block"; loadGroupPosts();
}
$("group-post-form").addEventListener("submit", async (e)=>{
  e.preventDefault(); if(!currentGroup) return;
  const name=$("gp-name").value.trim(); const text=$("gp-text").value.trim(); if(!name||!text) return;
  await db.collection("groupPosts").add({groupId:currentGroup.id,name,text,created:new Date()});
  $("gp-text").value=""; toast("ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!"); loadGroupPosts();
});
async function loadGroupPosts(){
  const box=$("group-posts"); box.innerHTML="";
  const snap=await db.collection("groupPosts").where("groupId","==",currentGroup.id).orderBy("created","desc").get();
  if(snap.empty){ box.innerHTML='<div class="empty">ì•„ì§ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  snap.forEach(doc=>{ const d=doc.data(); const el=document.createElement("div"); el.className="card"; el.innerHTML=`<strong>${d.name}</strong><p>${d.text.replace(/\n/g,"<br>")}</p>`; box.appendChild(el); });
}

/* ============ ADMIN ============ */
function adminLogin(){
  const pass=$("admin-pass").value; if(pass===ADMIN_PASSWORD){
    isAdmin=true; $("role").textContent="ê´€ë¦¬ì"; $("admin-login").style.display="none"; $("admin-panel").classList.add("show");
    renderAdminAll(); toast("ê´€ë¦¬ì ëª¨ë“œ");
  }else alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
}
async function renderAdminAll(){ await Promise.all([loadSeriesForAdmin(), loadAdminStories(), loadAdminSuggestions(), loadAdminGroups(), loadSeriesSelects()]); }

/* ì‹œë¦¬ì¦ˆ ì¶”ê°€/ì‚­ì œ */
$("series-add").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const name=$("se-name").value.trim(); const desc=$("se-desc").value.trim();
  if(!name) return;
  await db.collection("series").add({name,desc,created:new Date()});
  $("se-name").value=""; $("se-desc").value="";
  toast("ì‹œë¦¬ì¦ˆ ì¶”ê°€ë¨"); loadSeriesForAdmin(); loadSeriesTabs(); loadSeriesSelects();
});
async function loadSeriesForAdmin(){
  const box=$("admin-series"); box.innerHTML="";
  const snap=await db.collection("series").orderBy("created","desc").get();
  if(snap.empty){ box.innerHTML='<div class="empty">ì‹œë¦¬ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  snap.forEach(doc=>{
    const s=doc.data();
    const el=document.createElement("div"); el.className="card";
    el.innerHTML=`<b>${s.name}</b> <span class="empty">${s.desc||""}</span> <div class="row"><button class="btn" data-del>ì‚­ì œ</button></div>`;
    el.querySelector("[data-del]").onclick=async()=>{
      if(!confirm("ì‹œë¦¬ì¦ˆë¥¼ ì‚­ì œí• ê¹Œìš”? (ì´ë¯¸ ë“±ë¡ëœ ì±…ì€ ë‚¨ìŠµë‹ˆë‹¤)"))return;
      await db.collection("series").doc(doc.id).delete();
      toast("ì‹œë¦¬ì¦ˆ ì‚­ì œë¨"); loadSeriesForAdmin(); loadSeriesTabs(); loadSeriesSelects();
    };
    box.appendChild(el);
  });
}

/* ì±… ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ */
$("story-add").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const seriesId=$("st-series").value; const title=$("st-title").value.trim(); const text=$("st-text").value;
  if(!seriesId){ alert("ì‹œë¦¬ì¦ˆë¥¼ ì„ íƒí•˜ì„¸ìš”."); return; }
  if(!title) return;
  await db.collection("stories").add({seriesId,title,text,created:new Date()});
  $("st-title").value=""; $("st-text").value="";
  toast("ì±… ì¶”ê°€ë¨"); loadAdminStories(); if(currentSeriesId===seriesId || currentSeriesId===null) loadStoriesList();
});
async function loadAdminStories(){
  const box=$("admin-stories"); box.innerHTML="";
  // ìµœì‹ ìˆœ + ì‹œë¦¬ì¦ˆëª… ë ˆì´ë¸”
  const seriesMap = await getSeriesMap();
  const snap=await db.collection("stories").orderBy("created","desc").get();
  if(snap.empty){ box.innerHTML='<div class="empty">ì±…ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  snap.forEach(doc=>{
    const s=doc.data();
    const el=document.createElement("div"); el.className="card";
    el.innerHTML=`<div class="empty">${seriesMap[s.seriesId]||"ì‹œë¦¬ì¦ˆ"}</div><b>${s.title}</b>
      <div class="row" style="margin-top:8px">
        <button class="btn" data-edit>ìˆ˜ì •</button>
        <button class="btn" data-del>ì‚­ì œ</button>
      </div>`;
    el.querySelector("[data-edit]").onclick=async()=>{
      const nt=prompt("ìƒˆ ì œëª©:", s.title); if(!nt) return;
      const nx=prompt("ë³¸ë¬¸(ë¹ˆì¹¸=ìœ ì§€):", s.text||"");
      await db.collection("stories").doc(doc.id).update({ title:nt, ...(nx!==""?{text:nx}:{}) });
      toast("ìˆ˜ì •ë¨"); loadAdminStories(); loadStoriesList();
    };
    el.querySelector("[data-del]").onclick=async()=>{
      if(!confirm("ì´ ì±…ì„ ì‚­ì œí• ê¹Œìš”?"))return;
      const sid=s.seriesId; await db.collection("stories").doc(doc.id).delete();
      toast("ì‚­ì œë¨"); loadAdminStories(); if(currentSeriesId===sid || currentSeriesId===null) loadStoriesList();
    };
    box.appendChild(el);
  });
}

/* ì œì•ˆ ìŠ¹ì¸ â†’ ì±…ìœ¼ë¡œ ë“±ë¡ */
async function loadAdminSuggestions(){
  const box=$("admin-suggestions"); box.innerHTML="";
  const seriesMap = await getSeriesMap();
  const snap=await db.collection("suggestions").orderBy("created","desc").get();
  if(snap.empty){ box.innerHTML='<div class="empty">ìŠ¹ì¸ ëŒ€ê¸° ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  snap.forEach(doc=>{
    const d=doc.data();
    const el=document.createElement("div"); el.className="card";
    el.innerHTML=`<div class="empty">${seriesMap[d.seriesId]||"ì‹œë¦¬ì¦ˆ"}</div><p style="margin:.2em 0"><b>${d.name}</b></p><p>${d.text.replace(/\n/g,"<br>")}</p>
      <div class="row"><button class="btn" data-approve>ì±…ìœ¼ë¡œ ë“±ë¡</button><button class="btn" data-remove>ì œì•ˆ ì‚­ì œ</button></div>`;
    el.querySelector("[data-approve]").onclick=async()=>{
      const title=prompt("ìƒˆ ì±… ì œëª©:"); if(!title) return;
      await db.collection("stories").add({seriesId:d.seriesId,title,text:d.text,created:new Date()});
      await db.collection("suggestions").doc(doc.id).delete();
      toast("ìŠ¹ì¸ë˜ì–´ ì±…ìœ¼ë¡œ ë“±ë¡ë¨"); loadAdminSuggestions(); if(currentSeriesId===d.seriesId || currentSeriesId===null) loadStoriesList();
    };
    el.querySelector("[data-remove]").onclick=async()=>{
      if(!confirm("ì´ ì œì•ˆì„ ì‚­ì œí• ê¹Œìš”?"))return;
      await db.collection("suggestions").doc(doc.id).delete(); toast("ì‚­ì œë¨"); loadAdminSuggestions();
    };
    box.appendChild(el);
  });
}

/* ê·¸ë£¹ ê´€ë¦¬(ê°„ë‹¨) */
$("group-add").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const name=$("gr-name").value.trim(); const desc=$("gr-desc").value.trim(); if(!name) return;
  await db.collection("groups").add({name,desc,created:new Date()});
  $("gr-name").value=""; $("gr-desc").value=""; toast("ê·¸ë£¹ ìƒì„±ë¨"); loadGroups(); loadAdminGroups();
});
async function loadAdminGroups(){
  const box=$("admin-groups"); box.innerHTML="";
  const snap=await db.collection("groups").orderBy("created","desc").get();
  if(snap.empty){ box.innerHTML='<div class="empty">ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  snap.forEach(doc=>{
    const g=doc.data(); const el=document.createElement("div"); el.className="card";
    el.innerHTML=`<b>${g.name}</b> <span class="empty">${g.desc||""}</span> <div class="row"><button class="btn" data-del>ì‚­ì œ</button></div>`;
    el.querySelector("[data-del]").onclick=async()=>{
      if(!confirm("ì´ ê·¸ë£¹ì„ ì‚­ì œí• ê¹Œìš”? (ê²Œì‹œê¸€ì€ ìœ ì§€)"))return;
      await db.collection("groups").doc(doc.id).delete(); toast("ì‚­ì œë¨"); loadAdminGroups(); loadGroups();
    };
    box.appendChild(el);
  });
}
</script>
</body>
</html>
