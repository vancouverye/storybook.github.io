<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ì—°í˜¸ì˜ ìŠ¤í† ë¦¬ë¶ â€” Final High-End Version</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Pretendard:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0f18; --bg2:#0d1220;
  --glass:#0f1726cc; --glass-solid:#0f1726;
  --ink:#eaf1fb; --mut:#99aec5; --mute:#7d91a7;
  --line:#1c2a40; --pri:#77a5ff; --pri-2:#5c86f7; --pri-3:#3f65e6;
  --r:16px; --shadow:0 22px 55px rgba(0,0,0,.45);
}
*{box-sizing:border-box}
body{
  margin:0;font-family:Inter,Pretendard,system-ui,-apple-system;
  background:linear-gradient(180deg,#0a0f18,#0c1424 45%,#0a0f18);
  color:var(--ink);
}
.app{display:grid;grid-template-rows:68px 1fr;min-height:100vh}
.header{position:sticky;top:0;display:flex;align-items:center;gap:12px;padding:10px 16px;
background:#0b1322cc;border-bottom:1px solid var(--line);backdrop-filter:blur(12px);z-index:100}
.brand{font-weight:800;font-size:18px}
.header-nav{margin-left:auto;display:flex;gap:8px}
.btn{background:linear-gradient(180deg,#111b33,#0d1629);border:1px solid var(--line);
color:var(--ink);padding:8px 12px;border-radius:12px;cursor:pointer;transition:.2s}
.btn:hover{border-color:#2a3b5e;transform:translateY(-1px)}
.btn.pri{background:linear-gradient(180deg,var(--pri),var(--pri-2));color:#fff;border:none}
.section{display:none}.section.show{display:block}
.main{padding:22px}.container{max-width:1200px;margin:0 auto;display:grid;gap:18px}
.card{background:var(--glass);border:1px solid var(--line);border-radius:var(--r);
box-shadow:var(--shadow);padding:16px}
.tabs{display:flex;gap:10px;overflow:auto;padding:10px 2px}
.tab{border:1px solid var(--line);background:#0e1627;color:var(--ink);padding:8px 14px;
border-radius:999px;cursor:pointer;white-space:nowrap}
.tab.active{border-color:transparent;background:linear-gradient(90deg,var(--pri-2),var(--pri-3));color:#fff}
.story{background:linear-gradient(180deg,#0f1a2e,#0f1729);border:1px solid var(--line);
border-radius:18px;padding:16px;margin:8px 0;position:relative}
.story h4{margin:0}.story p{margin:6px 0;color:var(--mute)}
.actions{display:flex;gap:8px;margin-top:8px}
.spinner{width:44px;height:44px;border:3px solid #1a2840;border-top-color:var(--pri);
border-radius:50%;animation:spin 1s linear infinite;margin:20px auto}@keyframes spin{to{transform:rotate(360deg)}}
.modal{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:300}
.modal.on{display:flex}
.modal .box{width:min(780px,92vw);background:var(--glass-solid);border:1px solid var(--line);
border-radius:18px;box-shadow:var(--shadow);padding:16px}
.toast{position:fixed;right:16px;bottom:16px;background:#0b1322e6;border:1px solid var(--line);
padding:10px 14px;border-radius:12px;display:none}
input,textarea,select{width:100%;background:#0b1422;border:1px solid var(--line);
color:var(--ink);padding:10px;border-radius:12px}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="brand">ğŸ“š ì—°í˜¸ì˜ ìŠ¤í† ë¦¬ë¶</div>
    <div class="header-nav">
      <button class="btn" data-page="home">í™ˆ</button>
      <button class="btn" data-page="stories">ìŠ¤í† ë¦¬ë¶</button>
      <button class="btn" data-page="admin">ê´€ë¦¬ì</button>
    </div>
  </div>

  <div class="main">
    <div class="container">
      <section id="home" class="section show">
        <div class="card">
          <h2>í™˜ì˜í•©ë‹ˆë‹¤ ğŸ‘‹</h2>
          <p>ì‹œë¦¬ì¦ˆë³„ ì±…ì„ ë³´ê³ , ìƒˆë¡œìš´ ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”.</p>
        </div>
      </section>

      <section id="stories" class="section">
        <div class="card">
          <h2>ìŠ¤í† ë¦¬ë¶</h2>
          <div id="series-tabs" class="tabs"></div>
          <div id="series-desc" class="empty"></div>
          <div id="story-list"></div>
          <div id="story-loading" class="spinner" style="display:none"></div>
        </div>
      </section>

      <section id="admin" class="section">
        <div id="admin-login" class="card">
          <h2>ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
          <input id="admin-pass" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
          <button class="btn pri" id="btnAdminLogin">ë¡œê·¸ì¸</button>
        </div>
        <div id="admin-panel" class="card" style="display:none">
          <h3>ê´€ë¦¬ ì½˜ì†”</h3>
          <button class="btn pri" id="openSeries">+ ì‹œë¦¬ì¦ˆ ì¶”ê°€</button>
          <button class="btn pri" id="openStory">+ ì±… ì¶”ê°€</button>
          <div id="admin-series"></div>
          <div id="admin-stories"></div>
        </div>
      </section>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<!-- ë²„ì „ í‘œì‹œ -->
<div id="version-box" style="position:fixed;right:14px;bottom:14px;
background:rgba(15,23,38,0.8);border:1px solid #1c2a40;
border-radius:10px;font-size:13px;color:#9fb0c3;
padding:6px 12px;backdrop-filter:blur(10px);z-index:200;">v0.0.0</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
/* ================= Firebase ================= */
const firebaseConfig = {
  apiKey: "AIzaSyBEBA0ZUVcMBG_G9CtauP02kh4Wneg-5gA",
  authDomain: "storybook-4a13b.firebaseapp.com",
  projectId: "storybook-4a13b",
  storageBucket: "storybook-4a13b.firebasestorage.app",
  messagingSenderId: "756981563455",
  appId: "1:756981563455:web:b0bef64ba3ca2fb39a788a",
  measurementId: "G-CPXLQYTYJY"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================= ê¸°ë³¸ ìœ í‹¸ ================= */
const $=id=>document.getElementById(id);
const $$=sel=>Array.from(document.querySelectorAll(sel));
function toast(msg){const t=$("toast");t.textContent=msg;t.style.display="block";setTimeout(()=>t.style.display="none",1800);}
function show(id){$$(".section").forEach(s=>s.classList.remove("show"));$(id).classList.add("show");}
function esc(s){return String(s??"").replace(/[&<>]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m]));}

/* ================= ë„¤ë¹„ ================= */
$$("[data-page]").forEach(b=>b.onclick=()=>show(b.dataset.page));

/* ================= STORIES ================= */
let currentSeries="ALL",isAdmin=false;

async function loadSeriesTabs(){
  $("series-tabs").innerHTML="";$("series-desc").textContent="";
  const tabs=$("series-tabs");
  const all=document.createElement("button");
  all.className="tab";all.textContent="ì „ì²´";
  all.onclick=()=>{currentSeries="ALL";highlightTabs();loadStories();};
  tabs.appendChild(all);
  const snap=await db.collection("series").orderBy("created","desc").get();
  snap.forEach(doc=>{
    const s=doc.data();
    const b=document.createElement("button");
    b.className="tab";b.textContent=s.name;b.dataset.sid=doc.id;
    b.onclick=()=>{currentSeries=doc.id;highlightTabs();$("series-desc").textContent=s.desc||"";loadStories();};
    tabs.appendChild(b);
  });
  currentSeries="ALL";highlightTabs();loadStories();
}
function highlightTabs(){$$(".tab").forEach(t=>t.classList.toggle("active",t.dataset.sid===currentSeries||t.textContent==="ì „ì²´"&&currentSeries==="ALL"));}
async function loadStories(){
  const list=$("story-list");list.innerHTML="";$("story-loading").style.display="block";
  let q=db.collection("stories").orderBy("created","desc");
  if(currentSeries!=="ALL")q=q.where("seriesId","==",currentSeries);
  const snap=await q.get();$("story-loading").style.display="none";
  if(snap.empty){list.innerHTML='<div class="empty">ì±…ì´ ì—†ìŠµë‹ˆë‹¤.</div>';return;}
  snap.forEach(doc=>{const s=doc.data();const el=document.createElement("div");el.className="story";el.innerHTML=`<h4>${s.title}</h4><p>${(s.text||"").slice(0,200)}${(s.text||"").length>200?"â€¦":""}</p>`;list.appendChild(el);});
}
loadSeriesTabs();

/* ================= ADMIN ================= */
$("btnAdminLogin").onclick=()=>{
  if($("admin-pass").value==="admin1234"){
    isAdmin=true;$("admin-login").style.display="none";$("admin-panel").style.display="block";renderAdmin();toast("ê´€ë¦¬ì ë¡œê·¸ì¸ ì™„ë£Œ");
  }else alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");
};
$("openSeries").onclick=()=>{
  const name=prompt("ì‹œë¦¬ì¦ˆ ì´ë¦„?");if(!name)return;
  const desc=prompt("ì„¤ëª… (ì„ íƒ)");
  db.collection("series").add({name,desc,created:new Date()}).then(()=>{toast("ì‹œë¦¬ì¦ˆ ì¶”ê°€ë¨");loadSeriesTabs();renderAdmin();});
};
$("openStory").onclick=async()=>{
  const sSnap=await db.collection("series").get();
  const opts=sSnap.docs.map(d=>`${d.data().name} (${d.id})`).join("\n");
  const sid=prompt("ì‹œë¦¬ì¦ˆ ID ì…ë ¥:\n"+opts);if(!sid)return;
  const title=prompt("ì±… ì œëª©?");const text=prompt("ë‚´ìš©?");
  await db.collection("stories").add({seriesId:sid,title,text,created:new Date()});
  toast("ì±… ì¶”ê°€ë¨");loadStories();renderAdmin();
};
async function renderAdmin(){
  const s=$("admin-series"),t=$("admin-stories");s.innerHTML="";t.innerHTML="";
  const sSnap=await db.collection("series").orderBy("created","desc").get();
  sSnap.forEach(d=>{const x=d.data();s.innerHTML+=`<div class='story'><h4>${x.name}</h4><p>${x.desc||""}</p></div>`;});
  const tSnap=await db.collection("stories").orderBy("created","desc").get();
  tSnap.forEach(d=>{const x=d.data();t.innerHTML+=`<div class='story'><h4>${x.title}</h4><p>${x.seriesId}</p></div>`;});
}

/* ================= VERSION SYSTEM ================= */
document.body.insertAdjacentHTML("afterbegin",`
  <div id="version-banner" style="position:fixed;top:-80px;left:0;right:0;
  background:rgba(20,33,60,0.95);border-bottom:1px solid #2a3b5e;
  color:#eaf1fb;text-align:center;padding:12px 20px;
  backdrop-filter:blur(12px);z-index:300;transition:top .5s ease;">
  <span id="version-banner-text"></span>
  <button id="banner-close" style="margin-left:12px;background:none;border:none;
  color:#9fb0c3;cursor:pointer;font-size:14px;">Ã—</button></div>`);

async function loadVersion(){
  try{
    const doc=await db.collection("meta").doc("version").get();
    if(doc.exists){
      const v=doc.data();
      $("version-box").textContent=v.number||"v0.0.0";
      $("version-box").title="ì—…ë°ì´íŠ¸: "+new Date(v.updated?.toDate?.()||Date.now()).toLocaleString();
      loadVersionNotice(v);
    }
  }catch(e){console.error("ë²„ì „ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨",e);}
}
loadVersion();
function loadVersionNotice(v){
  const cur=v.number||"v0.0.0";
  const last=localStorage.getItem("lastVersion");
  if(last!==cur){
    const msg=v.message||"ìƒˆë¡œìš´ ì—…ë°ì´íŠ¸ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!";
    $("version-banner-text").textContent=`${cur} â€” ${msg}`;
    $("version-banner").style.top="0";
    $("banner-close").onclick=()=>{ $("version-banner").style.top="-80px"; localStorage.setItem("lastVersion",cur); };
  }
}
function incrementVersion(v){const p=v.replace(/[^\d.]/g,"").split(".").map(n=>parseInt(n)||0);while(p.length<3)p.push(0);p[2]++;if(p[2]>=10){p[2]=0;p[1]++;}if(p[1]>=10){p[1]=0;p[0]++;}return`v${p.join(".")}`;}
function openVersionEditor(){
  const num=prompt("ìƒˆ ë²„ì „ ë²ˆí˜¸ (ì˜ˆ: v1.2.0)","v0.0.0");
  if(!num)return;
  const msg=prompt("ê³µì§€ ë©”ì‹œì§€","ìƒˆë¡œìš´ ì—…ë°ì´íŠ¸ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!");
  db.collection("meta").doc("version").set({number:num,message:msg,updated:new Date()});
  db.collection("versionHistory").add({version:num,message:msg,date:new Date()});
  localStorage.setItem("lastVersion",num);
  toast("ë²„ì „ ì—…ë°ì´íŠ¸ ì™„ë£Œ");loadVersion();
}
