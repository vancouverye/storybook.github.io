<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ì—°í˜¸ì˜ ìŠ¤í† ë¦¬ë¶</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0f18;--bg2:#0d1424;--glass:#0f1726cc;--solid:#0f1726;
  --line:#1c2a40;--ink:#eaf1fb;--mut:#9fb0c3;--mute:#7d91a7;
  --pri:#6ea3ff;--pri2:#4f7ef3;--r:16px;--sh:0 22px 55px rgba(0,0,0,.45);
}
*{box-sizing:border-box}html,body{height:100%}
body{
  margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;color:var(--ink);
  background:radial-gradient(70% 90% at 10% 0,#14213d 0,transparent 55%),
             radial-gradient(70% 80% at 100% 0,#12203a 0,transparent 50%),
             linear-gradient(180deg,#0a0f18 0,#0c1424 45%,#0a0f18 100%);
}
.app{display:grid;grid-template-rows:68px 1fr;min-height:100vh}
.header{
  position:sticky;top:0;z-index:50;display:flex;align-items:center;gap:12px;padding:10px 16px;
  background:#0b1322cc;border-bottom:1px solid var(--line);backdrop-filter:blur(12px)
}
.brand{font-weight:800}
.header-nav{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
.btn{
  background:linear-gradient(180deg,#111b33,#0d1629);border:1px solid var(--line);color:var(--ink);
  padding:10px 14px;border-radius:12px;cursor:pointer;transition:.15s;box-shadow:inset 0 -1px 0 rgba(255,255,255,.04)
}
.btn:hover{border-color:#2a3b5e;transform:translateY(-1px)}
.btn.pri{background:linear-gradient(180deg,var(--pri),var(--pri2));border-color:transparent;color:#fff}
.main{padding:22px}.container{max-width:1200px;margin:0 auto;display:grid;gap:18px}
.section{display:none}.section.show{display:block}
.card{background:var(--glass);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--sh);padding:16px}
.grid{display:grid;gap:16px}
.cols-2{grid-template-columns:repeat(2,1fr)}@media(max-width:940px){.cols-2{grid-template-columns:1fr}}
.tabs{display:flex;gap:10px;overflow:auto;padding:8px 2px}
.tab{border:1px solid var(--line);background:#0e1627;color:var(--ink);padding:8px 14px;border-radius:999px;white-space:nowrap;cursor:pointer}
.tab.active{border-color:transparent;background:linear-gradient(90deg,var(--pri),var(--pri2));color:#fff}
.story{
  background:linear-gradient(180deg,#0f1a2e,#0f1729);border:1px solid var(--line);
  border-radius:18px;padding:16px
}
.story h4{margin:0}.story p{margin:6px 0;color:var(--mute)}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
input,textarea,select{width:100%;background:#0b1422;border:1px solid var(--line);color:var(--ink);padding:11px;border-radius:12px}
textarea{resize:vertical}
.spinner{width:44px;height:44px;border:3px solid #1a2840;border-top-color:var(--pri);border-radius:50%;animation:spin 1s linear infinite;margin:20px auto}
@keyframes spin{to{transform:rotate(360deg)}}
.toast{position:fixed;right:16px;bottom:16px;background:#0b1322e6;border:1px solid var(--line);padding:10px 14px;border-radius:12px;display:none;z-index:400}
.modal{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:350}
.modal.on{display:flex}
.modal .box{width:min(780px,92vw);background:var(--solid);border:1px solid var(--line);border-radius:18px;box-shadow:var(--sh);padding:16px}
hr{border:none;border-top:1px solid var(--line);margin:12px 0}
.mut{color:var(--mut)}
.kbd{border:1px solid var(--line);border-radius:8px;padding:3px 8px;color:var(--mut);font-size:12px}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="brand">ğŸ“š ì—°í˜¸ì˜ ìŠ¤í† ë¦¬ë¶</div>
    <div class="header-nav">
      <button class="btn" data-page="home">í™ˆ</button>
      <button class="btn" data-page="stories">ìŠ¤í† ë¦¬ë¶</button>
      <button class="btn" data-page="groups">ê·¸ë£¹</button>
      <button class="btn pri" data-page="admin">ê´€ë¦¬ì</button>
    </div>
  </div>

  <div class="main">
    <div class="container">

      <!-- HOME -->
      <section id="home" class="section show">
        <div class="card">
          <h2>í™˜ì˜í•©ë‹ˆë‹¤ ğŸ‘‹</h2>
          <p>ì‹œë¦¬ì¦ˆ íƒ­ì„ ëˆŒëŸ¬ ì›í•˜ëŠ” ì±…ì„ ì°¾ì•„ë³´ì„¸ìš”. ê·¸ë£¹ì€ ê´€ë¦¬ìê°€ ë§Œë“¤ê³  ìš´ì˜í•©ë‹ˆë‹¤.</p>
        </div>
        <div class="card">
          <h3>ìµœê·¼ ì±…</h3>
          <div id="home-stories" class="grid cols-2"></div>
        </div>
      </section>

      <!-- STORIES -->
      <section id="stories" class="section">
        <div class="card">
          <h2>ìŠ¤í† ë¦¬buck</h2>
          <div id="series-tabs" class="tabs" style="margin-top:6px"></div>
          <div id="series-desc" class="mut" style="margin:6px 2px 10px"></div>
          <div id="story-list" class="grid cols-2"></div>
          <div id="story-loading" class="spinner" style="display:none"></div>
        </div>
      </section>

      <!-- GROUPS -->
      <section id="groups" class="section">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
            <h2>ê·¸ë£¹</h2>
            <span class="mut">ê´€ë¦¬ìê°€ ë§Œë“  ê·¸ë£¹ ì•ˆì—ì„œ ëˆ„êµ¬ë‚˜ ê¸€ì„ ì“¸ ìˆ˜ ìˆì–´ìš”.</span>
          </div>
        </div>
        <div id="group-list" class="grid cols-2"></div>

        <!-- ê·¸ë£¹ ìƒì„¸/ê²Œì‹œíŒ -->
        <div id="group-box" class="card" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
            <div>
              <h3 id="group-title">ê·¸ë£¹</h3>
              <div id="group-desc" class="mut"></div>
            </div>
            <div id="group-admin-actions" style="display:none;gap:8px" class="actions">
              <button class="btn" id="btnEditGroup">ê·¸ë£¹ ìˆ˜ì •</button>
              <button class="btn" id="btnDeleteGroup">ê·¸ë£¹ ì‚­ì œ</button>
            </div>
          </div>
          <hr/>
          <!-- ê¸€ì“°ê¸° -->
          <form id="group-post-form" class="grid" style="margin-bottom:8px">
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <input id="gp-author" class="small" placeholder="ì‘ì„±ì (ë‹‰ë„¤ì„)" required style="max-width:260px">
              <input id="gp-title" class="small" placeholder="ì œëª©" required style="flex:1">
              <button class="btn pri" type="submit" style="white-space:nowrap">ê¸€ ì˜¬ë¦¬ê¸°</button>
            </div>
            <textarea id="gp-text" rows="4" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”â€¦" required></textarea>
            <div class="mut"><span class="kbd">Tip</span> Enterë§Œ ëˆ„ë¥´ë©´ ì¤„ë°”ê¿ˆ, <span class="kbd">Shift</span> + Enterë¡œë„ ì¤„ë°”ê¿ˆ ë©ë‹ˆë‹¤.</div>
          </form>

          <h4 style="margin-top:10px">ê²Œì‹œê¸€</h4>
          <div id="group-posts" class="grid"></div>
          <div id="group-posts-loading" class="spinner" style="display:none"></div>
        </div>
      </section>

      <!-- ADMIN -->
      <section id="admin" class="section">
        <div id="admin-login" class="card">
          <h2>ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px">
            <input id="admin-pass" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (admin1234)" class="small" style="max-width:260px">
            <button class="btn pri" id="btnAdminLogin">ë¡œê·¸ì¸</button>
          </div>
        </div>

        <div id="admin-panel" class="card" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
            <h3>ê´€ë¦¬ ì½˜ì†”</h3>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn pri" id="openSeries">+ ì‹œë¦¬ì¦ˆ</button>
              <button class="btn pri" id="openStory">+ ì±…</button>
              <button class="btn pri" id="openGroup">+ ê·¸ë£¹</button>
            </div>
          </div>

          <div class="grid cols-2" style="margin-top:12px">
            <div>
              <h4>ì‹œë¦¬ì¦ˆ</h4>
              <div id="admin-series"></div>
            </div>
            <div>
              <h4>ì±…</h4>
              <div id="admin-stories"></div>
            </div>
          </div>

          <div style="margin-top:14px">
            <h4>ê·¸ë£¹</h4>
            <div id="admin-groups"></div>
          </div>
        </div>
      </section>

    </div>
  </div>
</div>

<!-- Modal / Toast -->
<div id="modal" class="modal"><div class="box">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
    <h3 id="modal-title">Modal</h3><button class="btn" id="modal-close">ë‹«ê¸°</button>
  </div>
  <div id="modal-body"></div>
</div></div>
<div id="toast" class="toast"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
/* ================== Firebase (í•„ìˆ˜) ================== */
const firebaseConfig = {
  apiKey: "AIzaSyBEBA0ZUVcMBG_G9CtauP02kh4Wneg-5gA",
  authDomain: "storybook-4a13b.firebaseapp.com",
  projectId: "storybook-4a13b",
  storageBucket: "storybook-4a13b.firebasestorage.app",
  messagingSenderId: "756981563455",
  appId: "1:756981563455:web:b0bef64ba3ca2fb39a788a",
  measurementId: "G-CPXLQYTYJY"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================== ê³µí†µ ìœ í‹¸ ================== */
const ADMIN_PASSWORD = "admin1234";
let isAdmin=false, currentSeries="ALL", currentGroup=null;

const $ = id => document.getElementById(id);
const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
const esc = s => String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
function show(id){ $$(".section").forEach(el=>el.classList.remove("show")); $(id).classList.add("show"); }
function toast(msg){ const t=$("toast"); t.textContent=msg; t.style.display="block"; setTimeout(()=>t.style.display="none",1600); }
function openModal(title,body){ $("modal-title").textContent=title; $("modal-body").innerHTML=body; $("modal").classList.add("on"); }
$("modal-close").onclick = () => $("modal").classList.remove("on");

/* ================== ë„¤ë¹„ ================== */
$$("[data-page]").forEach(b => b.addEventListener("click", () => {
  show(b.dataset.page);
  if (b.dataset.page==="home") loadHome();
  if (b.dataset.page==="stories") loadSeriesTabs();
  if (b.dataset.page==="groups") loadGroups();
  if (b.dataset.page==="admin" && isAdmin) renderAdmin();
}));

/* ================== HOME ================== */
async function loadHome(){
  const box=$("home-stories"); box.innerHTML="";
  const snap=await db.collection("stories").orderBy("created","desc").limit(6).get();
  if(snap.empty){ box.innerHTML='<div class="mut">ì•„ì§ ì±…ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  snap.forEach(d=>{
    const s=d.data();
    const el=document.createElement("div"); el.className="story";
    el.innerHTML = `<h4>${esc(s.title)}</h4>
      <p>${esc((s.text||"").slice(0,160))}${(s.text||"").length>160?"â€¦":""}</p>`;
    box.appendChild(el);
  });
}

/* ================== STORIES ================== */
async function loadSeriesTabs(){
  $("series-tabs").innerHTML=""; $("series-desc").textContent="";
  const tabs=$("series-tabs");

  // ì „ì²´ íƒ­
  const all=document.createElement("button");
  all.className="tab"; all.textContent="ì „ì²´";
  all.onclick=()=>{ currentSeries="ALL"; highlightTabs(); $("series-desc").textContent="ëª¨ë“  ì‹œë¦¬ì¦ˆì˜ ì±…"; loadStories(); };
  tabs.appendChild(all);

  // ì‹œë¦¬ì¦ˆ ëª©ë¡
  const snap=await db.collection("series").orderBy("created","desc").get();
  if(snap.empty){
    $("series-desc").textContent="ì‹œë¦¬ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ì„œ ì¶”ê°€í•˜ì„¸ìš”.";
  }else{
    snap.forEach(doc=>{
      const s=doc.data();
      const b=document.createElement("button");
      b.className="tab"; b.textContent=s.name; b.dataset.sid=doc.id;
      b.onclick=()=>{ currentSeries=doc.id; highlightTabs(); $("series-desc").textContent=s.desc||""; loadStories(); };
      tabs.appendChild(b);
    });
  }
  currentSeries="ALL"; highlightTabs(); $("series-desc").textContent="ëª¨ë“  ì‹œë¦¬ì¦ˆì˜ ì±…"; loadStories();
}
function highlightTabs(){
  $$(".tab").forEach(t=>{
    const active = (currentSeries==="ALL" && t.textContent==="ì „ì²´") || (t.dataset.sid===currentSeries);
    t.classList.toggle("active", active);
  });
}
async function loadStories(){
  const list=$("story-list"); list.innerHTML="";
  $("story-loading").style.display="block";

  let q = db.collection("stories").orderBy("created","desc");
  if(currentSeries && currentSeries!=="ALL") q = q.where("seriesId","==",currentSeries);

  const snap = await q.get();
  $("story-loading").style.display="none";

  if(snap.empty){ list.innerHTML='<div class="mut">ì´ ì‹œë¦¬ì¦ˆì—ëŠ” ì±…ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }

  snap.forEach(doc=>{
    const s=doc.data();
    const el=document.createElement("div"); el.className="story";
    el.innerHTML = `
      <h4>${esc(s.title)}</h4>
      <p>${esc((s.text||"").slice(0,220)).replace(/\n/g,"<br>")}${(s.text||"").length>220?"â€¦":""}</p>
      <div class="actions">
        <button class="btn" data-read>ì½ê¸°</button>
        ${isAdmin?'<button class="btn" data-edit>ìˆ˜ì •</button><button class="btn" data-del>ì‚­ì œ</button>':""}
      </div>`;
    el.querySelector("[data-read]").onclick=()=>openModal(s.title, `<div style="white-space:pre-wrap;line-height:1.65">${esc(s.text||"").replace(/\n/g,"<br>")}</div>`);
    if(isAdmin){
      el.querySelector("[data-edit]").onclick=()=>openEditStory(doc.id,s);
      el.querySelector("[data-del]").onclick=async()=>{
        if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
        await db.collection("stories").doc(doc.id).delete();
        toast("ì‚­ì œë¨"); loadStories(); renderAdmin();
      };
    }
    list.appendChild(el);
  });
}

/* ================== GROUPS (ëª©ë¡ & ìƒì„¸) ================== */
async function loadGroups(){
  const list=$("group-list"); list.innerHTML="";
  $("group-box").style.display="none";
  const snap=await db.collection("groups").orderBy("created","desc").get();
  if(snap.empty){ list.innerHTML='<div class="mut">ì•„ì§ ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }

  snap.forEach(doc=>{
    const g=doc.data();
    const el=document.createElement("div"); el.className="story";
    el.innerHTML = `
      <h4>${esc(g.name)}</h4>
      <p>${esc(g.desc||"")}</p>
      <div class="actions">
        <button class="btn pri" data-open>ë“¤ì–´ê°€ê¸°</button>
        ${isAdmin?'<button class="btn" data-edit>ìˆ˜ì •</button><button class="btn" data-del>ì‚­ì œ</button>':""}
      </div>`;
    el.querySelector("[data-open]").onclick=()=>openGroup(doc.id,g);
    if(isAdmin){
      el.querySelector("[data-edit]").onclick=()=>openEditGroup(doc.id,g);
      el.querySelector("[data-del]").onclick=async()=>{
        if(!confirm("ê·¸ë£¹ì„ ì‚­ì œí• ê¹Œìš”?")) return;
        await db.collection("groups").doc(doc.id).delete();
        toast("ì‚­ì œë¨"); loadGroups(); renderAdmin();
      };
    }
    list.appendChild(el);
  });
}

async function openGroup(id,g){
  currentGroup={id,...g};
  $("group-box").style.display="block";
  $("group-title").textContent = g.name;
  $("group-desc").textContent = g.desc || "";
  $("group-admin-actions").style.display = isAdmin ? "flex" : "none";
  $("btnEditGroup").onclick = ()=>openEditGroup(id,g);
  $("btnDeleteGroup").onclick = async ()=>{
    if(!confirm("ê·¸ë£¹ì„ ì‚­ì œí• ê¹Œìš”?")) return;
    await db.collection("groups").doc(id).delete();
    toast("ì‚­ì œë¨"); $("group-box").style.display="none"; loadGroups(); renderAdmin();
  };

  // ê¸€ì“°ê¸° í•¸ë“¤ëŸ¬
  const form=$("group-post-form");
  form.onsubmit = async (e)=>{
    e.preventDefault();
    const author=$("gp-author").value.trim();
    const title=$("gp-title").value.trim();
    const text=$("gp-text").value.trim();
    if(!author||!title||!text) return;
    await db.collection("groupPosts").add({groupId:id, author, title, text, pinned:false, created:new Date()});
    $("gp-text").value=""; $("gp-title").value="";
    toast("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
    loadGroupPosts(id);
  };

  loadGroupPosts(id);
}

async function loadGroupPosts(groupId){
  $("group-posts").innerHTML="";
  $("group-posts-loading").style.display="block";

  // ìµœì‹ ìˆœìœ¼ë¡œ ê°€ì ¸ì˜¨ ë’¤ í´ë¼ì´ì–¸íŠ¸ì—ì„œ pinned ë¨¼ì € ì •ë ¬
  const snap=await db.collection("groupPosts")
    .where("groupId","==",groupId)
    .orderBy("created","desc")
    .limit(50)
    .get();

  $("group-posts-loading").style.display="none";
  if(snap.empty){ $("group-posts").innerHTML='<div class="mut">ì•„ì§ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }

  const posts=[];
  snap.forEach(d=>posts.push({id:d.id,...d.data()}));
  posts.sort((a,b)=>((b.pinned?1:0)-(a.pinned?1:0)) || (b.created?.toMillis?.()||new Date(b.created).getTime()) - (a.created?.toMillis?.()||new Date(a.created).getTime()));

  posts.forEach(p=>{
    const el=document.createElement("div"); el.className="story";
    el.innerHTML=`
      <div class="mut">${p.pinned?'ğŸ“Œ ê³ ì •ë¨':''}</div>
      <h4>${esc(p.title)}</h4>
      <p>${esc(p.text).replace(/\n/g,"<br>")}</p>
      <div class="mut">${esc(p.author||"ìµëª…")} â€¢ ${formatDate(p.created)}</div>
      <div class="actions">
        ${isAdmin?`
          <button class="btn" data-pin>${p.pinned?'ê³ ì • í•´ì œ':'ê³ ì •'}</button>
          <button class="btn" data-edit>ìˆ˜ì •</button>
          <button class="btn" data-del>ì‚­ì œ</button>
        `:''}
      </div>
    `;
    if(isAdmin){
      el.querySelector("[data-pin]").onclick=async()=>{
        await db.collection("groupPosts").doc(p.id).update({pinned:!p.pinned});
        loadGroupPosts(groupId);
      };
      el.querySelector("[data-edit]").onclick=()=>openEditPost(p.id,p);
      el.querySelector("[data-del]").onclick=async()=>{
        if(!confirm("ê²Œì‹œê¸€ì„ ì‚­ì œí• ê¹Œìš”?")) return;
        await db.collection("groupPosts").doc(p.id).delete();
        toast("ì‚­ì œë¨"); loadGroupPosts(groupId);
      };
    }
    $("group-posts").appendChild(el);
  });
}
function formatDate(ts){
  try{
    if(typeof ts?.toDate==="function") return ts.toDate().toLocaleString();
    const d = new Date(ts);
    if(!isNaN(d)) return d.toLocaleString();
  }catch(e){}
  return "";
}

/* ================== ADMIN ================== */
$("btnAdminLogin").onclick=()=>{
  if($("admin-pass").value===ADMIN_PASSWORD){
    isAdmin=true;
    $("admin-login").style.display="none";
    $("admin-panel").style.display="block";
    toast("ê´€ë¦¬ì ë¡œê·¸ì¸ ì™„ë£Œ");
    renderAdmin();
  }else alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
};
function renderAdmin(){ loadAdminSeries(); loadAdminStories(); loadAdminGroups(); }

/* ---- ì‹œë¦¬ì¦ˆ CRUD ---- */
$("openSeries").onclick=()=>{
  openModal("ì‹œë¦¬ì¦ˆ ì¶”ê°€", `
    <form id="formSeries" class="grid">
      <input id="se-name" placeholder="ì‹œë¦¬ì¦ˆ ì´ë¦„" required>
      <input id="se-desc" placeholder="ì„¤ëª… (ì„ íƒ)">
      <div style="display:flex;justify-content:flex-end"><button class="btn pri" type="submit">ì¶”ê°€</button></div>
    </form>
  `);
  $("formSeries").onsubmit=async e=>{
    e.preventDefault();
    const name=$("se-name").value.trim(), desc=$("se-desc").value.trim();
    if(!name) return;
    await db.collection("series").add({name,desc,created:new Date()});
    toast("ì‹œë¦¬ì¦ˆ ì¶”ê°€ë¨"); $("modal").classList.remove("on"); loadSeriesTabs(); renderAdmin();
  };
};

async function loadAdminSeries(){
  const box=$("admin-series"); box.innerHTML="";
  const snap=await db.collection("series").orderBy("created","desc").get();
  if(snap.empty){ box.innerHTML='<div class="mut">ì‹œë¦¬ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  snap.forEach(doc=>{
    const s=doc.data();
    const el=document.createElement("div"); el.className="story";
    el.innerHTML = `<h4>${esc(s.name)}</h4><p>${esc(s.desc||"")}</p>
      <div class="actions">
        <button class="btn" data-edit>ìˆ˜ì •</button>
        <button class="btn" data-del>ì‚­ì œ</button>
      </div>`;
    el.querySelector("[data-edit]").onclick=()=>openEditSeries(doc.id,s);
    el.querySelector("[data-del]").onclick=async()=>{
      if(!confirm("ì‹œë¦¬ì¦ˆ ì‚­ì œ? (ì±…ì€ ë‚¨ìŠµë‹ˆë‹¤)")) return;
      await db.collection("series").doc(doc.id).delete();
      toast("ì‚­ì œë¨"); loadSeriesTabs(); renderAdmin();
    };
    box.appendChild(el);
  });
}
function openEditSeries(id,s){
  openModal("ì‹œë¦¬ì¦ˆ ìˆ˜ì •", `
    <form id="formSeriesEdit" class="grid">
      <input id="se-name-e" value="${esc(s.name)}" required>
      <input id="se-desc-e" value="${esc(s.desc||"")}">
      <div style="display:flex;justify-content:flex-end"><button class="btn pri" type="submit">ì €ì¥</button></div>
    </form>
  `);
  $("formSeriesEdit").onsubmit=async e=>{
    e.preventDefault();
    const name=$("se-name-e").value.trim(); const desc=$("se-desc-e").value.trim();
    if(!name) return;
    await db.collection("series").doc(id).update({name,desc});
    toast("ìˆ˜ì •ë¨"); $("modal").classList.remove("on"); loadSeriesTabs(); renderAdmin();
  };
}

/* ---- ì±… CRUD ---- */
$("openStory").onclick=async()=>{
  const snap=await db.collection("series").orderBy("created","desc").get();
  if(snap.empty) return alert("ì‹œë¦¬ì¦ˆë¥¼ ë¨¼ì € ë§Œë“¤ì–´ì£¼ì„¸ìš”.");
  const opts = ['<option value="">(ì‹œë¦¬ì¦ˆ ì„ íƒ)</option>'];
  snap.forEach(d=>opts.push(`<option value="${d.id}">${esc(d.data().name)}</option>`));
  openModal("ì±… ì¶”ê°€", `
    <form id="formStory" class="grid">
      <select id="st-series" required>${opts.join("")}</select>
      <input id="st-title" placeholder="ì±… ì œëª©" required>
      <textarea id="st-text" rows="6" placeholder="ë³¸ë¬¸ (ì„ íƒ)"></textarea>
      <div style="display:flex;justify-content:flex-end"><button class="btn pri" type="submit">ì¶”ê°€</button></div>
    </form>
  `);
  $("formStory").onsubmit=async e=>{
    e.preventDefault();
    const seriesId=$("st-series").value; const title=$("st-title").value.trim(); const text=$("st-text").value;
    if(!seriesId || !title) return;
    await db.collection("stories").add({seriesId,title,text,created:new Date()});
    toast("ì±… ì¶”ê°€ë¨"); $("modal").classList.remove("on"); loadStories(); renderAdmin();
  };
};

async function loadAdminStories(){
  const box=$("admin-stories"); box.innerHTML="";
  const map=await getSeriesMap();
  const snap=await db.collection("stories").orderBy("created","desc").get();
  if(snap.empty){ box.innerHTML='<div class="mut">ì±…ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  snap.forEach(doc=>{
    const s=doc.data();
    const el=document.createElement("div"); el.className="story";
    el.innerHTML = `<div class="mut">${esc(map[s.seriesId]||"ì‹œë¦¬ì¦ˆ ë¯¸ì§€ì •")}</div>
      <h4>${esc(s.title)}</h4>
      <div class="actions">
        <button class="btn" data-edit>ìˆ˜ì •</button>
        <button class="btn" data-del>ì‚­ì œ</button>
      </div>`;
    el.querySelector("[data-edit]").onclick=()=>openEditStory(doc.id,s);
    el.querySelector("[data-del]").onclick=async()=>{
      if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
      await db.collection("stories").doc(doc.id).delete();
      toast("ì‚­ì œë¨"); loadStories(); renderAdmin();
    };
    box.appendChild(el);
  });
}
function openEditStory(id,s){
  openModal("ì±… ìˆ˜ì •", `
    <form id="formStoryEdit" class="grid">
      <input id="ed-title" value="${esc(s.title||"")}" required>
      <textarea id="ed-text" rows="6">${esc(s.text||"")}</textarea>
      <div style="display:flex;justify-content:flex-end"><button class="btn pri" type="submit">ì €ì¥</button></div>
    </form>
  `);
  $("formStoryEdit").onsubmit=async e=>{
    e.preventDefault();
    const title=$("ed-title").value.trim(); const text=$("ed-text").value;
    if(!title) return;
    await db.collection("stories").doc(id).update({title,text});
    toast("ìˆ˜ì •ë¨"); $("modal").classList.remove("on"); loadStories(); renderAdmin();
  };
}

/* ---- ê·¸ë£¹ CRUD ---- */
$("openGroup").onclick=()=>{
  openModal("ê·¸ë£¹ ì¶”ê°€", `
    <form id="formGroup" class="grid">
      <input id="gp-name" placeholder="ê·¸ë£¹ ì´ë¦„" required>
      <input id="gp-desc" placeholder="ì„¤ëª… (ì„ íƒ)">
      <div style="display:flex;justify-content:flex-end"><button class="btn pri" type="submit">ì¶”ê°€</button></div>
    </form>
  `);
  $("formGroup").onsubmit=async e=>{
    e.preventDefault();
    const name=$("gp-name").value.trim(); const desc=$("gp-desc").value.trim();
    if(!name) return;
    await db.collection("groups").add({name,desc,created:new Date()});
    toast("ê·¸ë£¹ ì¶”ê°€ë¨"); $("modal").classList.remove("on"); loadGroups(); renderAdmin();
  };
};

async function loadAdminGroups(){
  const box=$("admin-groups"); box.innerHTML="";
  const snap=await db.collection("groups").orderBy("created","desc").get();
  if(snap.empty){ box.innerHTML='<div class="mut">ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  snap.forEach(doc=>{
    const g=doc.data();
    const el=document.createElement("div"); el.className="story";
    el.innerHTML = `<h4>${esc(g.name)}</h4><p>${esc(g.desc||"")}</p>
      <div class="actions">
        <button class="btn" data-edit>ìˆ˜ì •</button>
        <button class="btn" data-del>ì‚­ì œ</button>
      </div>`;
    el.querySelector("[data-edit]").onclick=()=>openEditGroup(doc.id,g);
    el.querySelector("[data-del]").onclick=async()=>{
      if(!confirm("ê·¸ë£¹ ì‚­ì œ?")) return;
      await db.collection("groups").doc(doc.id).delete();
      toast("ì‚­ì œë¨"); loadGroups(); renderAdmin();
    };
    box.appendChild(el);
  });
}
function openEditGroup(id,g){
  openModal("ê·¸ë£¹ ìˆ˜ì •", `
    <form id="formGroupEdit" class="grid">
      <input id="gp-name-e" value="${esc(g.name||"")}" required>
      <input id="gp-desc-e" value="${esc(g.desc||"")}">
      <div style="display:flex;justify-content:flex-end"><button class="btn pri" type="submit">ì €ì¥</button></div>
    </form>
  `);
  $("formGroupEdit").onsubmit=async e=>{
    e.preventDefault();
    const name=$("gp-name-e").value.trim(); const desc=$("gp-desc-e").value.trim();
    if(!name) return;
    await db.collection("groups").doc(id).update({name,desc});
    toast("ìˆ˜ì •ë¨"); $("modal").classList.remove("on"); loadGroups(); renderAdmin();
  };
}

/* ---- ê²Œì‹œê¸€ ìˆ˜ì • ëª¨ë‹¬ ---- */
function openEditPost(id,p){
  openModal("ê²Œì‹œê¸€ ìˆ˜ì •", `
    <form id="formPostEdit" class="grid">
      <input id="pe-title" value="${esc(p.title||"")}" required>
      <textarea id="pe-text" rows="6">${esc(p.text||"")}</textarea>
      <label style="display:flex;gap:8px;align-items:center">
        <input id="pe-pin" type="checkbox" ${p.pinned?'checked':''} style="width:auto">
        <span>ìƒë‹¨ ê³ ì •</span>
      </label>
      <div style="display:flex;justify-content:flex-end"><button class="btn pri" type="submit">ì €ì¥</button></div>
    </form>
  `);
  $("formPostEdit").onsubmit=async e=>{
    e.preventDefault();
    const title=$("pe-title").value.trim(); const text=$("pe-text").value; const pinned=$("pe-pin").checked;
    if(!title) return;
    await db.collection("groupPosts").doc(id).update({title,text,pinned});
    toast("ìˆ˜ì •ë¨"); $("modal").classList.remove("on"); loadGroupPosts(currentGroup.id);
  };
}

/* ================== Helpers ================== */
async function getSeriesMap(){ const map={}; const s=await db.collection("series").get(); s.forEach(d=>map[d.id]=d.data().name); return map; }

/* ================== Init ================== */
window.addEventListener("load",()=>{
  show("home");
  loadHome();
  loadSeriesTabs();
  loadGroups();
});
</script>
</body>
</html>
