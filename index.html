<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ì—°ìŠ¤- No.1 ìŠ¤í† ë¦¬ë¶ í”Œë«í¼</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0a0f18;--bg2:#0d1424;--glass:#0f1726cc;--solid:#0f1726;
      --line:#1c2a40;--ink:#eaf1fb;--mut:#9fb0c3;--mute:#7d91a7;
      --pri:#6ea3ff;--pri2:#4f7ef3;--r:16px;--sh:0 22px 55px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;color:var(--ink);
      background:
        radial-gradient(70% 90% at 10% 0,#14213d 0,transparent 55%),
        radial-gradient(70% 80% at 100% 0,#12203a 0,transparent 50%),
        linear-gradient(180deg,#0a0f18 0,#0c1424 45%,#0a0f18 100%);
    }
    .app{display:grid;grid-template-rows:68px 1fr;min-height:100vh}
    .header{
      position:sticky;top:0;z-index:50;display:flex;align-items:center;gap:12px;padding:10px 16px;
      background:#0b1322cc;border-bottom:1px solid var(--line);backdrop-filter:blur(12px)
    }
    .brand{font-weight:800}
    .header-nav{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      background:linear-gradient(180deg,#111b33,#0d1629);border:1px solid var(--line);color:var(--ink);
      padding:10px 14px;border-radius:12px;cursor:pointer;transition:.15s;box-shadow:inset 0 -1px 0 rgba(255,255,255,.04)
    }
    .btn:hover{border-color:#2a3b5e;transform:translateY(-1px)}
    .btn.pri{background:linear-gradient(180deg,var(--pri),var(--pri2));border-color:transparent;color:#fff}
    .main{padding:22px}
    .container{max-width:1200px;margin:0 auto;display:grid;gap:18px}
    .section{display:none}.section.show{display:block}
    .card{background:var(--glass);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--sh);padding:16px}
    .grid{display:grid;gap:16px}
    .cols-2{grid-template-columns:repeat(2,1fr)}
    @media(max-width:940px){.cols-2{grid-template-columns:1fr}}
    .tabs{display:flex;gap:10px;overflow:auto;padding:8px 2px}
    .tab{border:1px solid var(--line);background:#0e1627;color:var(--ink);padding:8px 14px;border-radius:999px;white-space:nowrap;cursor:pointer}
    .tab.active{border-color:transparent;background:linear-gradient(90deg,var(--pri),var(--pri2));color:#fff}
    .story{
      background:linear-gradient(180deg,#0f1a2e,#0f1729);border:1px solid var(--line);
      border-radius:18px;padding:16px;
      cursor:pointer;transition:transform .15s;
    }
    .story:hover{transform:translateY(-2px);background:#101a2f}
    .story h4{margin:0}.story p{margin:6px 0;color:var(--mute)}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    input,textarea,select{width:100%;background:#0b1422;border:1px solid var(--line);color:var(--ink);padding:11px;border-radius:12px}
    textarea{resize:vertical}
    .spinner{width:44px;height:44px;border:3px solid #1a2840;border-top-color:var(--pri);border-radius:50%;animation:spin 1s linear infinite;margin:20px auto}
    @keyframes spin{to{transform:rotate(360deg)}}
    .toast{position:fixed;right:16px;bottom:16px;background:#0b1322e6;border:1px solid var(--line);padding:10px 14px;border-radius:12px;display:none;z-index:400}
    .modal{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:350}
    .modal.on{display:flex}
    .modal .box{
      width:min(780px,92vw);
      max-height:90vh; overflow-y:auto;  /* ê¸´ ë³¸ë¬¸ë„ ë³´ê¸° OK */
      background:var(--solid);border:1px solid var(--line);border-radius:18px;box-shadow:var(--sh);padding:16px
    }
    hr{border:none;border-top:1px solid var(--line);margin:12px 0}
    .mut{color:var(--mut)}
    .kbd{border:1px solid var(--line);border-radius:8px;padding:3px 8px;color:var(--mut);font-size:12px}
    .badge{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:#b9c8dc}

    /* ëª¨ë°”ì¼ ìµœì í™” */
    @media(max-width:600px){
      .main{padding:12px}
      .grid.cols-2{grid-template-columns:1fr}
      .story{padding:12px;font-size:15px}
      .header{flex-wrap:wrap;gap:6px}
      .header-nav{width:100%;justify-content:center}
      .btn{padding:8px 10px;font-size:14px}
      h2,h3,h4{font-size:18px}
    }
  </style>
</head>
<body>
<div class="app">
  <!-- Header -->
  <div class="header">
    <div class="brand">ğŸ“š ì—°ìŠ¤- No.1 ìŠ¤í† ë¦¬ë¶ í”Œë«í¼</div>
    <div class="header-nav">
      <button class="btn" data-page="home">í™ˆ</button>
      <button class="btn" data-page="stories">ìŠ¤í† ë¦¬ë¶</button>
      <button class="btn" data-page="next">ì±… ë§Œë“¤ê¸°</button>
      <button class="btn" data-page="groups">ê·¸ë£¹</button>
      <button class="btn" data-page="leaderboard">ë¦¬ë”ë³´ë“œ</button><!-- âœ… ì¶”ê°€ -->
      <button class="btn" data-page="profile">í”„ë¡œí•„</button><!-- âœ… ì¶”ê°€ -->
      <button class="btn pri" data-page="admin">ê´€ë¦¬ì</button>
    </div>
  </div>

  <!-- Main -->
  <div class="main">
    <div class="container">

      <!-- HOME -->
      <section id="home" class="section show">
        <div class="card">
          <h2>í™˜ì˜í•©ë‹ˆë‹¤ ğŸ‘‹</h2>
          <p>ê·¸ë£¹ì— ë“¤ì–´ê°€ ìŠ¤í¬ì¼ëŸ¬ë¥¼ ì½ìœ¼ì‹¤ìˆ˜ ìˆì–´ìš”. â€˜ì±… ë§Œë“¤ê¸°â€™ì—ì„œ ëˆ„êµ¬ë‚˜ ìƒˆë¡œìš´ ì´ì•¼ê¸°ë¥¼ ì œì•ˆí•  ìˆ˜ ìˆì–´ìš”.</p>
        </div>
        <div class="card">
          <h3>ìµœê·¼ ì±…</h3>
          <div id="home-stories" class="grid cols-2"></div>
        </div>
        <div class="card">
          <h3>ğŸ† ë¦¬ë”ë³´ë“œ Top 10</h3>
          <div id="leaderboard-home" class="grid"></div>
        </div>
      </section>

      <!-- STORIES -->
      <section id="stories" class="section">
        <div class="card">
          <h2>ìŠ¤í† ë¦¬ë¶</h2>
          <div id="series-tabs" class="tabs" style="margin-top:6px"></div>
          <div id="series-desc" class="mut" style="margin:6px 2px 10px"></div>
          <div id="story-list" class="grid cols-2"></div>
          <div id="story-loading" class="spinner" style="display:none"></div>
        </div>
      </section>

      <!-- NEXT (Proposals) -->
      <section id="next" class="section">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
            <h2>ì±… ë§Œë“¤ê¸°</h2>
            <span class="mut">ëˆ„êµ¬ë‚˜ ì œì•ˆí•  ìˆ˜ ìˆì–´ìš”. ê´€ë¦¬ìê°€ ìŠ¹ì¸í•˜ë©´ ìŠ¤í† ë¦¬ë¶ìœ¼ë¡œ ì˜¬ë¼ê°‘ë‹ˆë‹¤.</span>
          </div>
        </div>
        <div class="card">
          <form id="next-form" class="grid">
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <input id="nx-author" placeholder="ì‘ì„±ì (ë‹‰ë„¤ì„)" required style="max-width:260px">
              <input id="nx-title" placeholder="ì œëª©" required style="flex:1">
              <button class="btn pri" type="submit" style="white-space:nowrap">ì œì•ˆ ì˜¬ë¦¬ê¸°</button>
            </div>
            <textarea id="nx-text" rows="5" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”â€¦" required></textarea>
          </form>
        </div>
        <div class="card">
          <h3>ì œì•ˆ ëª©ë¡</h3>
          <div id="next-list" class="grid"></div>
          <div id="next-loading" class="spinner" style="display:none"></div>
        </div>
      </section>

      <!-- GROUPS -->
      <section id="groups" class="section">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
            <h2>ê·¸ë£¹</h2>
            <span class="mut">ê·¸ë£¹ ì•ˆì—ì„œ ëˆ„êµ¬ë‚˜ ê¸€ì„ ì“¸ ìˆ˜ ìˆì–´ìš”.</span>
          </div>
        </div>
        <div id="group-list" class="grid cols-2"></div>

        <!-- ê·¸ë£¹ ìƒì„¸/ê²Œì‹œíŒ -->
        <div id="group-box" class="card" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
            <div>
              <h3 id="group-title">ê·¸ë£¹</h3>
              <div id="group-desc" class="mut"></div>
            </div>
            <div id="group-admin-actions" style="display:none;gap:8px" class="actions">
              <button class="btn" id="btnEditGroup">ê·¸ë£¹ ìˆ˜ì •</button>
              <button class="btn" id="btnDeleteGroup">ê·¸ë£¹ ì‚­ì œ</button>
            </div>
          </div>
          <hr/>
          <!-- ê¸€ì“°ê¸° -->
          <form id="group-post-form" class="grid" style="margin-bottom:8px">
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <input id="gp-author" class="small" placeholder="ì‘ì„±ì (ë‹‰ë„¤ì„)" required style="max-width:260px">
              <input id="gp-title" class="small" placeholder="ì œëª©" required style="flex:1">
              <button class="btn pri" type="submit" style="white-space:nowrap">ê¸€ ì˜¬ë¦¬ê¸°</button>
            </div>
            <textarea id="gp-text" rows="4" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”â€¦" required></textarea>
            <div class="mut">
              <span class="kbd">Tip</span> Enterë§Œ ëˆ„ë¥´ë©´ ì¤„ë°”ê¿ˆ, <span class="kbd">Shift</span>+Enterë„ ì¤„ë°”ê¿ˆ.
            </div>
          </form>

          <h4 style="margin-top:10px">ê²Œì‹œê¸€</h4>
          <div id="group-posts" class="grid"></div>
          <div id="group-posts-loading" class="spinner" style="display:none"></div>
        </div>
      </section>

      <!-- LEADERBOARD (Top 10) -->
      <section id="leaderboard" class="section">
        <div class="card">
          <h2>ğŸ† ë¦¬ë”ë³´ë“œ Top 10</h2>
          <p class="mut">ê°€ì¥ ë†’ì€ ëˆ„ì  í¬ì¸íŠ¸ ìˆœ</p>
          <div id="leaderboard-list" class="grid cols-2"></div>
        </div>
      </section>

      <!-- PROFILE -->
      <section id="profile" class="section">
        <div class="card">
          <h2>ğŸ‘¤ ë‚´ í”„ë¡œí•„</h2>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0">
            <input id="prof-name" placeholder="ë‹‰ë„¤ì„" style="max-width:260px">
            <button class="btn" id="btnSaveName">ë‹‰ë„¤ì„ ì €ì¥</button>
          </div>
          <div id="profile-box" class="mut">ë‹‰ë„¤ì„ì„ ì €ì¥í•˜ê³  í€´ì¦ˆë¥¼ í’€ë©´ ë‚´ í¬ì¸íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
      </section>

      <!-- ADMIN -->
      <section id="admin" class="section">
        <div id="admin-login" class="card">
          <h2>ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px">
            <input id="admin-pass" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="small" style="max-width:260px">
            <button class="btn pri" id="btnAdminLogin">ë¡œê·¸ì¸</button>
          </div>
        </div>

        <div id="admin-panel" class="card" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
            <h3>ê´€ë¦¬ ì½˜ì†”</h3>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn pri" id="openSeries">+ ì‹œë¦¬ì¦ˆ</button>
              <button class="btn pri" id="openStory">+ ì±…</button>
              <button class="btn pri" id="openGroup">+ ê·¸ë£¹</button>
            </div>
          </div>

          <div class="grid cols-2" style="margin-top:12px">
            <div>
              <h4>ì‹œë¦¬ì¦ˆ</h4>
              <div id="admin-series"></div>
            </div>
            <div>
              <h4>ì±…</h4>
              <div id="admin-stories"></div>
            </div>
          </div>

          <div style="margin-top:14px">
            <h4>ê·¸ë£¹</h4>
            <div id="admin-groups"></div>
          </div>

          <div style="margin-top:14px">
            <h4>â€˜ì±… ë§Œë“¤ê¸°â€™ ì œì•ˆ ê´€ë¦¬</h4>
            <div id="admin-next"></div>
          </div>
        </div>
      </section>

    </div>
  </div>
</div>

<!-- Modal / Toast -->
<div id="modal" class="modal">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <h3 id="modal-title">Modal</h3>
      <div style="display:flex;gap:8px">
        <button class="btn" id="modal-quiz" style="display:none">í€´ì¦ˆ í’€ê¸°</button><!-- âœ… ë™ì  í‘œì‹œ -->
        <button class="btn" id="modal-close">ë‹«ê¸°</button>
      </div>
    </div>
    <div id="modal-body"></div>
  </div>
</div>
<div id="toast" class="toast"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
/* ================== Firebase (í•„ìˆ˜: config ë¶™ì´ê¸°) ================== */
const firebaseConfig = {
  apiKey: "AIzaSyBEBA0ZUVcMBG_G9CtauP02kh4Wneg-5gA",
  authDomain: "storybook-4a13b.firebaseapp.com",
  projectId: "storybook-4a13b",
  storageBucket: "storybook-4a13b.firebasestorage.app",
  messagingSenderId: "756981563455",
  appId: "1:756981563455:web:b0bef64ba3ca2fb39a788a",
  measurementId: "G-CPXLQYTYJY"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================== ê³µí†µ ìœ í‹¸ ================== */
const ADMIN_PASSWORD = "admin5848";
let isAdmin=false, currentSeries="ALL", currentGroup=null;

const $ = id => document.getElementById(id);
const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
const esc = s => String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
function show(id){ $$(".section").forEach(el=>el.classList.remove("show")); $(id).classList.add("show"); }
function toast(msg){ const t=$("toast"); t.textContent=msg; t.style.display="block"; setTimeout(()=>t.style.display="none",1600); }

/* ëª¨ë‹¬ ìœ í‹¸(í€´ì¦ˆ ë²„íŠ¼ ì œì–´ í¬í•¨) */
function openModal(title,body,{quizFor=null,quizTitle=""}={}){
  $("modal-title").textContent=title;
  $("modal-body").innerHTML=body;
  const qbtn=$("modal-quiz");
  if(quizFor){ qbtn.style.display="inline-block"; qbtn.onclick=()=>openQuiz(quizFor, quizTitle||title); }
  else { qbtn.style.display="none"; qbtn.onclick=null; }
  $("modal").classList.add("on");
}
$("modal-close").onclick = () => $("modal").classList.remove("on");

/* ================== ë„¤ë¹„ ================== */
$$("[data-page]").forEach(b => b.addEventListener("click", () => {
  show(b.dataset.page);
  if (b.dataset.page==="home") { loadHome(); renderLeaderboardHome(); }
  if (b.dataset.page==="stories") loadSeriesTabs();
  if (b.dataset.page==="next") loadNext();
  if (b.dataset.page==="groups") loadGroups();
  if (b.dataset.page==="leaderboard") renderLeaderboard();
  if (b.dataset.page==="profile") loadProfile();
  if (b.dataset.page==="admin" && isAdmin) renderAdmin();
}));

/* ================== HOME ================== */
async function loadHome(){
  const box=$("home-stories"); box.innerHTML="";
  const snap=await db.collection("stories").orderBy("created","desc").limit(6).get();
  if(snap.empty){
    box.innerHTML='<div class="mut">ì•„ì§ ì±…ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }
  snap.forEach(d=>{
    const s=d.data(); const sid=d.id;
    const el=document.createElement("div"); el.className="story";
    el.innerHTML = `<h4>${esc(s.title)}</h4>
      <p>${esc((s.text||"").slice(0,160))}${(s.text||"").length>160?"â€¦":""}</p>`;
    const openStory = () => openModal(
      s.title,
      `<div style="white-space:pre-wrap;line-height:1.65">${esc(s.text||"").replace(/\n/g,"<br>")}</div>`,
      {quizFor:sid, quizTitle:s.title}
    );
    el.addEventListener("click", openStory);
    box.appendChild(el);
  });
}

/* ================== STORIES ================== */
async function loadSeriesTabs(){
  $("series-tabs").innerHTML=""; $("series-desc").textContent="";
  const tabs=$("series-tabs");

  const all=document.createElement("button");
  all.className="tab"; all.textContent="ì „ì²´";
  all.onclick=()=>{ currentSeries="ALL"; highlightTabs(); $("series-desc").textContent="ëª¨ë“  ì‹œë¦¬ì¦ˆì˜ ì±…"; loadStories(); };
  tabs.appendChild(all);

  const snap=await db.collection("series").orderBy("created","desc").get();
  if(snap.empty){
    $("series-desc").textContent="ì‹œë¦¬ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤.";
  }else{
    snap.forEach(doc=>{
      const s=doc.data();
      const b=document.createElement("button");
      b.className="tab"; b.textContent=s.name; b.dataset.sid=doc.id;
      b.onclick=()=>{ currentSeries=doc.id; highlightTabs(); $("series-desc").textContent=s.desc||""; loadStories(); };
      tabs.appendChild(b);
    });
  }
  currentSeries="ALL"; highlightTabs(); $("series-desc").textContent="ëª¨ë“  ì‹œë¦¬ì¦ˆì˜ ì±…"; loadStories();
}
function highlightTabs(){
  $$(".tab").forEach(t=>{
    const active = (currentSeries==="ALL" && t.textContent==="ì „ì²´") || (t.dataset.sid===currentSeries);
    t.classList.toggle("active", active);
  });
}
async function loadStories(){
  const list=$("story-list"); list.innerHTML="";
  $("story-loading").style.display="block";

  let q = db.collection("stories").orderBy("created","desc");
  if(currentSeries && currentSeries!=="ALL") q = q.where("seriesId","==",currentSeries);

  const snap = await q.get();
  $("story-loading").style.display="none";

  if(snap.empty){
    list.innerHTML='<div class="mut">ì´ ì‹œë¦¬ì¦ˆì—ëŠ” ì±…ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  snap.forEach(doc=>{
    const s=doc.data(); const sid=doc.id;
    const el=document.createElement("div"); el.className="story";
    el.innerHTML = `
      <h4>${esc(s.title)}</h4>
      <p>${esc((s.text||"").slice(0,220)).replace(/\n/g,"<br>")}${(s.text||"").length>220?"â€¦":""}</p>
      <div class="actions">
        <button class="btn" data-read>ì½ê¸°</button>
        ${isAdmin?'<button class="btn" data-edit>ìˆ˜ì •</button><button class="btn" data-del>ì‚­ì œ</button>':""}
      </div>`;
    const openStory = () => openModal(
      s.title,
      `<div style="white-space:pre-wrap;line-height:1.65">${esc(s.text||"").replace(/\n/g,"<br>")}</div>`,
      {quizFor:sid, quizTitle:s.title}
    );
    el.addEventListener("click", openStory);
    el.querySelector("[data-read]").onclick = e => { e.stopPropagation(); openStory(); };
    if(isAdmin){
      el.querySelector("[data-edit]").onclick = e => { e.stopPropagation(); openEditStory(sid,s); };
      el.querySelector("[data-del]").onclick = async e => {
        e.stopPropagation();
        if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
        await db.collection("stories").doc(sid).delete();
        toast("ì‚­ì œë¨"); loadStories(); renderAdmin();
      };
    }
    list.appendChild(el);
  });
}

/* ================== NEXT (Proposals) ================== */
async function loadNext(){
  $("next-form").onsubmit = async (e)=>{
    e.preventDefault();
    const author=$("nx-author").value.trim();
    const title=$("nx-title").value.trim();
    const text=$("nx-text").value.trim();
    if(!author||!title||!text) return;
    await db.collection("nextProposals").add({
      author,title,text,status:"pending",created:new Date()
    });
    $("nx-title").value=""; $("nx-text").value="";
    toast("ì œì•ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
    renderNextList();
    if(isAdmin) renderAdminNext();
  };
  renderNextList();
}
async function renderNextList(){
  $("next-list").innerHTML="";
  $("next-loading").style.display="block";
  const snap=await db.collection("nextProposals").orderBy("created","desc").limit(50).get();
  $("next-loading").style.display="none";
  if(snap.empty){
    $("next-list").innerHTML='<div class="mut">ì•„ì§ ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }
  snap.forEach(doc=>{
    const p=doc.data();
    const el=document.createElement("div"); el.className="story";
    el.innerHTML=`
      <div class="badge">${p.status==="pending"?"ëŒ€ê¸°ì¤‘":p.status==="approved"?"ìŠ¹ì¸ë¨":"ê±°ì ˆë¨"}</div>
      <h4>${esc(p.title)}</h4>
      <p>${esc(p.text).replace(/\n/g,"<br>")}</p>
      <div class="mut">${esc(p.author||("ìµëª…"))} â€¢ ${formatDate(p.created)}</div>
      ${isAdmin?`<div class="actions">
        <button class="btn" data-approve>ìŠ¹ì¸</button>
        <button class="btn" data-reject>ê±°ì ˆ</button>
        <button class="btn" data-del>ì‚­ì œ</button>
      </div>`:""}
    `;
    const openProposal = () => openModal(p.title, `<div style="white-space:pre-wrap;line-height:1.65">${esc(p.text||"").replace(/\n/g,"<br>")}</div>`);
    el.addEventListener("click", openProposal);

    if(isAdmin){
      el.querySelector("[data-approve]").onclick=(e)=>{e.stopPropagation(); approveProposal(doc.id,p);};
      el.querySelector("[data-reject]").onclick=async(e)=>{
        e.stopPropagation();
        await db.collection("nextProposals").doc(doc.id).update({status:"rejected"});
        toast("ê±°ì ˆ ì²˜ë¦¬"); renderNextList(); renderAdminNext();
      };
      el.querySelector("[data-del]").onclick=async(e)=>{
        e.stopPropagation();
        if(!confirm("ì œì•ˆì„ ì‚­ì œí• ê¹Œìš”?")) return;
        await db.collection("nextProposals").doc(doc.id).delete();
        toast("ì‚­ì œë¨"); renderNextList(); renderAdminNext();
      };
    }
    $("next-list").appendChild(el);
  });
}
async function approveProposal(id,p){
  const sSnap=await db.collection("series").orderBy("created","desc").get();
  if(sSnap.empty) return alert("ë¨¼ì € ì‹œë¦¬ì¦ˆë¥¼ í•˜ë‚˜ ë§Œë“¤ì–´ì£¼ì„¸ìš”.");
  const opts=['<option value="">ì‹œë¦¬ì¦ˆ ì„ íƒ</option>'];
  sSnap.forEach(d=>opts.push(`<option value="${d.id}">${esc(d.data().name)}</option>`));
  openModal("ì œì•ˆ ìŠ¹ì¸ â†’ ì±…ìœ¼ë¡œ ë“±ë¡", `
    <form id="apprForm" class="grid">
      <select id="ap-series" required>${opts.join("")}</select>
      <input id="ap-title" value="${esc(p.title)}" required>
      <textarea id="ap-text" rows="6">${esc(p.text||"")}</textarea>
      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button class="btn" type="button" id="ap-cancel">ì·¨ì†Œ</button>
        <button class="btn pri" type="submit">ì±…ìœ¼ë¡œ ë“±ë¡</button>
      </div>
    </form>
  `);
  $("ap-cancel").onclick=()=>$("modal").classList.remove("on");
  $("apprForm").onsubmit=async e=>{
    e.preventDefault();
    const seriesId=$("ap-series").value; const title=$("ap-title").value.trim(); const text=$("ap-text").value;
    if(!seriesId||!title) return;
    await db.collection("stories").add({seriesId,title,text,created:new Date()});
    await db.collection("nextProposals").doc(id).update({status:"approved"});
    toast("ìŠ¹ì¸ & ì±…ìœ¼ë¡œ ë“±ë¡ë¨");
    $("modal").classList.remove("on");
    loadStories(); renderNextList(); if(isAdmin) renderAdmin(); if(isAdmin) renderAdminNext();
  };
}

/* ================== GROUPS (ëª©ë¡ & ìƒì„¸ + ê²Œì‹œíŒ) ================== */
async function loadGroups(){
  const list=$("group-list"); list.innerHTML="";
  $("group-box").style.display="none";
  const snap=await db.collection("groups").orderBy("created","desc").get();
  if(snap.empty){
    list.innerHTML='<div class="mut">ì•„ì§ ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤ã€‚</div>';
    return;
  }
  snap.forEach(doc=>{
    const g=doc.data();
    const el=document.createElement("div"); el.className="story";
    el.innerHTML = `
      <h4>${esc(g.name)}</h4>
      <p>${esc(g.desc||"")}</p>
      <div class="actions">
        <button class="btn pri" data-open>ë“¤ì–´ê°€ê¸°</button>
        ${isAdmin?'<button class="btn" data-edit>ìˆ˜ì •</button><button class="btn" data-del>ì‚­ì œ</button>':""}
      </div>`;
    el.querySelector("[data-open]").onclick=(e)=>{e.stopPropagation(); openGroup(doc.id,g);};
    if(isAdmin){
      el.querySelector("[data-edit]").onclick=(e)=>{e.stopPropagation(); openEditGroup(doc.id,g);};
      el.querySelector("[data-del]").onclick=async(e)=>{
        e.stopPropagation();
        if(!confirm("ê·¸ë£¹ì„ ì‚­ì œí• ê¹Œìš”?")) return;
        await db.collection("groups").doc(doc.id).delete();
        toast("ì‚­ì œë¨"); loadGroups(); renderAdmin();
      };
    }
    list.appendChild(el);
  });
}
async function openGroup(id,g){
  currentGroup={id,...g};
  $("group-box").style.display="block";
  $("group-title").textContent = g.name;
  $("group-desc").textContent = g.desc || "";
  $("group-admin-actions").style.display = isAdmin ? "flex" : "none";
  $("btnEditGroup").onclick = ()=>openEditGroup(id,g);
  $("btnDeleteGroup").onclick = async ()=>{
    if(!confirm("ê·¸ë£¹ì„ ì‚­ì œí• ê¹Œìš”?")) return;
    await db.collection("groups").doc(id).delete();
    toast("ì‚­ì œë¨"); $("group-box").style.display="none"; loadGroups(); renderAdmin();
  };

  const form=$("group-post-form");
  form.onsubmit = async (e)=>{
    e.preventDefault();
    const author=$("gp-author").value.trim();
    const title=$("gp-title").value.trim();
    const text=$("gp-text").value.trim();
    if(!author||!title||!text) return;
    await db.collection("groupPosts").add({groupId:id, author, title, text, pinned:false, created:new Date()});
    $("gp-text").value=""; $("gp-title").value="";
    toast("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
    loadGroupPosts(id);
  };

  loadGroupPosts(id);
}
async function loadGroupPosts(groupId){
  $("group-posts").innerHTML="";
  $("group-posts-loading").style.display="block";

  const snap=await db.collection("groupPosts")
    .where("groupId","==",groupId)
    .orderBy("created","desc")
    .limit(50)
    .get();

  $("group-posts-loading").style.display="none";
  if(snap.empty){
    $("group-posts").innerHTML='<div class="mut">ì•„ì§ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  const posts=[];
  snap.forEach(d=>posts.push({id:d.id,...d.data()}));
  posts.sort((a,b)=>((b.pinned?1:0)-(a.pinned?1:0)) || (getMs(b.created)-getMs(a.created)));

  posts.forEach(p=>{
    const el=document.createElement("div"); el.className="story";
    el.innerHTML=`
      <div class="badge">${p.pinned?'ğŸ“Œ ê³ ì •':''}</div>
      <h4>${esc(p.title)}</h4>
      <p>${esc(p.text).replace(/\n/g,"<br>")}</p>
      <div class="mut">${esc(p.author||"ìµëª…")} â€¢ ${formatDate(p.created)}</div>
      <div class="actions">
        ${isAdmin?`
          <button class="btn" data-pin>${p.pinned?'ê³ ì • í•´ì œ':'ê³ ì •'}</button>
          <button class="btn" data-edit>ìˆ˜ì •</button>
          <button class="btn" data-del>ì‚­ì œ</button>
        `:''}
      </div>
    `;
    el.addEventListener("click", ()=>openModal(p.title, `<div style="white-space:pre-wrap;line-height:1.65">${esc(p.text||"").replace(/\n/g,"<br>")}</div>`));
    if(isAdmin){
      el.querySelector("[data-pin]").onclick=async(e)=>{
        e.stopPropagation();
        await db.collection("groupPosts").doc(p.id).update({pinned:!p.pinned});
        loadGroupPosts(groupId);
      };
      el.querySelector("[data-edit]").onclick=(e)=>{e.stopPropagation(); openEditPost(p.id,p);};
      el.querySelector("[data-del]").onclick=async(e)=>{
        e.stopPropagation();
        if(!confirm("ê²Œì‹œê¸€ì„ ì‚­ì œí• ê¹Œìš”?")) return;
        await db.collection("groupPosts").doc(p.id).delete();
        toast("ì‚­ì œë¨"); loadGroupPosts(groupId);
      };
    }
    $("group-posts").appendChild(el);
  });
}
function getMs(ts){
  try{
    if(typeof ts?.toDate==="function") return ts.toDate().getTime();
    const d=new Date(ts); if(!isNaN(d)) return d.getTime();
  }catch(e){}
  return 0;
}
function formatDate(ts){ const ms=getMs(ts); return ms?new Date(ms).toLocaleString():""; }

/* ================== ADMIN ================== */
$("btnAdminLogin").onclick=()=>{
  if($("admin-pass").value===ADMIN_PASSWORD){
    isAdmin=true;
    $("admin-login").style.display="none";
    $("admin-panel").style.display="block";
    toast("ê´€ë¦¬ì ë¡œê·¸ì¸ ì™„ë£Œ");
    renderAdmin();
  }else alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
};
function renderAdmin(){
  loadAdminSeries(); loadAdminStories(); loadAdminGroups(); renderAdminNext();
}

/* ---- ì‹œë¦¬ì¦ˆ CRUD ---- */
$("openSeries").onclick=()=>{
  openModal("ì‹œë¦¬ì¦ˆ ì¶”ê°€", `
    <form id="formSeries" class="grid">
      <input id="se-name" placeholder="ì‹œë¦¬ì¦ˆ ì´ë¦„" required>
      <input id="se-desc" placeholder="ì„¤ëª… (ì„ íƒ)">
      <div style="display:flex;justify-content:flex-end"><button class="btn pri" type="submit">ì¶”ê°€</button></div>
    </form>
  `);
  $("formSeries").onsubmit=async e=>{
    e.preventDefault();
    const name=$("se-name").value.trim(), desc=$("se-desc").value.trim();
    if(!name) return;
    await db.collection("series").add({name,desc,created:new Date()});
    toast("ì‹œë¦¬ì¦ˆ ì¶”ê°€ë¨"); $("modal").classList.remove("on"); loadSeriesTabs(); renderAdmin();
  };
};
async function loadAdminSeries(){
  const box=$("admin-series"); box.innerHTML="";
  const snap=await db.collection("series").orderBy("created","desc").get();
  if(snap.empty){
    box.innerHTML='<div class="mut">ì‹œë¦¬ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }
  snap.forEach(doc=>{
    const s=doc.data();
    const el=document.createElement("div"); el.className="story";
    el.innerHTML = `<h4>${esc(s.name)}</h4><p>${esc(s.desc||"")}</p>
      <div class="actions">
        <button class="btn" data-edit>ìˆ˜ì •</button>
        <button class="btn" data-del>ì‚­ì œ</button>
      </div>`;
    el.addEventListener("click", ()=>openModal(s.name, `<div class="mut">${esc(s.desc||"ì„¤ëª… ì—†ìŒ")}</div>`));
    el.querySelector("[data-edit]").onclick=(e)=>{e.stopPropagation(); openEditSeries(doc.id,s);};
    el.querySelector("[data-del]").onclick=async(e)=>{
      e.stopPropagation();
      if(!confirm("ì‹œë¦¬ì¦ˆ ì‚­ì œ? (ì±…ì€ ë‚¨ìŠµë‹ˆë‹¤)")) return;
      await db.collection("series").doc(doc.id).delete();
      toast("ì‚­ì œë¨"); loadSeriesTabs(); renderAdmin();
    };
    box.appendChild(el);
  });
}
function openEditSeries(id,s){
  openModal("ì‹œë¦¬ì¦ˆ ìˆ˜ì •", `
    <form id="formSeriesEdit" class="grid">
      <input id="se-name-e" value="${esc(s.name)}" required>
      <input id="se-desc-e" value="${esc(s.desc||"")}">
      <div style="display:flex;justify-content:flex-end"><button class="btn pri" type="submit">ì €ì¥</button></div>
    </form>
  `);
  $("formSeriesEdit").onsubmit=async e=>{
    e.preventDefault();
    const name=$("se-name-e").value.trim(); const desc=$("se-desc-e").value.trim();
    if(!name) return;
    await db.collection("series").doc(id).update({name,desc});
    toast("ìˆ˜ì •ë¨"); $("modal").classList.remove("on"); loadSeriesTabs(); renderAdmin();
  };
}

/* ---- ì±… CRUD ---- */
$("openStory").onclick=async()=>{
  const snap=await db.collection("series").orderBy("created","desc").get();
  if(snap.empty) return alert("ì‹œë¦¬ì¦ˆë¥¼ ë¨¼ì € ë§Œë“¤ì–´ì£¼ì„¸ìš”.");
  const opts = ['<option value="">(ì‹œë¦¬ì¦ˆ ì„ íƒ)</option>'];
  snap.forEach(d=>opts.push(`<option value="${d.id}">${esc(d.data().name)}</option>`));
  openModal("ì±… ì¶”ê°€", `
    <form id="formStory" class="grid">
      <select id="st-series" required>${opts.join("")}</select>
      <input id="st-title" placeholder="ì±… ì œëª©" required>
      <textarea id="st-text" rows="6" placeholder="ë³¸ë¬¸ (ì„ íƒ)"></textarea>
      <div style="display:flex;justify-content:flex-end"><button class="btn pri" type="submit">ì¶”ê°€</button></div>
    </form>
  `);
  $("formStory").onsubmit=async e=>{
    e.preventDefault();
    const seriesId=$("st-series").value; const title=$("st-title").value.trim(); const text=$("st-text").value;
    if(!seriesId || !title) return;
    await db.collection("stories").add({seriesId,title,text,created:new Date()});
    toast("ì±… ì¶”ê°€ë¨"); $("modal").classList.remove("on"); loadStories(); renderAdmin();
  };
};
async function loadAdminStories(){
  const box=$("admin-stories"); box.innerHTML="";
  const map=await getSeriesMap();
  const snap=await db.collection("stories").orderBy("created","desc").get();
  if(snap.empty){
    box.innerHTML='<div class="mut">ì±…ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }
  snap.forEach(doc=>{
    const s=doc.data(); const sid=doc.id;
    const el=document.createElement("div"); el.className="story";
    el.innerHTML = `<div class="mut">${esc(map[s.seriesId]||"ì‹œë¦¬ì¦ˆ ë¯¸ì§€ì •")}</div>
      <h4>${esc(s.title)}</h4>
      <div class="actions">
        <button class="btn" data-edit>ìˆ˜ì •</button>
        <button class="btn" data-del>ì‚­ì œ</button>
      </div>`;
    el.addEventListener("click", ()=>openModal(
      s.title,
      `<div style="white-space:pre-wrap;line-height:1.65">${esc(s.text||"").replace(/\n/g,"<br>")}</div>`,
      {quizFor:sid, quizTitle:s.title}
    ));
    el.querySelector("[data-edit]").onclick=(e)=>{e.stopPropagation(); openEditStory(sid,s);};
    el.querySelector("[data-del]").onclick=async(e)=>{
      e.stopPropagation();
      if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
      await db.collection("stories").doc(sid).delete();
      toast("ì‚­ì œë¨"); loadStories(); renderAdmin();
    };
    box.appendChild(el);
  });
}
function openEditStory(id,s){
  openModal("ì±… ìˆ˜ì •", `
    <form id="formStoryEdit" class="grid">
      <input id="ed-title" value="${esc(s.title||"")}" required>
      <textarea id="ed-text" rows="6">${esc(s.text||"")}</textarea>
      <div style="display:flex;justify-content:flex-end"><button class="btn pri" type="submit">ì €ì¥</button></div>
    </form>
  `);
  $("formStoryEdit").onsubmit=async e=>{
    e.preventDefault();
    const title=$("ed-title").value.trim(); const text=$("ed-text").value;
    if(!title) return;
    await db.collection("stories").doc(id).update({title,text});
    toast("ìˆ˜ì •ë¨"); $("modal").classList.remove("on"); loadStories(); renderAdmin();
  };
}

/* ---- ê·¸ë£¹ CRUD ---- */
$("openGroup").onclick=()=>{
  openModal("ê·¸ë£¹ ì¶”ê°€", `
    <form id="formGroup" class="grid">
      <input id="gp-name" placeholder="ê·¸ë£¹ ì´ë¦„" required>
      <input id="gp-desc" placeholder="ì„¤ëª… (ì„ íƒ)">
      <div style="display:flex;justify-content:flex-end"><button class="btn pri" type="submit">ì¶”ê°€</button></div>
    </form>
  `);
  $("formGroup").onsubmit=async e=>{
    e.preventDefault();
    const name=$("gp-name").value.trim(); const desc=$("gp-desc").value.trim();
    if(!name) return;
    await db.collection("groups").add({name,desc,created:new Date()});
    toast("ê·¸ë£¹ ì¶”ê°€ë¨"); $("modal").classList.remove("on"); loadGroups(); renderAdmin();
  };
};
async function loadAdminGroups(){
  const box=$("admin-groups"); box.innerHTML="";
  const snap=await db.collection("groups").orderBy("created","desc").get();
  if(snap.empty){
    box.innerHTML='<div class="mut">ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }
  snap.forEach(doc=>{
    const g=doc.data();
    const el=document.createElement("div"); el.className="story";
    el.innerHTML = `<h4>${esc(g.name)}</h4><p>${esc(g.desc||"")}</p>
      <div class="actions">
        <button class="btn" data-edit>ìˆ˜ì •</button>
        <button class="btn" data-del>ì‚­ì œ</button>
      </div>`;
    el.addEventListener("click", ()=>openModal(g.name, `<div class="mut">${esc(g.desc||"ì„¤ëª… ì—†ìŒ")}</div>`));
    el.querySelector("[data-edit]").onclick=(e)=>{e.stopPropagation(); openEditGroup(doc.id,g);};
    el.querySelector("[data-del]").onclick=async(e)=>{
      e.stopPropagation();
      if(!confirm("ê·¸ë£¹ ì‚­ì œ?")) return;
      await db.collection("groups").doc(doc.id).delete();
      toast("ì‚­ì œë¨"); loadGroups(); renderAdmin();
    };
    box.appendChild(el);
  });
}
function openEditGroup(id,g){
  openModal("ê·¸ë£¹ ìˆ˜ì •", `
    <form id="formGroupEdit" class="grid">
      <input id="gp-name-e" value="${esc(g.name||"")}" required>
      <input id="gp-desc-e" value="${esc(g.desc||"")}">
      <div style="display:flex;justify-content:flex-end"><button class="btn pri" type="submit">ì €ì¥</button></div>
    </form>
  `);
  $("formGroupEdit").onsubmit=async e=>{
    e.preventDefault();
    const name=$("gp-name-e").value.trim(); const desc=$("gp-desc-e").value.trim();
    if(!name) return;
    await db.collection("groups").doc(id).update({name,desc});
    toast("ìˆ˜ì •ë¨"); $("modal").classList.remove("on"); loadGroups(); renderAdmin();
  };
}

/* ---- ê²Œì‹œê¸€ ìˆ˜ì • ëª¨ë‹¬ ---- */
function openEditPost(id,p){
  openModal("ê²Œì‹œê¸€ ìˆ˜ì •", `
    <form id="formPostEdit" class="grid">
      <input id="pe-title" value="${esc(p.title||"")}" required>
      <textarea id="pe-text" rows="6">${esc(p.text||"")}</textarea>
      <label style="display:flex;gap:8px;align-items:center">
        <input id="pe-pin" type="checkbox" ${p.pinned?'checked':''} style="width:auto">
        <span>ìƒë‹¨ ê³ ì •</span>
      </label>
      <div style="display:flex;justify-content:flex-end"><button class="btn pri" type="submit">ì €ì¥</button></div>
    </form>
  `);
  $("formPostEdit").onsubmit=async e=>{
    e.preventDefault();
    const title=$("pe-title").value.trim(); const text=$("pe-text").value; const pinned=$("pe-pin").checked;
    if(!title) return;
    await db.collection("groupPosts").doc(id).update({title,text,pinned});
    toast("ìˆ˜ì •ë¨"); $("modal").classList.remove("on"); loadGroupPosts(currentGroup.id);
  };
}

/* ---- Admin: ì œì•ˆ ê´€ë¦¬ ---- */
async function renderAdminNext(){
  const box=$("admin-next"); if(!box) return; box.innerHTML="";
  const snap=await db.collection("nextProposals").orderBy("created","desc").limit(50).get();
  if(snap.empty){ box.innerHTML='<div class="mut">ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  const seriesSnap=await db.collection("series").get();
  const sOpts=['<option value="">ì‹œë¦¬ì¦ˆ ì„ íƒ</option>'];
  seriesSnap.forEach(d=>sOpts.push(`<option value="${d.id}">${esc(d.data().name)}</option>`));
  snap.forEach(doc=>{
    const p=doc.data();
    const row=document.createElement("div"); row.className="story";
    row.innerHTML=`
      <div class="badge">${esc(p.status)}</div>
      <h4>${esc(p.title)}</h4>
      <p>${esc((p.text||"").slice(0,200))}${(p.text||"").length>200?'â€¦':''}</p>
      <div class="mut">${esc(p.author||"ìµëª…")} â€¢ ${formatDate(p.created)}</div>
      <div class="actions">
        <select class="ad-series">${sOpts.join("")}</select>
        <button class="btn" data-approve>ìŠ¹ì¸â†’ì±… ë“±ë¡</button>
        <button class="btn" data-reject>ê±°ì ˆ</button>
        <button class="btn" data-del>ì‚­ì œ</button>
      </div>
    `;
    row.addEventListener("click", ()=>openModal(p.title, `<div style="white-space:pre-wrap;line-height:1.65">${esc(p.text||"").replace(/\n/g,"<br>")}</div>`));
    const sel=row.querySelector(".ad-series");
    row.querySelector("[data-approve]").onclick=async(e)=>{
      e.stopPropagation();
      const sid=sel.value; if(!sid) return alert("ì‹œë¦¬ì¦ˆë¥¼ ì„ íƒí•˜ì„¸ìš”.");
      await db.collection("stories").add({seriesId:sid,title:p.title,text:p.text,created:new Date()});
      await db.collection("nextProposals").doc(doc.id).update({status:"approved"});
      toast("ìŠ¹ì¸ë¨"); renderAdminNext(); loadStories();
    };
    row.querySelector("[data-reject]").onclick=async(e)=>{
      e.stopPropagation();
      await db.collection("nextProposals").doc(doc.id).update({status:"rejected"});
      toast("ê±°ì ˆë¨"); renderAdminNext(); renderNextList();
    };
    row.querySelector("[data-del]").onclick=async(e)=>{
      e.stopPropagation();
      if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
      await db.collection("nextProposals").doc(doc.id).delete();
      toast("ì‚­ì œë¨"); renderAdminNext(); renderNextList();
    };
    box.appendChild(row);
  });
}

/* ================== QUIZ + POINTS + LEADERBOARD + PROFILE ================== */
async function openQuiz(storyId, storyTitle){
  const qsnap = await db.collection("quizzes").where("storyId","==",storyId).get();
  if(qsnap.empty) return openModal("í€´ì¦ˆ ì—†ìŒ", "<p>ì´ ì±…ì˜ í€´ì¦ˆê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>");
  const questions = []; qsnap.forEach(d=>questions.push(d.data()));

  let user = localStorage.getItem("username");
  if(!user){
    user = prompt("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš” (í¬ì¸íŠ¸ ê¸°ë¡ìš©)");
    if(!user) return;
    localStorage.setItem("username", user);
  }

  let html = `<h3>${esc(storyTitle)} í€´ì¦ˆ</h3>`;
  questions.forEach((q,i)=>{
    html += `<div><p><b>Q${i+1}. ${esc(q.question)}</b></p>`;
    (q.options||[]).forEach((opt,j)=>{
      html += `<label><input type="radio" name="q${i}" value="${j}"> ${esc(opt)}</label><br>`;
    });
    html += "</div><hr>";
  });
  html += `<button class="btn pri" id="submitQuiz">ì œì¶œí•˜ê¸°</button>`;
  openModal("í€´ì¦ˆ", html);

  $("submitQuiz").onclick = async ()=>{
    let score=0;
    questions.forEach((q,i)=>{
      const sel=document.querySelector(`input[name='q${i}']:checked`);
      if(sel && Number(sel.value)===q.answerIndex) score+=10;
    });
    await updateUserPoints(user, storyId, score);
    openModal("ê²°ê³¼", `<p>${esc(user)}ë‹˜ ${score}ì  íšë“!</p><p>ğŸ‰ ì´ í¬ì¸íŠ¸ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.</p>`);
    renderLeaderboard(); renderLeaderboardHome(); loadProfile();
  };
}
async function updateUserPoints(user, storyId, pts){
  const snap=await db.collection("points").where("user","==",user).limit(1).get();
  if(snap.empty){
    await db.collection("points").add({user, points:pts, quizzesTaken:[storyId]});
  } else {
    const doc=snap.docs[0], data=doc.data();
    if((data.quizzesTaken||[]).includes(storyId)) { toast("ì´ë¯¸ ì´ ì±… í€´ì¦ˆë¥¼ í’€ì—ˆìŠµë‹ˆë‹¤!"); return; }
    await db.collection("points").doc(doc.id).update({
      points:(data.points||0)+pts,
      quizzesTaken:[...(data.quizzesTaken||[]), storyId]
    });
  }
}

/* Top10 ë¦¬ë”ë³´ë“œ (í˜ì´ì§€) */
async function renderLeaderboard(){
  const box=$("leaderboard-list"); if(!box) return;
  box.innerHTML="";
  const snap=await db.collection("points").orderBy("points","desc").limit(10).get();
  if(snap.empty){ box.innerHTML="<div class='mut'>ì•„ì§ ì ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>"; return; }
  let rank=1;
  snap.forEach(d=>{
    const p=d.data();
    const el=document.createElement("div"); el.className="story";
    el.innerHTML = `<h4>#${rank++} ${esc(p.user)}</h4><p>${p.points}ì </p>`;
    box.appendChild(el);
  });
}
/* í™ˆ ë¦¬ë”ë³´ë“œ ë°•ìŠ¤ */
async function renderLeaderboardHome(){
  const box=$("leaderboard-home"); if(!box) return;
  box.innerHTML="";
  const snap=await db.collection("points").orderBy("points","desc").limit(10).get();
  if(snap.empty){ box.innerHTML="<div class='mut'>ì•„ì§ ì ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>"; return; }
  let rank=1;
  snap.forEach(d=>{
    const p=d.data();
    const el=document.createElement("div"); el.className="story";
    el.innerHTML = `<h4>#${rank++} ${esc(p.user)}</h4><p>${p.points}ì </p>`;
    box.appendChild(el);
  });
}

/* í”„ë¡œí•„ */
$("btnSaveName").onclick = ()=>{
  const name=$("prof-name").value.trim();
  if(!name) return toast("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.");
  localStorage.setItem("username", name);
  toast("ë‹‰ë„¤ì„ ì €ì¥ë¨");
  loadProfile();
};
async function loadProfile(){
  const box=$("profile-box"); if(!box) return;
  const user=localStorage.getItem("username");
  if(user) $("prof-name").value=user;
  if(!user){ box.innerHTML="<p>ë‹‰ë„¤ì„ì„ ì €ì¥í•˜ê³  í€´ì¦ˆë¥¼ í’€ë©´ ë‚´ í¬ì¸íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>"; return; }
  const snap=await db.collection("points").where("user","==",user).limit(1).get();
  if(snap.empty){
    box.innerHTML=`<p><b>${esc(user)}</b> ë‹˜, ì•„ì§ í¬ì¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
    return;
  }
  const data=snap.docs[0].data();
  box.innerHTML = `
    <p><b>ë‹‰ë„¤ì„:</b> ${esc(user)}</p>
    <p><b>ì´ í¬ì¸íŠ¸:</b> ${data.points||0}</p>
    <p><b>ì°¸ì—¬í•œ í€´ì¦ˆ ìˆ˜:</b> ${(data.quizzesTaken||[]).length}</p>
  `;
}

/* ================== Helpers ================== */
async function getSeriesMap(){
  const map={}; const s=await db.collection("series").get(); s.forEach(d=>map[d.id]=d.data().name); return map;
}

/* ================== Init ================== */
window.addEventListener("load",()=>{
  show("home");
  loadHome();
  loadSeriesTabs();
  loadNext();
  loadGroups();
  renderLeaderboardHome();
  // í”„ë¡œí•„ ê¸°ë³¸ ë¡œë“œ(ë‹‰ë„¤ì„ ìˆìœ¼ë©´ í‘œì‹œ)
  loadProfile();
});
</script>
</body>
</html>
